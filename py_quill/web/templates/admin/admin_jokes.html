{% extends "admin/admin_base.html" %}
{% from "components/infinite_scroll_feed.html" import infinite_scroll_feed %}

{% block title %}Jokes Â· {{ site_name }} Admin{% endblock %}

{% block head_extra %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/joke_admin_modals.css') }}">
<style>
  .admin-jokes-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
    margin-bottom: 16px;
  }

  .admin-jokes-actions {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  .admin-inflight-count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 34px;
    height: 34px;
    padding: 0 10px;
    border-radius: 999px;
    font-weight: var(--font-weight-button);
    border: 1px solid var(--color-border);
    background: var(--color-accent-surface);
    color: var(--color-text-muted);
    transition: transform 120ms ease, box-shadow 120ms ease, background-color 120ms ease, color 120ms ease;
  }

  .admin-inflight-count--active {
    background: var(--color-primary);
    color: var(--color-text);
    border-color: rgba(0, 0, 0, 0.08);
    box-shadow: 0 8px 20px rgba(196, 171, 140, 0.35);
    transform: translateY(-1px);
  }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/joke_admin_actions.js') }}"></script>
<script>
  (function () {
    const jokeCreationUrl = {{ joke_creation_url | tojson if joke_creation_url else '"/joke_creation_process"' }};
    if (window.initJokeAdminActions) {
      window.initJokeAdminActions({
        jokeCreationUrl,
      });
    }

    const newButton = document.getElementById('admin-new-joke-button');
    const inflightBadge = document.getElementById('admin-new-joke-inflight');
    const modal = document.getElementById('admin-new-joke-modal');
    const modalBackdrop = document.querySelector('[data-admin-new-joke-backdrop]');
    const form = document.getElementById('admin-new-joke-form');
    const cancelButton = document.getElementById('admin-new-joke-cancel-button');
    const setupInput = document.getElementById('admin-new-joke-setup');
    const punchlineInput = document.getElementById('admin-new-joke-punchline');

    let inFlightCount = 0;

    function updateInFlightBadge() {
      if (!inflightBadge) {
        return;
      }
      inflightBadge.textContent = String(inFlightCount);
      inflightBadge.classList.toggle('admin-inflight-count--active', inFlightCount > 0);
    }

    function openModal() {
      if (!modal) {
        return;
      }
      modal.classList.add('admin-modal--open');
      modal.setAttribute('aria-hidden', 'false');
      if (setupInput) {
        setupInput.focus();
      }
    }

    function closeModal() {
      if (!modal) {
        return;
      }
      modal.classList.remove('admin-modal--open');
      modal.setAttribute('aria-hidden', 'true');
    }

    function clearForm() {
      if (setupInput) {
        setupInput.value = '';
      }
      if (punchlineInput) {
        punchlineInput.value = '';
      }
    }

    if (newButton) {
      newButton.addEventListener('click', () => {
        openModal();
      });
    }

    if (cancelButton) {
      cancelButton.addEventListener('click', () => {
        closeModal();
      });
    }

    if (modalBackdrop) {
      modalBackdrop.addEventListener('click', () => {
        closeModal();
      });
    }

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeModal();
      }
    });

    if (form) {
      form.addEventListener('submit', (event) => {
        event.preventDefault();

        if (!setupInput || !punchlineInput) {
          return;
        }

        if (!setupInput.checkValidity() || !punchlineInput.checkValidity()) {
          if (typeof form.reportValidity === 'function') {
            form.reportValidity();
          }
          return;
        }

        const setupText = setupInput.value.trim();
        const punchlineText = punchlineInput.value.trim();
        if (!setupText || !punchlineText) {
          if (typeof form.reportValidity === 'function') {
            form.reportValidity();
          }
          return;
        }

        inFlightCount += 1;
        updateInFlightBadge();

        const payload = {
          data: {
            setup_text: setupText,
            punchline_text: punchlineText,
            regenerate_scene_ideas: true,
            generate_descriptions: true,
            populate_images: true,
            admin_owned: true,
          },
        };

        // Fire-and-forget: clear immediately after sending.
        try {
          fetch(jokeCreationUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
            },
            credentials: 'same-origin',
            body: JSON.stringify(payload),
          })
            .catch((err) => {
              // Keep lightweight logging; admin is usually watching emulator logs anyway.
              console.warn('joke_creation_process request failed', err); // eslint-disable-line no-console
            })
            .finally(() => {
              inFlightCount = Math.max(0, inFlightCount - 1);
              updateInFlightBadge();
            });
        } catch (err) {
          inFlightCount = Math.max(0, inFlightCount - 1);
          updateInFlightBadge();
        }

        clearForm();
        setupInput.focus();
      });
    }

    updateInFlightBadge();

    const chips = Array.from(document.querySelectorAll('.filter-chip[data-state]'));
    const categoryChips = Array.from(document.querySelectorAll('.filter-chip[data-category]'));
    if (!chips.length && !categoryChips.length) {
      return;
    }

    function selectedStates() {
      return chips
        .filter((c) => c.classList.contains('filter-chip--selected'))
        .map((c) => c.getAttribute('data-state'))
        .filter(Boolean);
    }

    function selectedCategoryId() {
      const selected = categoryChips.find((c) => c.classList.contains('filter-chip--selected'));
      if (!selected) {
        return null;
      }
      const value = selected.getAttribute('data-category');
      if (!value) {
        return null;
      }
      return value;
    }

    function setSelected(chip, isSelected) {
      chip.classList.toggle('filter-chip--selected', isSelected);
      chip.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
    }

    function navigateWithFilters(states, categoryId) {
      const url = new URL(window.location.href);
      url.pathname = '/admin/jokes';
      url.searchParams.set('states', states.join(','));
      if (categoryId) {
        url.searchParams.set('category', categoryId);
      } else {
        url.searchParams.delete('category');
      }
      url.searchParams.delete('cursor');
      window.location.assign(url.toString());
    }

    chips.forEach((chip) => {
      chip.addEventListener('click', () => {
        const current = selectedStates();
        const currentCategoryId = selectedCategoryId();
        const state = chip.getAttribute('data-state');
        if (!state) {
          return;
        }
        const isSelected = chip.classList.contains('filter-chip--selected');
        if (isSelected) {
          const next = current.filter((s) => s !== state);
          if (!next.length) {
            // Keep at least one filter selected.
            return;
          }
          setSelected(chip, false);
          navigateWithFilters(next, currentCategoryId);
          return;
        }

        setSelected(chip, true);
        navigateWithFilters([...current, state], currentCategoryId);
      });
    });

    categoryChips.forEach((chip) => {
      chip.addEventListener('click', () => {
        const currentStates = selectedStates();
        const categoryId = chip.getAttribute('data-category') || '';
        const isSelected = chip.classList.contains('filter-chip--selected');
        if (isSelected) {
          return;
        }

        categoryChips.forEach((c) => setSelected(c, c === chip));
        navigateWithFilters(currentStates, categoryId || null);
      });
    });
  })();
</script>
{% endblock %}

{% block content %}
<div class="admin-jokes">
  <header class="admin-jokes-header">
    <div>
      <h2 style="margin: 0;">Jokes</h2>
      <p class="muted" style="margin: 6px 0 0;">Filter by state. Newest first.</p>
    </div>
    <div class="admin-jokes-actions">
      <button type="button" class="button-primary text-button" id="admin-new-joke-button">
        New Joke
      </button>
      <span id="admin-new-joke-inflight" class="admin-inflight-count admin-inflight-count--idle"
        aria-label="In-flight joke creations" aria-live="polite">0</span>
    </div>
  </header>

  <div id="admin-new-joke-modal" class="admin-modal" aria-hidden="true">
    <div class="admin-modal__backdrop" data-admin-new-joke-backdrop></div>
    <div class="admin-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="admin-new-joke-title">
      <h3 id="admin-new-joke-title" class="admin-modal__title text-section-heading">New joke</h3>
      <div class="admin-modal__content">
        <form id="admin-new-joke-form">
          <div class="admin-modal__field">
            <label class="admin-modal__label" for="admin-new-joke-setup">Setup</label>
            <input class="admin-modal__input" id="admin-new-joke-setup" name="setup" type="text" required>
          </div>
          <div class="admin-modal__field">
            <label class="admin-modal__label" for="admin-new-joke-punchline">Punchline</label>
            <input class="admin-modal__input" id="admin-new-joke-punchline" name="punchline" type="text" required>
          </div>
          <div class="admin-modal__actions">
            <button type="submit" class="button-primary text-button" id="admin-new-joke-submit-button">Submit</button>
            <button type="button" class="button-secondary text-button" id="admin-new-joke-cancel-button">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  {% include "components/joke_admin_modals.html" %}

  <section class="filter-chips" aria-label="Joke category filters">
    {% set all_selected = selected_category_id is none %}
    <button type="button" class="filter-chip text-button{% if all_selected %} filter-chip--selected{% endif %}"
      data-category="" aria-pressed="{{ 'true' if all_selected else 'false' }}">
      All
    </button>
    {% for category in categories %}
    {% set category_id = category.id %}
    {% set is_selected = category_id and (category_id == selected_category_id) %}
    <button type="button" class="filter-chip text-button{% if is_selected %} filter-chip--selected{% endif %}"
      data-category="{{ category_id }}" aria-pressed="{{ 'true' if is_selected else 'false' }}">
      {{ category.display_name }} ({{ category.public_joke_count or 0 }})
    </button>
    {% endfor %}
  </section>

  <section class="filter-chips" aria-label="Joke state filters">
    {% for state in all_states %}
    {% set is_selected = state in selected_states %}
    <button type="button" class="filter-chip text-button{% if is_selected %} filter-chip--selected{% endif %}"
      data-state="{{ state }}" aria-pressed="{{ 'true' if is_selected else 'false' }}">
      {{ state }}
    </button>
    {% endfor %}
  </section>

  {{ infinite_scroll_feed(
  slug='admin-jokes',
  initial_jokes=jokes,
  initial_cursor=next_cursor,
  initial_has_more=has_more,
  width=image_size,
  feed_id='admin-jokes-feed',
  end_of_feed_message="No more jokes match these filters.",
  extra_query_params={'states': selected_states_param, 'category': selected_category_id},
  admin_state_badge_enabled=true,
  admin_stats_enabled=true,
  admin_edit_enabled=true,
  grid_enabled=true,
  ) }}
</div>


{% endblock %}
