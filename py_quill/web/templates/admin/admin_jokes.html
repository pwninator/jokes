{% extends "admin/admin_base.html" %}
{% from "components/infinite_scroll_feed.html" import infinite_scroll_feed %}

{% block title %}Jokes Â· {{ site_name }} Admin{% endblock %}

{% block content %}
<div class="admin-jokes">
  <header class="admin-jokes-header">
    <div>
      <h2 style="margin: 0;">Jokes</h2>
      <p class="muted" style="margin: 6px 0 0;">Filter by state. Newest first.</p>
    </div>
  </header>

  <section class="filter-chips" aria-label="Joke state filters">
    {% for state in all_states %}
      {% set is_selected = state in selected_states %}
      <button
        type="button"
        class="filter-chip text-button{% if is_selected %} filter-chip--selected{% endif %}"
        data-state="{{ state }}"
        aria-pressed="{{ 'true' if is_selected else 'false' }}"
      >
        {{ state }}
      </button>
    {% endfor %}
  </section>

  {{ infinite_scroll_feed(
    slug='admin-jokes',
    initial_jokes=jokes,
    initial_cursor=next_cursor,
    initial_has_more=has_more,
    width=image_size,
    feed_id='admin-jokes-feed',
    end_of_feed_message="No more jokes match these filters.",
    extra_query_params={'states': selected_states_param},
    admin_mode=true
  ) }}
</div>

<script>
  (function () {
    const chips = Array.from(document.querySelectorAll('.filter-chip[data-state]'));
    if (!chips.length) {
      return;
    }

    function selectedStates() {
      return chips
        .filter((c) => c.classList.contains('filter-chip--selected'))
        .map((c) => c.getAttribute('data-state'))
        .filter(Boolean);
    }

    function setSelected(chip, isSelected) {
      chip.classList.toggle('filter-chip--selected', isSelected);
      chip.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
    }

    function navigateWithStates(states) {
      const url = new URL(window.location.href);
      url.pathname = '/admin/jokes';
      url.searchParams.set('states', states.join(','));
      url.searchParams.delete('cursor');
      window.location.assign(url.toString());
    }

    chips.forEach((chip) => {
      chip.addEventListener('click', () => {
        const current = selectedStates();
        const state = chip.getAttribute('data-state');
        if (!state) {
          return;
        }
        const isSelected = chip.classList.contains('filter-chip--selected');
        if (isSelected) {
          const next = current.filter((s) => s !== state);
          if (!next.length) {
            // Keep at least one filter selected.
            return;
          }
          setSelected(chip, false);
          navigateWithStates(next);
          return;
        }

        setSelected(chip, true);
        navigateWithStates([...current, state]);
      });
    });
  })();
</script>
{% endblock %}

