{% extends "admin/admin_base.html" %}

{% block title %}Ads Stats Â· {{ site_name }} Admin{% endblock %}

{% block content %}
<div class="dashboard-header ads-stats-header">
  <div class="ads-stats-title-block">
    <h2>Ads Stats</h2>
    <p class="muted ads-stats-title-subtitle">Manage filters, imports, and event markers in one place.</p>
  </div>
  <div class="ads-stats-top-data">
    <button class="button-secondary text-button chart-data-button" id="adsStatsTopDataButton" type="button" data-popup-id="adsStatsTopDataPopup">Data</button>
    <div class="chart-data-popup ads-stats-top-data-popup" id="adsStatsTopDataPopup" role="status" aria-live="polite" aria-hidden="true"></div>
  </div>
</div>

<section class="ads-stats-control-panel" aria-label="Ads stats controls">
  <div class="ads-stats-actions-row">
    <button id="adsStatsCreateEventToggleButton" class="button-secondary text-button" type="button">Create Event</button>
    <form id="kdpUploadForm" class="ads-stats-upload-form">
      <label class="sr-only" for="kdpFileInput">Upload KDP xlsx</label>
      <input id="kdpFileInput" name="file" type="file" accept=".xlsx" required>
      <span id="kdpUploadStatus" class="muted"></span>
    </form>
  </div>

  <form id="adsStatsCreateEventForm" class="ads-stats-create-event-form" hidden>
    <div class="ads-stats-field ads-stats-event-field">
      <label for="adsStatsEventDateInput">Event Date</label>
      <input id="adsStatsEventDateInput" type="text" placeholder="YYYY-MM-DD" required>
    </div>
    <div class="ads-stats-field ads-stats-event-field ads-stats-event-field--title">
      <label for="adsStatsEventTitleInput">Event Title</label>
      <input id="adsStatsEventTitleInput" type="text" placeholder="Title" required>
    </div>
    <button id="adsStatsEventCreateButton" class="button-primary text-button" type="submit">Create</button>
    <span id="adsStatsCreateEventStatus" class="muted"></span>
  </form>

  <div class="ads-stats-filters-row">
    <div class="ads-stats-field">
      <label for="campaignSelector">Campaign</label>
      <select id="campaignSelector">
        <option value="All">All</option>
      </select>
    </div>
    <div class="ads-stats-field ads-stats-field--narrow">
      <label for="modeSelector">Mode</label>
      <select id="modeSelector">
        <option value="Timeline">Timeline</option>
        <option value="Days of Week">Days of Week</option>
      </select>
    </div>
  </div>
</section>

<style>
  .main-container {
    gap: 0;
  }
  .ads-stats-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 14px;
  }
  .ads-stats-title-block h2 {
    margin: 0;
  }
  .ads-stats-title-subtitle {
    margin: 6px 0 0;
    font-size: 0.95rem;
  }
  .ads-stats-control-panel {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin: 0 0 20px;
    padding: 14px;
    border: 1px solid var(--color-border);
    border-radius: 12px;
    background: var(--color-surface);
    box-shadow: 0 4px 12px var(--color-shadow);
  }
  .ads-stats-filters-row {
    display: grid;
    grid-template-columns: minmax(260px, 1fr) minmax(180px, 220px);
    align-items: end;
    gap: 12px;
    width: 100%;
    min-width: 0;
  }
  .ads-stats-field {
    display: flex;
    flex-direction: column;
    gap: 6px;
    min-width: 0;
  }
  .ads-stats-field label {
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--color-text);
  }
  .ads-stats-field select,
  .ads-stats-create-event-form input[type="text"],
  .ads-stats-upload-form input[type="file"] {
    width: 100%;
    min-height: 40px;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid var(--color-form-border-strong);
    background: var(--color-form-surface);
    color: var(--color-text);
  }
  .ads-stats-field--narrow {
    max-width: 220px;
    justify-self: end;
  }
  .ads-stats-actions-row {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }
  .ads-stats-top-data {
    position: relative;
    flex-shrink: 0;
  }
  .ads-stats-top-data-popup {
    top: 42px;
    right: 0;
    z-index: 40;
  }
  .ads-stats-create-event-form {
    display: flex;
    align-items: flex-end;
    gap: 10px;
    flex-wrap: wrap;
    padding-top: 10px;
    border-top: 1px dashed var(--color-border);
  }
  .ads-stats-event-field {
    width: min(220px, 100%);
  }
  .ads-stats-event-field--title {
    width: min(340px, 100%);
  }
  .ads-stats-upload-form {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    flex: 1 1 340px;
    min-width: min(340px, 100%);
  }
  .ads-stats-filters-row {
    padding-top: 10px;
    border-top: 1px dashed var(--color-border);
  }
  .ads-stats-upload-form input[type="file"] {
    flex: 1 1 260px;
    min-width: min(260px, 100%);
    padding: 6px 8px;
    background: var(--color-surface);
  }
  .ads-stats-upload-form #kdpUploadStatus {
    font-size: 0.9rem;
    min-height: 1.1rem;
    min-width: 96px;
  }
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  .stat-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    box-shadow: 0 4px 12px var(--color-shadow);
  }
  .stat-card__label {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .stat-card__value {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--color-text);
  }
  .chart-container {
    position: relative;
    height: 320px;
    width: 100%;
    margin-bottom: 56px;
  }
  .chart-container--tall {
    height: 700px;
  }
  .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  .chart-container h3 {
    margin: 0;
  }
  .chart-data-popup {
    position: absolute;
    top: 44px;
    right: 0;
    z-index: 10;
    min-width: 152px;
    max-width: min(240px, calc(100vw - 32px));
    padding: 8px 12px;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 10px;
    box-shadow: 0 4px 16px var(--color-shadow);
    color: var(--color-text);
    font-size: 0.82rem;
    font-weight: 600;
    line-height: 1.3;
    text-align: center;
    opacity: 0;
    visibility: hidden;
    transform: translateY(4px);
    pointer-events: none;
  }
  .chart-data-popup.is-visible {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    transition: opacity 0.12s ease-out, transform 0.12s ease-out;
  }
  .chart-data-popup.is-fading {
    opacity: 0;
    visibility: visible;
    transform: translateY(-2px);
    transition: opacity 1s ease-out, transform 1s ease-out;
  }
  .chart-container:last-child {
    margin-bottom: 0;
  }
  @media (max-width: 900px) {
    .ads-stats-header {
      align-items: stretch;
      flex-direction: column;
    }
    .ads-stats-filters-row {
      grid-template-columns: 1fr;
    }
    .ads-stats-field--narrow {
      max-width: none;
      justify-self: stretch;
    }
  }
  @media (max-width: 640px) {
    .ads-stats-control-panel {
      padding: 12px;
    }
    .ads-stats-actions-row .button-primary,
    .ads-stats-actions-row .button-secondary,
    .ads-stats-create-event-form .button-primary,
    .chart-header .button-secondary,
    .ads-stats-top-data .button-secondary {
      width: 100%;
      justify-content: center;
    }
    .ads-stats-create-event-form {
      align-items: stretch;
    }
    .ads-stats-event-field,
    .ads-stats-event-field--title {
      width: 100%;
    }
    .ads-stats-upload-form {
      min-width: 100%;
      width: 100%;
    }
    .ads-stats-upload-form input[type="file"] {
      width: 100%;
    }
    .ads-stats-top-data-popup {
      left: 0;
      right: auto;
      min-width: min(100%, 520px);
    }
  }
</style>

<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-card__label">Impressions</div>
    <div class="stat-card__value" id="stat-impressions">{{ "{:,.0f}".format(chart_data.total_impressions) }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-card__label">Clicks</div>
    <div class="stat-card__value" id="stat-clicks">{{ "{:,.0f}".format(chart_data.total_clicks) }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-card__label">Cost</div>
    <div class="stat-card__value" id="stat-cost">{{ "${:,.2f}".format(chart_data.total_cost) }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-card__label">CTR</div>
    <div class="stat-card__value" id="stat-ctr">0.0%</div>
  </div>
  <div class="stat-card">
    <div class="stat-card__label">CPC</div>
    <div class="stat-card__value" id="stat-cpc">$0.00</div>
  </div>
  <div class="stat-card">
    <div class="stat-card__label">Conv. Rate</div>
    <div class="stat-card__value" id="stat-conversion-rate">0.0%</div>
  </div>
  <div class="stat-card">
    <div class="stat-card__label">Profit Before Ads (ads)</div>
    <div class="stat-card__value" id="stat-profit-before-ads-ads">{{ "${:,.2f}".format(chart_data.total_gross_profit_before_ads_usd) }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-card__label">Profit Before Ads (reconciled)</div>
    <div class="stat-card__value" id="stat-profit-before-ads-reconciled">{{ "${:,.2f}".format(chart_data.total_gross_profit_before_ads_usd + reconciled_click_date_chart_data.total_organic_profit_usd) }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-card__label">Gross Profit</div>
    <div class="stat-card__value" id="stat-gross-profit">{{ "${:,.2f}".format(chart_data.total_gross_profit_before_ads_usd + reconciled_click_date_chart_data.total_organic_profit_usd - chart_data.total_cost) }}</div>
  </div>
</div>

<p class="muted" style="margin: 0 0 16px;">
  Aggregated daily Amazon Ads performance for {{ start_date }} to {{ end_date }}.
</p>

<section class="stats-charts">
  <div class="chart-container chart-container--tall">
    <div class="chart-header">
      <h3>Profit (Reconciled)</h3>
      <button class="button-secondary text-button chart-data-button" type="button" data-canvas-id="reconciledProfitTimelineChart">Data</button>
    </div>
    <div class="chart-data-popup" id="reconciledProfitTimelineChart-data-popup" data-canvas-id="reconciledProfitTimelineChart" role="status" aria-live="polite" aria-hidden="true"></div>
    <canvas id="reconciledProfitTimelineChart"></canvas>
  </div>
  <div class="chart-container">
    <div class="chart-header">
      <h3>POAS (Reconciled)</h3>
      <button class="button-secondary text-button chart-data-button" type="button" data-canvas-id="reconciledPoasTimelineChart">Data</button>
    </div>
    <div class="chart-data-popup" id="reconciledPoasTimelineChart-data-popup" data-canvas-id="reconciledPoasTimelineChart" role="status" aria-live="polite" aria-hidden="true"></div>
    <canvas id="reconciledPoasTimelineChart"></canvas>
  </div>
  <div class="chart-container">
    <div class="chart-header">
      <h3>CPC / Conversion Rate</h3>
      <button class="button-secondary text-button chart-data-button" type="button" data-canvas-id="cpcAndConversionRateChart">Data</button>
    </div>
    <div class="chart-data-popup" id="cpcAndConversionRateChart-data-popup" data-canvas-id="cpcAndConversionRateChart" role="status" aria-live="polite" aria-hidden="true"></div>
    <canvas id="cpcAndConversionRateChart"></canvas>
  </div>
  <div class="chart-container">
    <div class="chart-header">
      <h3>CTR</h3>
      <button class="button-secondary text-button chart-data-button" type="button" data-canvas-id="ctrChart">Data</button>
    </div>
    <div class="chart-data-popup" id="ctrChart-data-popup" data-canvas-id="ctrChart" role="status" aria-live="polite" aria-hidden="true"></div>
    <canvas id="ctrChart"></canvas>
  </div>
  <div class="chart-container">
    <div class="chart-header">
      <h3>Impressions / Clicks</h3>
      <button class="button-secondary text-button chart-data-button" type="button" data-canvas-id="impressionsAndClicksChart">Data</button>
    </div>
    <div class="chart-data-popup" id="impressionsAndClicksChart-data-popup" data-canvas-id="impressionsAndClicksChart" role="status" aria-live="polite" aria-hidden="true"></div>
    <canvas id="impressionsAndClicksChart"></canvas>
  </div>
  <div class="chart-container">
    <div class="chart-header">
      <h3>Ads Profit Breakdown</h3>
      <button class="button-secondary text-button chart-data-button" type="button" data-canvas-id="adsProfitBreakdownChart">Data</button>
    </div>
    <div class="chart-data-popup" id="adsProfitBreakdownChart-data-popup" data-canvas-id="adsProfitBreakdownChart" role="status" aria-live="polite" aria-hidden="true"></div>
    <canvas id="adsProfitBreakdownChart"></canvas>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/ads_stats.js') }}"></script>
<script>
  const adsStatsPage = window.initAdsStatsPage
    ? window.initAdsStatsPage({
      chartData: {{ chart_data | tojson }},
      reconciledClickDateChartData: {{ reconciled_click_date_chart_data | tojson }},
      reconciliationDebugCsv: {{ reconciliation_debug_csv | tojson }},
      adsEvents: {{ ads_events | tojson }},
    })
    : null;

  const ISO_DATE_PATTERN = /^\d{4}-\d{2}-\d{2}$/;
  const createEventToggleButton = document.getElementById('adsStatsCreateEventToggleButton');
  const createEventForm = document.getElementById('adsStatsCreateEventForm');
  const createEventDateInput = document.getElementById('adsStatsEventDateInput');
  const createEventTitleInput = document.getElementById('adsStatsEventTitleInput');
  const createEventSubmitButton = document.getElementById('adsStatsEventCreateButton');
  const createEventStatus = document.getElementById('adsStatsCreateEventStatus');

  if (createEventToggleButton && createEventForm) {
    createEventToggleButton.addEventListener('click', () => {
      createEventForm.hidden = !createEventForm.hidden;
      if (!createEventForm.hidden && createEventDateInput) {
        createEventDateInput.focus();
      }
    });
  }

  if (createEventForm && createEventDateInput && createEventTitleInput && createEventSubmitButton && createEventStatus) {
    createEventForm.addEventListener('submit', async (event) => {
      event.preventDefault();

      const dateValue = createEventDateInput.value.trim();
      const titleValue = createEventTitleInput.value.trim();
      if (!ISO_DATE_PATTERN.test(dateValue)) {
        createEventStatus.textContent = 'Date must be YYYY-MM-DD';
        return;
      }
      if (!titleValue) {
        createEventStatus.textContent = 'Title is required';
        return;
      }

      createEventSubmitButton.disabled = true;
      createEventStatus.textContent = 'Saving...';
      try {
        const response = await fetch('/admin/ads-stats/events', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            date: dateValue,
            title: titleValue,
          }),
        });
        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.error || 'Failed to save event');
        }
        const savedEvent = data.event || {};
        if (adsStatsPage && typeof adsStatsPage.upsertAdsEvent === 'function') {
          adsStatsPage.upsertAdsEvent(savedEvent);
        }
        createEventTitleInput.value = '';
        createEventStatus.textContent = 'Saved';
      } catch (error) {
        createEventStatus.textContent = error?.message || 'Failed to save event';
      } finally {
        createEventSubmitButton.disabled = false;
      }
    });
  }

  const kdpUploadForm = document.getElementById('kdpUploadForm');
  const kdpFileInput = document.getElementById('kdpFileInput');
  const kdpUploadStatus = document.getElementById('kdpUploadStatus');
  let kdpUploadInFlight = false;

  async function uploadSelectedKdpFile() {
    if (!kdpUploadForm
      || !kdpFileInput
      || !kdpUploadStatus
      || !kdpFileInput.files
      || kdpFileInput.files.length === 0
      || kdpUploadInFlight) {
      return;
    }
    const formData = new FormData();
    formData.append('file', kdpFileInput.files[0]);
    kdpUploadInFlight = true;
    kdpFileInput.disabled = true;
    kdpUploadStatus.textContent = 'Uploading...';
    try {
      const response = await fetch('/admin/ads-stats/upload-kdp', {
        method: 'POST',
        body: formData,
      });
      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.error || 'Upload failed');
      }
      kdpUploadStatus.textContent = `Saved ${data.days_saved} days`;
    } catch (error) {
      kdpUploadStatus.textContent = error?.message || 'Upload failed';
    } finally {
      kdpUploadInFlight = false;
      kdpFileInput.disabled = false;
      kdpFileInput.value = '';
    }
  }

  if (kdpUploadForm && kdpFileInput) {
    kdpUploadForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      await uploadSelectedKdpFile();
    });

    kdpFileInput.addEventListener('change', async () => {
      await uploadSelectedKdpFile();
    });
  }
</script>
{% endblock %}
