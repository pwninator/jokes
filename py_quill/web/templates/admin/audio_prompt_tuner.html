{% extends "admin/admin_base.html" %}
{% from "components/joke_picker.html" import joke_picker %}

{% block title %}Audio Prompt Tuner - {{ site_name }} Admin{% endblock %}

{% block content %}
<style>
  .audio-tuner {
    display: flex;
    flex-direction: column;
    gap: 18px;
  }

  .audio-header {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .audio-actions {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 12px;
  }

  .error-banner {
    padding: 10px 12px;
    border-radius: 12px;
    background: rgba(255, 226, 226, 0.6);
    border: 1px solid rgba(200, 60, 60, 0.3);
    color: #7b1d1d;
  }

  .is-hidden {
    display: none;
  }

  .audio-results {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 16px;
  }

  .audio-result-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 16px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .audio-result-card audio {
    width: 100%;
  }

  .mono {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
      "Liberation Mono", "Courier New", monospace;
    font-size: 0.82rem;
    overflow-wrap: anywhere;
  }

  .stats-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 16px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 10px;
  }
</style>

<div class="audio-tuner">
  <div class="audio-header">
    <h2>Audio Prompt Tuner</h2>
    <p class="muted">
      Pick a joke, generate a 2-kid dialog, and preview the split clips (setup / “what?” / punchline + giggles).
    </p>
  </div>

  <div id="error-banner" class="error-banner {% if not error_message %}is-hidden{% endif %}">
    <span id="error-banner-text">{% if error_message %}{{ error_message }}{% endif %}</span>
  </div>

  <section id="audio-results" class="audio-results is-hidden" aria-label="Generated audio">
    <div class="stats-card" id="audio-stats-card">
      <h3>Generation stats</h3>
      <div class="stats-grid">
        <div>
          <div class="muted small">Model</div>
          <div class="mono" id="audio-meta-model"></div>
        </div>
        <div>
          <div class="muted small">Cost (USD)</div>
          <div class="mono" id="audio-meta-cost"></div>
        </div>
        <div>
          <div class="muted small">Prompt tokens</div>
          <div class="mono" id="audio-meta-prompt-tokens"></div>
        </div>
        <div>
          <div class="muted small">Output tokens</div>
          <div class="mono" id="audio-meta-output-tokens"></div>
        </div>
      </div>
      <details>
        <summary class="muted small">Raw token counts</summary>
        <pre class="mono" id="audio-meta-token-counts" style="margin: 0; white-space: pre-wrap;"></pre>
      </details>
    </div>
    <div class="audio-result-card" id="dialog-card">
      <h3>Full dialog</h3>
      <audio id="dialog-audio" controls></audio>
      <div class="muted mono" id="dialog-uri"></div>
    </div>
    <div class="audio-result-card" id="setup-card">
      <h3>Setup</h3>
      <audio id="setup-audio" controls></audio>
      <div class="muted mono" id="setup-uri"></div>
    </div>
    <div class="audio-result-card" id="response-card">
      <h3>Response</h3>
      <audio id="response-audio" controls></audio>
      <div class="muted mono" id="response-uri"></div>
    </div>
    <div class="audio-result-card" id="punchline-card">
      <h3>Punchline</h3>
      <audio id="punchline-audio" controls></audio>
      <div class="muted mono" id="punchline-uri"></div>
    </div>
  </section>

  <form id="audio-tuner-form" class="card" method="GET">
    <input type="hidden" name="op" value="{{ joke_audio_op }}">
    <div class="audio-actions">
      <button id="generate-button" type="button" class="text-button" disabled>Generate</button>
    </div>
    {{ joke_picker('audio-prompt-tuner-picker') }}
  </form>
</div>

<script src="/static/js/joke_picker.js"></script>
<script>
  (function () {
    const form = document.getElementById('audio-tuner-form');
    const generateButton = document.getElementById('generate-button');
    const errorBanner = document.getElementById('error-banner');
    const errorBannerText = document.getElementById('error-banner-text');
    const results = document.getElementById('audio-results');

    const dialogAudio = document.getElementById('dialog-audio');
    const setupAudio = document.getElementById('setup-audio');
    const responseAudio = document.getElementById('response-audio');
    const punchlineAudio = document.getElementById('punchline-audio');

    const dialogUri = document.getElementById('dialog-uri');
    const setupUri = document.getElementById('setup-uri');
    const responseUri = document.getElementById('response-uri');
    const punchlineUri = document.getElementById('punchline-uri');

    const metaModel = document.getElementById('audio-meta-model');
    const metaCost = document.getElementById('audio-meta-cost');
    const metaPromptTokens = document.getElementById('audio-meta-prompt-tokens');
    const metaOutputTokens = document.getElementById('audio-meta-output-tokens');
    const metaTokenCounts = document.getElementById('audio-meta-token-counts');

    const jokeCreationUrl = {{ joke_creation_url | tojson }};

    function showError(message) {
      if (errorBannerText) {
        errorBannerText.textContent = message || 'Audio generation failed';
      }
      if (errorBanner) {
        errorBanner.classList.remove('is-hidden');
      }
    }

    function clearError() {
      if (errorBannerText) {
        errorBannerText.textContent = '';
      }
      if (errorBanner) {
        errorBanner.classList.add('is-hidden');
      }
    }

    function hideResults() {
      if (results) {
        results.classList.add('is-hidden');
      }
      [dialogAudio, setupAudio, responseAudio, punchlineAudio].forEach((el) => {
        if (!el) return;
        el.pause();
        el.removeAttribute('src');
        el.load();
      });
      if (dialogUri) dialogUri.textContent = '';
      if (setupUri) setupUri.textContent = '';
      if (responseUri) responseUri.textContent = '';
      if (punchlineUri) punchlineUri.textContent = '';
      if (metaModel) metaModel.textContent = '';
      if (metaCost) metaCost.textContent = '';
      if (metaPromptTokens) metaPromptTokens.textContent = '';
      if (metaOutputTokens) metaOutputTokens.textContent = '';
      if (metaTokenCounts) metaTokenCounts.textContent = '';
    }

    function setLoading(isLoading) {
      if (!generateButton) return;
      generateButton.disabled = Boolean(isLoading);
      generateButton.textContent = isLoading ? 'Generating…' : 'Generate';
    }

    function gcsToCdnUrl(gcsUri) {
      if (!gcsUri) return '';
      return 'https://' + String(gcsUri).replace(/^gs:\/\//, '');
    }

    if (!form || !generateButton || !window.JokePicker) {
      return;
    }

    const picker = new window.JokePicker({
      container: '#audio-prompt-tuner-picker',
      states: ['DAILY', 'PUBLISHED'],
      publicOnly: true,
      maxSelection: 1,
      onSelectionChange: (selection) => {
        generateButton.disabled = selection.length !== 1;
      },
    });

    generateButton.addEventListener('click', async function () {
      clearError();
      hideResults();
      setLoading(true);

      const selected = picker ? picker.getSelectedJokes() : [];
      if (!selected || selected.length !== 1) {
        setLoading(false);
        showError('Please select exactly one joke.');
        return;
      }

      const jokeId = selected[0].id;
      const opValue = (form.querySelector('input[name="op"]') || {}).value;

      try {
        const resp = await fetch(jokeCreationUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            data: {
              op: opValue,
              joke_id: jokeId,
            },
          }),
        });

        let json = null;
        try {
          json = await resp.json();
        } catch (e) {
          json = null;
        }
        const data = json && json.data ? json.data : {};
        if (!resp.ok) {
          showError(data.error || `Request failed (${resp.status})`);
          return;
        }

        const dialogGcs = data.dialog_audio_gcs_uri;
        const setupGcs = data.setup_audio_gcs_uri;
        const responseGcs = data.response_audio_gcs_uri;
        const punchlineGcs = data.punchline_audio_gcs_uri;
        const meta = data.audio_generation_metadata || {};

        if (!dialogGcs || !setupGcs || !responseGcs || !punchlineGcs) {
          showError('Audio generation succeeded but returned no URIs');
          return;
        }

        const dialogUrl = gcsToCdnUrl(dialogGcs);
        const setupUrl = gcsToCdnUrl(setupGcs);
        const responseUrl = gcsToCdnUrl(responseGcs);
        const punchlineUrl = gcsToCdnUrl(punchlineGcs);

        dialogAudio.src = dialogUrl;
        setupAudio.src = setupUrl;
        responseAudio.src = responseUrl;
        punchlineAudio.src = punchlineUrl;

        dialogUri.textContent = dialogGcs;
        setupUri.textContent = setupGcs;
        responseUri.textContent = responseGcs;
        punchlineUri.textContent = punchlineGcs;

        const tokenCounts = meta.token_counts || {};
        if (metaModel) metaModel.textContent = meta.model_name || '';
        if (metaCost) {
          const costValue = typeof meta.cost === 'number' ? meta.cost : null;
          metaCost.textContent = costValue === null ? '' : costValue.toFixed(6);
        }
        if (metaPromptTokens) metaPromptTokens.textContent = String(tokenCounts.prompt_tokens ?? '');
        if (metaOutputTokens) metaOutputTokens.textContent = String(tokenCounts.output_tokens ?? '');
        if (metaTokenCounts) metaTokenCounts.textContent = JSON.stringify(tokenCounts, null, 2);

        results.classList.remove('is-hidden');
      } catch (err) {
        showError(String(err || 'Unexpected error'));
      } finally {
        setLoading(false);
      }
    });
  })();
</script>
{% endblock %}

