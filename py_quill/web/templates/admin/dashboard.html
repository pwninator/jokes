{% extends "admin/admin_base.html" %}

{% block title %}Dashboard · {{ site_name }} Admin{% endblock %}

{% block content %}
<style>
  .admin-dashboard {
    display: flex;
    flex-direction: column;
    gap: 18px;
  }

  .admin-dashboard h2 {
    margin: 0;
  }

  .admin-dashboard .subtitle {
    margin: 0;
  }

  .admin-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 14px;
  }

  .admin-card {
    display: block;
    text-decoration: none;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 18px;
    padding: 14px;
    box-shadow: 0 8px 18px rgba(196, 171, 140, 0.16);
    transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
  }

  .admin-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 24px rgba(196, 171, 140, 0.22);
    border-color: var(--color-primary);
  }

  .admin-card-title {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin: 0 0 6px;
  }

  .admin-card-title span {
    text-decoration: underline;
    text-decoration-thickness: 2px;
    text-underline-offset: 3px;
  }

  .admin-card-desc {
    margin: 0;
  }

  .admin-panel {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 18px;
    padding: 14px;
    box-shadow: 0 8px 18px rgba(196, 171, 140, 0.16);
  }

  .admin-panel h3 {
    margin: 0 0 6px;
  }

  .bundle-actions {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 10px;
  }

  .bundle-link-container a {
    font-weight: 600;
    text-decoration: underline;
    text-underline-offset: 3px;
  }
</style>

<div class="admin-dashboard">
  <div>
    <h2>Welcome back</h2>
    <p class="muted subtitle">Quick links for common admin tasks.</p>
  </div>

  <section class="admin-grid" aria-label="Admin quick links">
    <a class="admin-card" href="{{ url_for('web.admin_jokes') }}">
      <div class="admin-card-title text-body">
        <span>Jokes</span>
        <span class="muted text-button">→</span>
      </div>
      <p class="admin-card-desc muted">Browse jokes by state and review usage stats.</p>
    </a>
    <a class="admin-card" href="{{ url_for('web.admin_joke_categories') }}">
      <div class="admin-card-title text-body">
        <span>Joke categories</span>
        <span class="muted text-button">→</span>
      </div>
      <p class="admin-card-desc muted">Review categories and their cached jokes.</p>
    </a>
    <a class="admin-card" href="{{ url_for('web.admin_printable_notes') }}">
      <div class="admin-card-title text-body">
        <span>Printable notes</span>
        <span class="muted text-button">→</span>
      </div>
      <p class="admin-card-desc muted">View all printable note sheets organized by category.</p>
    </a>
    <a class="admin-card" href="{{ url_for('web.admin_joke_books') }}">
      <div class="admin-card-title text-body">
        <span>Joke books</span>
        <span class="muted text-button">→</span>
      </div>
      <p class="admin-card-desc muted">Generate book pages and ZIP downloads.</p>
    </a>
    <a class="admin-card" href="{{ url_for('web.admin_redirect_tester') }}">
      <div class="admin-card-title text-body">
        <span>Amazon redirect tester</span>
        <span class="muted text-button">→</span>
      </div>
      <p class="admin-card-desc muted">Validate country redirects and ASIN mapping.</p>
    </a>
    <a class="admin-card" href="{{ url_for('web.admin_stats') }}">
      <div class="admin-card-title text-body">
        <span>Stats</span>
        <span class="muted text-button">→</span>
      </div>
      <p class="admin-card-desc muted">Usage charts and retention views.</p>
    </a>
  </section>

  <section class="admin-panel" aria-label="Firestore bundle">
    <h3>Firestore bundle</h3>
    <p class="muted" style="margin: 0;">
      Generate an offline bundle for the app. This runs a long job and stores the file in Cloud Storage.
    </p>
    <div class="bundle-actions">
      <button id="generate-bundle-button" class="text-button" type="button">Generate bundle</button>
      <span id="bundle-status" class="muted"></span>
    </div>
    <div id="bundle-link-container" class="bundle-link-container" style="margin-top: 8px;"></div>
  </section>
</div>

<script>
  const bundleButton = document.getElementById('generate-bundle-button');
  const bundleStatus = document.getElementById('bundle-status');
  const bundleLinkContainer = document.getElementById('bundle-link-container');

  async function generateBundle() {
    bundleButton.disabled = true;
    bundleStatus.textContent = 'Starting bundle generation...';
    bundleLinkContainer.innerHTML = '';
    try {
      const resp = await fetch('/get_joke_bundle', { method: 'POST' });
      if (!resp.ok) {
        const text = await resp.text();
        throw new Error(`Request failed (${resp.status}): ${text}`);
      }
      const data = await resp.json();
      const bundleUrl = data?.data?.bundle_url;
      if (!bundleUrl) {
        throw new Error('Bundle URL missing from response');
      }
      bundleStatus.textContent = 'Bundle ready:';
      bundleLinkContainer.innerHTML =
        `<a href="${bundleUrl}" target="_blank" rel="noopener noreferrer">Download Firestore bundle</a>`;
    } catch (error) {
      console.error('Bundle generation failed', error);
      bundleStatus.textContent = 'Error generating bundle';
      bundleLinkContainer.textContent = error.message || 'Unknown error';
    } finally {
      bundleButton.disabled = false;
    }
  }

  bundleButton.addEventListener('click', generateBundle);
</script>
{% endblock %}
