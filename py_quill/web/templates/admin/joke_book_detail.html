{% extends "admin/admin_base.html" %}
{% from "components/joke_card.html" import joke_card %}

{% block title %}{{ book.book_name }} · Joke Book · {{ site_name }} Admin{% endblock %}

{% block head_extra %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/joke_admin_modals.css') }}">
<style>
  .search-section {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 20px;
    padding: 16px;
    margin-bottom: 24px;
    box-shadow: 0 4px 12px rgba(196, 171, 140, 0.1);
  }

  .search-controls {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
  }

  .search-input {
    flex: 1;
    padding: 8px 16px;
    border: 1px solid var(--color-border);
    border-radius: 999px;
    font-size: 16px;
    font-family: inherit;
  }

  .search-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 16px;
  }

  .search-result-card {
    border: 1px solid var(--color-border);
    border-radius: 12px;
    overflow: hidden;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    background: var(--color-surface);
  }

  .search-result-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: var(--color-primary);
  }

  .search-result-img {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
    display: block;
  }

  .search-result-meta {
    padding: 8px;
    font-size: 12px;
    color: var(--color-muted);
    text-align: center;
  }

  .page-actions {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
  }

  .page-actions-right {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  .text-section-heading .book-id {
    margin-left: 10px;
    font-size: 0.85em;
    font-weight: 400;
    color: var(--color-muted);
  }

  .zip-action-group {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .book-page-ready-filter-hidden {
    display: none !important;
  }

  .book-page-ready-toggle {
    background: transparent;
    border: 1px solid var(--color-border);
    color: var(--color-muted);
    padding: 6px 12px;
    border-radius: 999px;
    cursor: pointer;
    font-size: 13px;
  }

  .book-page-ready-toggle.is-ready {
    color: #2e7d32;
    border-color: #2e7d32;
    background: rgba(46, 125, 50, 0.08);
  }

  .book-page-ready-toggle:hover {
    border-color: #2e7d32;
  }

  .joke-book-detail-grid {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .joke-book-detail-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 20px;
    padding: 16px;
    box-shadow: 0 12px 30px rgba(196, 171, 140, 0.18);
  }

  .joke-book-detail-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    justify-content: space-between;
  }

  .joke-book-detail-meta {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .position-select {
    padding: 4px 8px;
    border-radius: 6px;
    border: 1px solid var(--color-border);
    background: var(--color-surface);
    font-family: inherit;
    font-size: 14px;
    cursor: pointer;
  }

  .remove-joke-btn {
    background: transparent;
    border: 1px solid var(--color-border);
    color: #ef5350;
    padding: 6px 12px;
    border-radius: 999px;
    cursor: pointer;
    font-size: 13px;
    margin-left: 8px;
  }

  .remove-joke-btn:hover {
    background: #ffebee;
    border-color: #ef5350;
  }

  .joke-book-detail-metrics {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 8px;
  }

  .metric-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 999px;
    background: var(--color-pill-bg);
    border: 1px solid var(--color-border);
    font-variant-numeric: tabular-nums;
  }

  .metric-label {
    color: var(--color-muted);
    font-size: 12px;
  }

  .metric-value {
    font-weight: 600;
  }

  .joke-book-detail-images {
    display: grid;
    grid-template-columns: repeat(2, minmax(400px, 1fr));
    gap: 24px;
    align-items: start;
  }

  .image-frame {
    background: var(--color-accent-surface);
    border: 1px solid var(--color-border);
    border-radius: 16px;
    min-height: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px;
  }

  .image-frame img,
  .image-frame .joke-book-detail-placeholder {
    width: 100%;
    max-width: 800px;
    height: auto;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    border-radius: 12px;
  }

  .image-actions {
    align-self: flex-start;
    margin-top: 4px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .download-link {
    color: var(--color-primary);
    text-decoration: none;
  }

  .download-link:hover {
    text-decoration: underline;
  }

  .joke-book-detail-placeholder {
    background: repeating-linear-gradient(
      45deg,
      rgba(212, 160, 23, 0.08),
      rgba(212, 160, 23, 0.08) 12px,
      rgba(212, 160, 23, 0.15) 12px,
      rgba(212, 160, 23, 0.15) 24px
    );
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
  }

  .back-link {
    text-decoration: none;
  }

  .back-link:hover {
    text-decoration: underline;
  }

  .joke-book-detail-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto;
  }

  .joke-book-detail-form-row {
    display: flex;
    gap: 16px;
    align-items: flex-start;
    flex-wrap: wrap;
  }

  .joke-book-detail-form-body {
    flex: 1 1 320px;
    min-width: 260px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .joke-book-detail-preview {
    max-width: 200px;
    margin-bottom: 0;
    flex: 0 0 200px;
  }

  .cta-btn {
    background: var(--color-primary);
    border: none;
    padding: 8px 14px;
    border-radius: 999px;
    cursor: pointer;
  }

  .cta-btn:hover {
    opacity: 0.9;
  }

  .cta-btn[disabled],
  .cta-btn[disabled]:hover {
    background: rgba(74, 59, 50, 0.2);
    cursor: default;
    opacity: 1;
  }

  .cost-pill {
    background: var(--color-pill-bg);
    border-radius: 999px;
    padding: 6px 12px;
  }

  .joke-book-detail-hidden {
    display: none !important;
  }

  .instructions {
    margin-top: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .instructions textarea {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    padding: 10px;
    min-height: 64px;
    resize: vertical;
  }

  .status-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 0;
  }

  .timer-chip {
    background: var(--color-pill-bg);
    border-radius: 999px;
    padding: 4px 10px;
  }

  .variant-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    grid-auto-rows: auto;
    grid-auto-flow: dense;
    gap: 8px;
    width: 100%;
    max-width: 800px;
    align-self: stretch;
    justify-content: start;
  }

  .variants {
    display: contents;
    margin-bottom: 12px;
    flex: 1 1 0%;
  }

  .variant-tile {
    width: 100%;
    min-width: 100px;
    min-height: 0;
    aspect-ratio: 1 / 1;
    box-sizing: border-box;
    border: 2px solid rgba(212, 160, 23, 0.25);
    background: var(--color-accent-surface);
    border-radius: 10px;
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  .variant-tile.original-variant {
    grid-column: span 2;
    grid-row: span 2;
  }

  .variant-tile img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
  }

  .variant-delete {
    position: absolute;
    top: 6px;
    right: 6px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: none;
    background: rgba(239, 83, 80, 0.95);
    color: #fff;
    font-size: 14px;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  }

  .variant-delete:hover {
    background: #d32f2f;
  }

  .variant-label {
    margin-bottom: 6px;
  }


  .regenerate-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
    margin-top: 0;
  }

  .regenerate-footer {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 12px;
  }

  .regenerate-footer .status-row {
    margin-top: 0;
  }

  @media (max-width: 1100px) {
    .joke-book-detail-images {
      grid-template-columns: 1fr;
    }

    .image-frame {
      width: 100%;
    }

    .instructions-row {
      grid-template-columns: 1fr;
    }

    .joke-book-detail-form-row {
      flex-direction: column;
    }

    .joke-book-detail-preview {
      max-width: 100%;
      flex: 1 1 auto;
    }
  }

  .upload-btn {
    width: 100%;
    height: 100%;
    min-width: 100px;
    min-height: 0;
    aspect-ratio: 1 / 1;
    box-sizing: border-box;
    border: 2px dashed rgba(212, 160, 23, 0.4);
    background: rgba(212, 160, 23, 0.05);
    border-radius: 10px;
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-primary);
    font-size: 24px;
    transition: all 0.2s ease;
  }

  .upload-btn:hover {
    background: rgba(212, 160, 23, 0.15);
    border-color: var(--color-primary);
  }

  .upload-input {
    display: none;
  }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/joke_admin_actions.js') }}"></script>
<script>
  if (window.initJokeAdminActions) {
    window.initJokeAdminActions({
      jokeCreationUrl: {{ joke_creation_url | tojson }},
    });
  }
</script>
{% endblock %}
{% macro render_variants(variants, label, target_field, joke_id, book_id, original_image=None, original_preview=None) -%}
  <div class="variant-group">
    <div class="variant-label text-button">{{ label }}</div>
    <div class="variant-row">
      <div class="variants" data-target-field="{{ target_field }}">
        {% set original_url = original_image or original_preview %}
        {% set original_src = original_preview or original_image %}
        {% if original_url and original_src %}
        <div class="variant-tile original-variant"
          role="button"
          tabindex="0"
          data-joke-id="{{ joke_id }}"
          data-book-id="{{ book_id }}"
          data-target-field="{{ target_field }}"
          data-image-url="{{ original_url }}"
          data-image-original="{{ original_url }}">
          <button class="variant-delete" type="button" aria-label="Remove image">
            &times;
          </button>
          <img src="{{ original_src }}" alt="Original image option">
        </div>
        {% endif %}
        {% if variants %}
          {% for variant in variants %}
          {% set variant_url = variant.image_url or variant %}
          {% set variant_thumb = variant.thumb_url or variant_url %}
          <div class="variant-tile"
            role="button"
            tabindex="0"
            data-joke-id="{{ joke_id }}"
            data-book-id="{{ book_id }}"
            data-target-field="{{ target_field }}"
            data-image-url="{{ variant_url }}"
            data-image-original="{{ variant_url }}">
            <button class="variant-delete" type="button" aria-label="Remove image">
              &times;
            </button>
            <img src="{{ variant_thumb }}" alt="{{ label }} option {{ loop.index }}">
          </div>
          {% endfor %}
        {% endif %}
        <label class="upload-btn" title="Upload custom image">
          +
          <input type="file" 
            class="upload-input" 
            accept="image/*"
            data-joke-id="{{ joke_id }}"
            data-book-id="{{ book_id }}"
            data-target-field="{{ target_field }}">
        </label>
      </div>
    </div>
  </div>
{%- endmacro %}

{% block content %}
<div class="page-actions">
  <a class="back-link site-footer__link text-button" href="{{ url_for('web.admin_joke_books') }}">← Back to joke books</a>
  <div class="page-actions-right">
    <div class="zip-action-group">
      {% if book.zip_url %}
      <a class="back-link site-footer__link text-button download-zip-link" href="{{ book.zip_url }}" target="_blank" rel="noopener noreferrer">Download all pages (ZIP)</a>
      {% else %}
      <span class="muted download-zip-missing">ZIP not generated</span>
      {% endif %}
      <button
        class="cta-btn nav-cta text-button book-zip-regenerate"
        type="button"
        data-book-id="{{ book.id }}">
        {% if book.zip_url %}Regenerate ZIP{% else %}Generate ZIP{% endif %}
      </button>
    </div>
    <button class="cta-btn nav-cta text-button book-page-filter-toggle" type="button">All pages</button>
  </div>
</div>

<h2 class="text-section-heading">
  {{ book.book_name }}
  <code class="book-id">{{ book.id }}</code>
  {% if book_total_cost is not none %}
  <span class="cost-pill text-button">${{ '%.4f'|format(book_total_cost) }}</span>
  {% endif %}
</h2>

{% include "components/joke_admin_modals.html" %}

<section class="search-section">
  <div class="search-controls">
    <input type="text" class="search-input" placeholder="Search for jokes to add..." id="joke-search-input">
    <div style="display: flex; align-items: center; gap: 8px;">
      <input type="checkbox" id="joke-search-category-checkbox" style="width: 20px; height: 20px;">
      <label for="joke-search-category-checkbox" class="text-body">Category</label>
    </div>
    <button class="cta-btn text-button" type="button" id="joke-search-btn">Search</button>
  </div>
  <div class="search-grid" id="search-results"></div>
  <div style="display: flex; justify-content: flex-end; margin-top: 16px;">
    <button class="cta-btn text-button" type="button" id="add-selected-btn" disabled>Add Selected</button>
  </div>
</section>

{% if not jokes %}
<p class="muted">No jokes found for this book.</p>
  {% else %}
  <div class="joke-book-detail-grid">
  {% for joke in jokes %}
  <article class="joke-book-detail-card" data-joke-id="{{ joke.id }}" data-book-page-ready="{{ 'true' if joke.book_page_ready else 'false' }}" data-main-setup-image="{{ joke.setup_original_image_raw or '' }}" data-main-punchline-image="{{ joke.punchline_original_image_raw or '' }}">
    <form method="post"
      class="regenerate-form"
      data-joke-id="{{ joke.id }}"
      data-book-id="{{ book.id }}"
      action="{{ generate_book_page_url }}"
      target="_blank">
      <input type="hidden" name="joke_id" value="{{ joke.id }}">
      <div class="joke-book-detail-form-row">
        <div class="joke-book-detail-preview">
          {{ joke_card(
            joke.card_joke,
            width=200,
            joke_id=joke.id,
            admin_stats_enabled=false,
            admin_edit_enabled=true,
            edit_payload=joke.edit_payload
          ) }}
        </div>
        <div class="joke-book-detail-form-body">
          <div class="joke-book-detail-header text-body">
            <div class="joke-book-detail-meta text-body">
              <select class="position-select" data-joke-id="{{ joke.id }}" aria-label="Joke position">
                {% for i in range(1, jokes|length + 1) %}
                <option value="{{ i }}" {% if i == joke.sequence %}selected{% endif %}>{{ i }}</option>
                {% endfor %}
              </select>
              <strong>Joke {{ joke.sequence }}</strong>
              <code>{{ joke.id }}</code>
               {% if joke.total_cost is not none %}
               <span class="cost-pill cost-pill-value text-button">${{ '%.4f'|format(joke.total_cost) }}</span>
               {% else %}
               <span class="cost-pill cost-pill-value text-button muted">Cost unavailable</span>
               {% endif %}
              <button
                class="book-page-ready-toggle text-button {% if joke.book_page_ready %}is-ready{% endif %}"
                type="button"
                data-joke-id="{{ joke.id }}"
                aria-pressed="{{ 'true' if joke.book_page_ready else 'false' }}">
                {% if joke.book_page_ready %}Ready{% else %}Not ready{% endif %}
              </button>
              <button class="remove-joke-btn text-button" type="button" data-joke-id="{{ joke.id }}">Remove</button>
            </div>
            <button class="cta-btn nav-cta text-button reveal-btn" type="button">Regenerate pages</button>
          </div>
          <div class="joke-book-detail-metrics text-button">
            <div class="metric-pill">
              <span class="metric-label">Views</span>
              <span class="metric-value" data-metric="num_views">{{ joke.num_views }}</span>
            </div>
            <div class="metric-pill">
              <span class="metric-label">Saves</span>
              <span class="metric-value" data-metric="num_saves">{{ joke.num_saves }}</span>
            </div>
            <div class="metric-pill">
              <span class="metric-label">Shares</span>
              <span class="metric-value" data-metric="num_shares">{{ joke.num_shares }}</span>
            </div>
            <div class="metric-pill">
              <span class="metric-label">Popularity</span>
              <span class="metric-value" data-metric="popularity_score">{{ '%.3f'|format(joke.popularity_score or 0) }}</span>
            </div>
            <div class="metric-pill">
              <span class="metric-label">Save %</span>
              <span class="metric-value" data-metric="num_saved_users_fraction">{{ '%.2f'|format(joke.num_saved_users_fraction or 0) }}</span>
            </div>
          </div>
        </div>
      </div>
      <div class="instructions instructions-row joke-book-detail-hidden">
        <div class="text-body source-toggle">
          <div class="text-button">Regenerate from</div>
          <label class="text-body">
            <input type="radio" name="base_image_source" value="original" checked>
            Original joke images
          </label>
          <label class="text-body">
            <input type="radio" name="base_image_source" value="book_page">
            Current book page images
          </label>
          <label class="text-body">
            <input type="checkbox" name="style_update" value="true">
            Style Update
          </label>
          <label class="text-body">
            <input type="checkbox" name="include_text" value="true" checked>
            Include Text
          </label>
        </div>
        <div>
          <label class="text-button" for="setup-{{ joke.id }}">Setup instructions (optional)</label>
          <textarea id="setup-{{ joke.id }}" name="setup_instructions" placeholder="Extra guidance for the setup image"></textarea>
        </div>
        <div>
          <label class="text-button" for="punch-{{ joke.id }}">Punchline instructions (optional)</label>
          <textarea id="punch-{{ joke.id }}" name="punchline_instructions" placeholder="Extra guidance for the punchline image"></textarea>
        </div>
      </div>
      <div class="regenerate-footer">
        <div class="status-row joke-book-detail-hidden">
          <span class="timer-chip timer-display text-button">0:00</span>
          <span class="inline-error form-error text-button"></span>
        </div>
        <button class="cta-btn nav-cta text-button submit-btn joke-book-detail-hidden" type="submit">Submit</button>
      </div>
    </form>
    <div class="joke-book-detail-images">
      <div class="image-column">
        {{ render_variants(
            joke.setup_variants,
            "Setup options",
            "book_page_setup_image_url",
            joke.id,
            book.id,
            original_image=joke.setup_original_image_raw or joke.setup_original_image,
            original_preview=joke.setup_preview or joke.setup_original_image) }}
        <div class="image-frame">
          <img class="joke-book-detail-image setup-img {% if not joke.setup_image %}joke-book-detail-hidden{% endif %}"
            src="{{ joke.setup_image or '' }}" alt="Setup image for {{ joke.id }}" width="800" height="800" loading="lazy">
          <div class="joke-book-detail-placeholder text-body text-button setup-placeholder {% if joke.setup_image %}joke-book-detail-hidden{% endif %}" role="img"
            aria-label="Setup image missing">No setup image</div>
        </div>
        <div class="image-actions setup-download {% if not joke.setup_image_download %}joke-book-detail-hidden{% endif %}">
          <a class="download-link text-button"
            href="{{ joke.setup_image_download or '' }}"
            target="_blank"
            rel="noopener noreferrer">
            Download
          </a>
          <a class="download-link text-button set-main-link"
            href="#"
            data-target="setup"
            data-joke-id="{{ joke.id }}">
            Set as main joke image
          </a>
        </div>
      </div>
      <div class="image-column">
        {{ render_variants(
            joke.punchline_variants,
            "Punchline options",
            "book_page_punchline_image_url",
            joke.id,
            book.id,
            original_image=joke.punchline_original_image_raw or joke.punchline_original_image,
            original_preview=joke.punchline_preview or joke.punchline_original_image) }}
        <div class="image-frame">
          <img class="joke-book-detail-image punchline-img {% if not joke.punchline_image %}joke-book-detail-hidden{% endif %}"
            src="{{ joke.punchline_image or '' }}" alt="Punchline image for {{ joke.id }}" width="800" height="800"
            loading="lazy">
          <div class="joke-book-detail-placeholder text-body text-button punchline-placeholder {% if joke.punchline_image %}joke-book-detail-hidden{% endif %}" role="img"
            aria-label="No punchline image">No punchline image</div>
        </div>
        <div class="image-actions punchline-download {% if not joke.punchline_image_download %}joke-book-detail-hidden{% endif %}">
          <a class="download-link text-button"
            href="{{ joke.punchline_image_download or '' }}"
            target="_blank"
            rel="noopener noreferrer">
            Download
          </a>
          <a class="download-link text-button set-main-link"
            href="#"
            data-target="punchline"
            data-joke-id="{{ joke.id }}">
            Set as main joke image
          </a>
        </div>
      </div>
    </div>
  </article>
  {% endfor %}
</div>
{% endif %}

<script>
  (function () {
    const bookId = {{ book.id | tojson }};
    const forms = Array.from(document.querySelectorAll('.regenerate-form'));
    const updateBookPageUrl = "{{ update_book_page_url }}";
    const setMainImageUrl = {{ set_main_image_url | tojson }};
    const jokeCreationUrl = {{ joke_creation_url | tojson }};
    const functionsOrigin = {{ functions_origin | tojson }};
    const regenerateZipEndpoint = functionsOrigin
      ? `${functionsOrigin}/update_joke_book_zip`
      : '/update_joke_book_zip';
    const activeColor = getComputedStyle(document.documentElement)
      .getPropertyValue('--color-primary-dark')
      .trim() || '#ff0000';
    const inactiveColor = getComputedStyle(document.documentElement)
      .getPropertyValue('--color-surface')
      .trim() || '#ffffff';
    const activeVariantBorder = `3px solid ${activeColor}`;
    const inactiveVariantBorder = `3px solid ${inactiveColor}`;
    const readyFilterToggle = document.querySelector('.book-page-filter-toggle');
    let showNotReadyOnly = false;

    const isCardReady = (card) => {
      return (card?.dataset?.bookPageReady || '').toLowerCase() === 'true';
    };

    const setCardReadyState = (card, isReady) => {
      if (!card) return;
      card.dataset.bookPageReady = isReady ? 'true' : 'false';
      const btn = card.querySelector('.book-page-ready-toggle');
      if (!btn) return;
      btn.textContent = isReady ? 'Ready' : 'Not ready';
      btn.classList.toggle('is-ready', isReady);
      btn.setAttribute('aria-pressed', isReady ? 'true' : 'false');
    };

    const applyReadyFilter = () => {
      document.querySelectorAll('.joke-book-detail-card').forEach((card) => {
        const shouldHide = showNotReadyOnly && isCardReady(card);
        card.classList.toggle('book-page-ready-filter-hidden', shouldHide);
      });
      updateReadyFilterLabel();
    };

    const getShownCount = () => {
      return document.querySelectorAll(
        '.joke-book-detail-card:not(.book-page-ready-filter-hidden)').length;
    };

    const updateReadyFilterLabel = () => {
      if (!readyFilterToggle) return;
      const count = getShownCount();
      const label = showNotReadyOnly ? 'Not ready pages' : 'All pages';
      readyFilterToggle.textContent = `${label} (${count})`;
    };

    if (readyFilterToggle) {
      updateReadyFilterLabel();
      readyFilterToggle.addEventListener('click', () => {
        showNotReadyOnly = !showNotReadyOnly;
        applyReadyFilter();
      });
    }

    document.querySelectorAll('.book-page-ready-toggle').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const jokeId = btn.dataset.jokeId;
        const card = btn.closest('.joke-book-detail-card');
        const errorBox = card?.querySelector('.inline-error');
        if (!jokeId || !card) return;

        if (errorBox) errorBox.textContent = '';

        const originalReady = isCardReady(card);
        const nextReady = !originalReady;
        setCardReadyState(card, nextReady);
        applyReadyFilter();

        btn.disabled = true;
        try {
          const resp = await fetch(jokeCreationUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
              data: {
                joke_id: jokeId,
                book_page_ready: nextReady,
              },
            }),
          });
          if (!resp.ok) {
            let text = '';
            try {
              text = await resp.text();
            } catch (_e) {
              text = '';
            }
            throw new Error(text || `Request failed (${resp.status})`);
          }
        } catch (err) {
          setCardReadyState(card, originalReady);
          applyReadyFilter();
          if (errorBox) {
            errorBox.textContent = err?.message || 'Failed to update page readiness.';
          }
        } finally {
          btn.disabled = false;
        }
      });
    });
    const bustCache = (url) => {
      if (!url) return '';
      const sep = url.includes('?') ? '&' : '?';
      return `${url}${sep}t=${Date.now()}`;
    };
    const normalizeUrl = (url) => {
      if (!url) return '';
      const noQuery = url.replace(/\?.*$/, '');
      const prefix = "https://images.quillsstorybook.com/cdn-cgi/image/";
      if (!noQuery.startsWith(prefix)) return noQuery;
      const remainder = noQuery.slice(prefix.length);
      const slashIndex = remainder.indexOf('/');
      if (slashIndex === -1) return noQuery;
      return remainder.slice(slashIndex + 1);
    };

    const getTileImageUrl = (tile) => {
      if (!tile) return '';
      return tile.dataset.imageOriginal || tile.dataset.imageUrl || '';
    };

    const getCardMainImage = (card, targetField) => {
      if (!card) return '';
      if (targetField === 'book_page_setup_image_url') {
        return card.dataset.mainSetupImage || '';
      }
      return card.dataset.mainPunchlineImage || '';
    };

    const getCardCurrentImage = (card, targetField) => {
      if (!card) return '';
      if (targetField === 'book_page_setup_image_url') {
        return card.querySelector('.setup-img')?.getAttribute('src') || '';
      }
      return card.querySelector('.punchline-img')?.getAttribute('src') || '';
    };

    const isDeleteProtected = (tile, card) => {
      const targetField = tile?.dataset?.targetField;
      if (!targetField) return true;
      const tileUrl = normalizeUrl(getTileImageUrl(tile));
      if (!tileUrl) return true;
      const currentUrl = normalizeUrl(getCardCurrentImage(card, targetField));
      const mainUrl = normalizeUrl(getCardMainImage(card, targetField));
      return (tileUrl && currentUrl && tileUrl === currentUrl)
        || (tileUrl && mainUrl && tileUrl === mainUrl);
    };

    const updateDeleteStateForCard = (card) => {
      if (!card) return;
      const tiles = card.querySelectorAll('.variant-tile');
      tiles.forEach((tile) => {
        const deleteBtn = tile.querySelector('.variant-delete');
        if (!deleteBtn) return;
        const isProtected = isDeleteProtected(tile, card);
        deleteBtn.style.display = isProtected ? 'none' : '';
        deleteBtn.disabled = isProtected;
        deleteBtn.dataset.protected = isProtected ? 'true' : 'false';
      });
    };

    const updateDownloadLink = (card, selector, url) => {
      const container = card.querySelector(selector);
      const link = container?.querySelector('a');
      if (!container || !link) return;
      if (url) {
        link.href = url;
        container.classList.remove('joke-book-detail-hidden');
      } else {
        link.removeAttribute('href');
        container.classList.add('joke-book-detail-hidden');
      }
    };

    const applyTileHighlight = (tile, isActive) => {
      tile.style.border = isActive ? activeVariantBorder : inactiveVariantBorder;
    };

    const setupZipRegenerator = () => {
      const button = document.querySelector('.book-zip-regenerate');
      const container = button?.closest('.zip-action-group');
      if (!button || !container) return;
      const bookId = button.dataset.bookId;
      if (!bookId) return;

      button.addEventListener('click', async () => {
        const originalLabel = button.textContent;
        button.disabled = true;
        button.textContent = 'Regenerating...';
        try {
          const resp = await fetch(regenerateZipEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: { joke_book_id: bookId } }),
          });

          if (!resp.ok) {
            const text = await resp.text();
            throw new Error(`Request failed (${resp.status}): ${text}`);
          }

          const payload = await resp.json();
          const newUrl = payload?.data?.zip_url;
          if (!newUrl) {
            throw new Error('zip_url missing from response');
          }

          let link = container.querySelector('.download-zip-link');
          if (!link) {
            link = document.createElement('a');
            link.className =
              'back-link site-footer__link text-button download-zip-link';
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            link.textContent = 'Download all pages (ZIP)';
            container.insertBefore(link, button);
          }
          link.href = newUrl;

          const missingLabel = container.querySelector('.download-zip-missing');
          if (missingLabel) {
            missingLabel.remove();
          }

          button.textContent = 'Regenerate ZIP';
        } catch (error) {
          console.error('Failed to regenerate ZIP', error);
          alert(error?.message || 'Failed to regenerate ZIP');
          button.textContent = originalLabel;
        } finally {
          button.disabled = false;
        }
      });
    };

    const startTimer = (statusRow, timerDisplay) => {
      statusRow.classList.remove('joke-book-detail-hidden');
      const start = Date.now();
      const renderTime = () => {
        const elapsed = Math.floor((Date.now() - start) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = String(elapsed % 60).padStart(2, '0');
        timerDisplay.textContent = `${minutes}:${seconds}`;
      };
      renderTime();
      const id = window.setInterval(renderTime, 1000);
      return () => window.clearInterval(id);
    };

    const setLinkLoadingState = (link, isLoading) => {
      if (!link) return;
      if (isLoading) {
        link.dataset.originalText = link.textContent;
        link.textContent = 'Setting...';
        link.dataset.loading = 'true';
        link.style.pointerEvents = 'none';
      } else {
        const original = link.dataset.originalText;
        if (original) {
          link.textContent = original;
        }
        link.dataset.loading = 'false';
        link.style.pointerEvents = '';
      }
    };

    function attachSetMainListener(link) {
      if (!link) return;
      link.addEventListener('click', (evt) => {
        evt.preventDefault();
        if (link.dataset.loading === 'true') return;
        const jokeId = link.dataset.jokeId;
        const target = link.dataset.target;
        const card = link.closest('.joke-book-detail-card');
        const statusRow = card?.querySelector('.status-row');
        const timerDisplay = card?.querySelector('.timer-display');
        const errorBox = card?.querySelector('.inline-error');
        if (!jokeId || !target || !card || !statusRow || !timerDisplay || !errorBox) {
          return;
        }
        errorBox.textContent = '';
        const stopper = startTimer(statusRow, timerDisplay);
        setLinkLoadingState(link, true);

        const formData = new FormData();
        formData.set('joke_book_id', bookId);
        formData.set('joke_id', jokeId);
        formData.set('target', target);

        fetch(setMainImageUrl, {
          method: 'POST',
          body: formData,
          mode: 'cors',
        })
          .then((resp) => {
            if (!resp.ok) {
              return resp.text().then((txt) => {
                throw new Error(txt || 'Failed to set main image');
              });
            }
            return resp.json();
          })
          .then(() => updateRow(bookId, jokeId))
          .catch((err) => {
            console.error(err);
            errorBox.textContent = err?.message || 'Failed to set main image.';
          })
          .finally(() => {
            if (stopper) stopper();
            setLinkLoadingState(link, false);
          });
      });
    }

    function attachDeleteListener(button) {
      if (!button) return;
      button.addEventListener('click', (evt) => {
        evt.preventDefault();
        evt.stopPropagation();
        if (button.dataset.protected === 'true' || button.disabled) return;
        const tile = button.closest('.variant-tile');
        const bookId = tile?.dataset.bookId;
        const jokeId = tile?.dataset.jokeId;
        const targetField = tile?.dataset.targetField;
        const imageUrl = getTileImageUrl(tile);
        const card = tile?.closest('.joke-book-detail-card');
        const statusRow = card?.querySelector('.status-row');
        const timerDisplay = card?.querySelector('.timer-display');
        const errorBox = card?.querySelector('.inline-error');

        if (!bookId || !jokeId || !targetField || !imageUrl || !card || !statusRow || !timerDisplay || !errorBox) {
          return;
        }

        if (!confirm('Remove this image from the variants list?')) {
          return;
        }

        errorBox.textContent = '';
        const stopper = startTimer(statusRow, timerDisplay);
        const formData = new FormData();
        formData.set('joke_book_id', bookId);
        formData.set('joke_id', jokeId);
        if (targetField === 'book_page_setup_image_url') {
          formData.set('remove_book_page_setup_image_url', imageUrl);
        } else {
          formData.set('remove_book_page_punchline_image_url', imageUrl);
        }

        fetch(updateBookPageUrl, {
          method: 'POST',
          body: formData,
          mode: 'cors',
        })
          .then((resp) => {
            if (!resp.ok) {
              return resp.text().then((txt) => {
                throw new Error(txt || 'Failed to delete image');
              });
            }
            return resp.text();
          })
          .then(() => {
            tile.remove();
            return updateRow(bookId, jokeId);
          })
          .catch((err) => {
            console.error(err);
            errorBox.textContent = err?.message || 'Failed to delete image.';
          })
          .finally(() => {
            if (stopper) stopper();
          });
      });
    }

    function attachTileListener(tile) {
      tile.addEventListener('click', () => {
        const bookId = tile.dataset.bookId;
        const jokeId = tile.dataset.jokeId;
        const targetField = tile.dataset.targetField;
        const imageUrl = tile.dataset.imageUrl;
        const card = tile.closest('.joke-book-detail-card');
        const statusRow = card?.querySelector('.status-row');
        const timerDisplay = card?.querySelector('.timer-display');
        const errorBox = card?.querySelector('.inline-error');
        if (!bookId || !jokeId || !card || !statusRow || !timerDisplay || !errorBox) {
          return;
        }
        errorBox.textContent = '';
        const stopper = startTimer(statusRow, timerDisplay);

        const formData = new FormData();
        formData.set('joke_book_id', bookId);
        formData.set('joke_id', jokeId);
        if (targetField === 'book_page_setup_image_url') {
          formData.set('new_book_page_setup_image_url', imageUrl);
        } else {
          formData.set('new_book_page_punchline_image_url', imageUrl);
        }

        fetch(updateBookPageUrl, {
          method: 'POST',
          body: formData,
          mode: 'cors',
        })
          .then((resp) => {
            if (!resp.ok) {
              return resp.text().then((txt) => {
                throw new Error(txt || 'Failed to update image');
              });
            }
            return resp.text();
          })
          .then(() => updateRow(bookId, jokeId))
          .catch((err) => {
            console.error(err);
            errorBox.textContent = err?.message || 'Failed to update image.';
          })
          .finally(() => {
            if (stopper) stopper();
          });
      });

      tile.addEventListener('keydown', (evt) => {
        if (evt.key === 'Enter' || evt.key === ' ') {
          evt.preventDefault();
          tile.click();
        }
      });
    }

    function createUploadButton(bookId, jokeId, targetField) {
      const label = document.createElement('label');
      label.className = 'upload-btn';
      label.title = 'Upload custom image';
      label.textContent = '+';

      const input = document.createElement('input');
      input.type = 'file';
      input.className = 'upload-input';
      input.accept = 'image/*';
      input.dataset.jokeId = jokeId;
      input.dataset.bookId = bookId;
      input.dataset.targetField = targetField;
      
      input.addEventListener('change', handleUpload);
      label.appendChild(input);
      return label;
    }

    function createDeleteButton() {
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'variant-delete';
      button.setAttribute('aria-label', 'Remove image');
      button.textContent = '×';
      attachDeleteListener(button);
      return button;
    }

    function handleUpload(evt) {
      const input = evt.target;
      const file = input.files[0];
      if (!file) return;

      const jokeId = input.dataset.jokeId;
      const bookId = input.dataset.bookId;
      const targetField = input.dataset.targetField;
      const label = input.parentElement;
      
      // UI Loading state
      const originalText = label.childNodes[0].textContent; // The text node '+'
      label.childNodes[0].textContent = '...';
      input.disabled = true;

      const formData = new FormData();
      formData.set('file', file);
      formData.set('joke_id', jokeId);
      formData.set('joke_book_id', bookId);
      formData.set('target_field', targetField);

      fetch('/admin/joke-books/upload-image', {
        method: 'POST',
        body: formData
      })
      .then(resp => {
        if (!resp.ok) return resp.text().then(t => { throw new Error(t) });
        return resp.json();
      })
      .then(() => updateRow(bookId, jokeId))
      .catch(err => {
        console.error('Upload failed:', err);
        alert('Upload failed: ' + err.message);
        label.childNodes[0].textContent = originalText; // Reset on error
      })
      .finally(() => {
        input.disabled = false;
        input.value = ''; // Reset input
      });
    }

    function rebuildVariantTiles(card, bookId, jokeId, targetField, variants, labelPrefix, originalTile) {
      const container = card.querySelector(`.variants[data-target-field="${targetField}"]`);
      if (!container) return;
      container.innerHTML = '';
      if (originalTile && originalTile.imageUrl && originalTile.previewUrl) {
        const originalButton = document.createElement('div');
        originalButton.className = 'variant-tile original-variant';
        originalButton.setAttribute('role', 'button');
        originalButton.setAttribute('tabindex', '0');
        originalButton.dataset.jokeId = jokeId;
        originalButton.dataset.bookId = bookId;
        originalButton.dataset.targetField = targetField;
        originalButton.dataset.imageUrl = originalTile.imageUrl;
        originalButton.dataset.imageOriginal = originalTile.imageUrl;
        const img = document.createElement('img');
        img.src = originalTile.previewUrl;
        img.alt = `${labelPrefix} original image`;
        originalButton.appendChild(createDeleteButton());
        originalButton.appendChild(img);
        attachTileListener(originalButton);
        container.appendChild(originalButton);
      }
      (variants || []).forEach((variant, index) => {
        const imageUrl = typeof variant === 'string'
          ? variant
          : variant?.image_url;
        const thumbUrl = typeof variant === 'string'
          ? variant
          : (variant?.thumb_url || variant?.image_url);
        if (!imageUrl) return;
        const tile = document.createElement('div');
        tile.className = 'variant-tile';
        tile.setAttribute('role', 'button');
        tile.setAttribute('tabindex', '0');
        tile.dataset.jokeId = jokeId;
        tile.dataset.bookId = bookId;
        tile.dataset.targetField = targetField;
        tile.dataset.imageUrl = imageUrl;
        tile.dataset.imageOriginal = imageUrl;
        const img = document.createElement('img');
        img.src = thumbUrl || imageUrl;
        img.alt = `${labelPrefix} option ${index + 1}`;
        tile.appendChild(createDeleteButton());
        tile.appendChild(img);
        attachTileListener(tile);
        container.appendChild(tile);
      });
      // Append upload button
      container.appendChild(createUploadButton(bookId, jokeId, targetField));
    }

    function updateRow(bookId, jokeId) {
      return fetch(
        `/admin/joke-books/${encodeURIComponent(bookId)}/jokes/${encodeURIComponent(jokeId)}/refresh`)
        .then((resp) => {
          if (!resp.ok) throw new Error('Failed to refresh joke');
          return resp.json();
        })
        .then((data) => {
          const card = document.querySelector(`[data-joke-id="${jokeId}"]`);
          if (!card) return data;
          const setupImg = card.querySelector('.setup-img');
          const punchImg = card.querySelector('.punchline-img');
          const setupPh = card.querySelector('.setup-placeholder');
          const punchPh = card.querySelector('.punchline-placeholder');
          const costPill = card.querySelector('.cost-pill-value');

          if (data.setup_image) {
            setupImg.classList.remove('joke-book-detail-hidden');
            setupImg.src = bustCache(data.setup_image);
            setupPh.classList.add('joke-book-detail-hidden');
          } else {
            setupImg.classList.add('joke-book-detail-hidden');
            setupImg.removeAttribute('src');
            setupPh.classList.remove('joke-book-detail-hidden');
          }

          if (data.punchline_image) {
            punchImg.classList.remove('joke-book-detail-hidden');
            punchImg.src = bustCache(data.punchline_image);
            punchPh.classList.add('joke-book-detail-hidden');
          } else {
            punchImg.classList.add('joke-book-detail-hidden');
            punchImg.removeAttribute('src');
            punchPh.classList.remove('joke-book-detail-hidden');
          }

          card.dataset.mainSetupImage = data.setup_original_image_raw || '';
          card.dataset.mainPunchlineImage = data.punchline_original_image_raw || '';

          updateDownloadLink(card, '.setup-download', data.setup_image_download);
          updateDownloadLink(card, '.punchline-download', data.punchline_image_download);

          if (typeof data.total_cost === 'number') {
            costPill.textContent = `$${data.total_cost.toFixed(4)}`;
            costPill.classList.remove('muted');
          } else {
            costPill.textContent = 'Cost unavailable';
            costPill.classList.add('muted');
          }

          rebuildVariantTiles(
            card,
            bookId,
            jokeId,
            'book_page_setup_image_url',
            Array.isArray(data.setup_variants) ? data.setup_variants : [],
            'Setup options',
            {
              imageUrl: data.setup_original_image_raw || data.setup_original_image || '',
              previewUrl: data.setup_original_preview || data.setup_original_image || '',
            },
          );
          rebuildVariantTiles(
            card,
            bookId,
            jokeId,
            'book_page_punchline_image_url',
            Array.isArray(data.punchline_variants) ? data.punchline_variants : [],
            'Punchline options',
            {
              imageUrl: data.punchline_original_image_raw || data.punchline_original_image || '',
              previewUrl: data.punchline_original_preview || data.punchline_original_image || '',
            },
          );

          const tiles = card.querySelectorAll('.variant-tile');
          tiles.forEach((tile) => {
            const url = tile.dataset.imageUrl;
            const isSetup = tile.dataset.targetField === 'book_page_setup_image_url';
            const current = isSetup ? data.setup_image : data.punchline_image;
            applyTileHighlight(
              tile,
              current && url && normalizeUrl(current) === normalizeUrl(url),
            );
          });
          updateDeleteStateForCard(card);

          const metricDefaults = {
            num_views: 0,
            num_saves: 0,
            num_shares: 0,
            popularity_score: 0,
            num_saved_users_fraction: 0,
          };
          Object.entries(metricDefaults).forEach(([key, defaultValue]) => {
            const el = card.querySelector(`[data-metric="${key}"]`);
            if (!el) return;
            const raw = data[key];
            const value = typeof raw === 'number' ? raw : defaultValue;
            if (key === 'popularity_score') {
              el.textContent = value.toFixed(3);
            } else if (key === 'num_saved_users_fraction') {
              el.textContent = value.toFixed(2);
            } else {
              el.textContent = Math.trunc(value);
            }
          });
          return data;
        });
    }

    setupZipRegenerator();

    forms.forEach((form) => {
      const revealBtn = form.querySelector('.reveal-btn');
      const submitBtn = form.querySelector('.submit-btn');
      const instructions = form.querySelector('.instructions');
      const statusRow = form.querySelector('.status-row');
      const timerDisplay = form.querySelector('.timer-display');
      const errorBox = form.querySelector('.inline-error');
      let timerStopper = null;

      revealBtn.addEventListener('click', () => {
      instructions.classList.remove('joke-book-detail-hidden');
      submitBtn.classList.remove('joke-book-detail-hidden');
      revealBtn.classList.add('joke-book-detail-hidden');
      const firstField = instructions.querySelector('textarea');
      if (firstField) firstField.focus();
    });

      // Attach style_update logic to toggle include_text
      const styleUpdateCb = form.querySelector('input[name="style_update"]');
      const includeTextCb = form.querySelector('input[name="include_text"]');
      if (styleUpdateCb && includeTextCb) {
        styleUpdateCb.addEventListener('change', () => {
          if (styleUpdateCb.checked) {
            includeTextCb.checked = false;
            includeTextCb.disabled = true;
          } else {
            includeTextCb.checked = true;
            includeTextCb.disabled = false;
          }
        });
      }

      form.addEventListener('submit', (evt) => {
        evt.preventDefault();
        const jokeId = form.dataset.jokeId;
        const bookId = form.dataset.bookId;
        const formData = new FormData(form);

        // Explicitly set include_text because unchecked checkboxes are not sent
        if (includeTextCb) {
          formData.set('include_text', includeTextCb.checked ? 'true' : 'false');
        }

        formData.set('joke_id', jokeId);
        const original = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Regenerating...';
        errorBox.textContent = '';
        timerStopper = startTimer(statusRow, timerDisplay);
        const runRefresh = () => updateRow(bookId, jokeId).catch((err) => {
          console.error(err);
          errorBox.textContent = 'Regenerated, but failed to refresh images.';
        });

        fetch(form.action, {
          method: 'POST',
          body: formData,
          mode: 'cors',
        })
          .then((resp) => {
            if (!resp.ok) {
              return resp.text().then((txt) => {
                throw new Error(txt || 'Regeneration failed');
              });
            }
            return resp.text();
          })
          .then(() => runRefresh())
          .catch((err) => {
            console.error(err);
            // Even if fetch failed (CORS/network), still try to refresh assuming backend ran.
            errorBox.textContent = err?.message || 'Failed to regenerate pages.';
            return runRefresh();
          })
          .finally(() => {
            if (timerStopper) timerStopper();
            submitBtn.disabled = false;
            submitBtn.textContent = original;
          });
      });
    });

    document.querySelectorAll('.set-main-link')
      .forEach((link) => attachSetMainListener(link));

    document.querySelectorAll('.variant-delete')
      .forEach((button) => attachDeleteListener(button));

    document.querySelectorAll('.variant-tile')
      .forEach((tile) => attachTileListener(tile));

    document.querySelectorAll('.upload-input')
      .forEach((input) => input.addEventListener('change', handleUpload));

    // Initial highlight on load
    document.querySelectorAll('.joke-book-detail-card').forEach((card) => {
      const tiles = card.querySelectorAll('.variant-tile');
      const setupImg = card.querySelector('.setup-img')?.getAttribute('src') || '';
      const punchImg = card.querySelector('.punchline-img')?.getAttribute('src') || '';
      tiles.forEach((tile) => {
        const url = tile.dataset.imageUrl;
        const isSetup = tile.dataset.targetField === 'book_page_setup_image_url';
        const current = isSetup ? setupImg : punchImg;
        applyTileHighlight(
          tile,
          current && url && normalizeUrl(current) === normalizeUrl(url),
        );
      });
      updateDeleteStateForCard(card);
    });

    // --- New Functionality: Search, Add, Remove, Reorder ---

    const searchInput = document.getElementById('joke-search-input');
    const searchCategoryCheckbox = document.getElementById('joke-search-category-checkbox');
    const searchBtn = document.getElementById('joke-search-btn');
    const searchResults = document.getElementById('search-results');
    const addSelectedBtn = document.getElementById('add-selected-btn');
    let selectedJokeIds = new Set();

    if (searchBtn && searchInput) {
      if (searchCategoryCheckbox) {
        searchCategoryCheckbox.addEventListener('change', () => {
          searchInput.placeholder = searchCategoryCheckbox.checked
            ? 'Enter category ID...'
            : 'Search for jokes to add...';
        });
      }

      const performSearch = async () => {
        const query = searchInput.value.trim();
        if (!query) return;

        searchBtn.disabled = true;
        searchBtn.textContent = 'Searching...';
        searchResults.innerHTML = '';
        selectedJokeIds.clear();
        updateAddButton();

        // Collect existing joke IDs from the DOM
        const existingJokeIds = new Set();
        document.querySelectorAll('[data-joke-id]').forEach(el => {
          if(el.dataset.jokeId) existingJokeIds.add(el.dataset.jokeId);
        });

        try {
          const searchUrl = functionsOrigin
            ? `${functionsOrigin}/search_jokes`
            : '/search_jokes';

          // Construct URL with query params
          const url = new URL(searchUrl, window.location.origin);
          if (searchCategoryCheckbox && searchCategoryCheckbox.checked) {
            url.searchParams.append('category', query);
          } else {
            url.searchParams.append('search_query', query);
          }
          url.searchParams.append('max_results', '50');
          url.searchParams.append('match_mode', 'loose');
          url.searchParams.append('return_jokes', 'true');
          url.searchParams.append('public_only', 'false');
          url.searchParams.append('exclude_in_book', 'true');

          const resp = await fetch(url.toString());

          if (!resp.ok) throw new Error('Search failed');
          const payload = await resp.json();
          const data = payload.data || {};
          const jokes = data.jokes || [];

          if (jokes.length === 0) {
            searchResults.innerHTML = '<p class="text-body muted" style="grid-column: 1/-1; text-align: center;">No matching jokes found (or all already in book).</p>';
            return;
          }

          jokes.forEach(item => { // Show top 10 new candidates
            const card = document.createElement('div');
            card.className = 'search-result-card';

            let thumbUrl = item.setup_image_url || '';
            if (thumbUrl && thumbUrl.includes('images.quillsstorybook.com')) {
               thumbUrl = normalizeUrl(thumbUrl); // remove existing params
               thumbUrl = `https://images.quillsstorybook.com/cdn-cgi/image/width=200,quality=70,format=auto/${thumbUrl}`;
            }

            card.innerHTML = `
              <img src="${thumbUrl}" class="search-result-img" alt="Joke Setup" loading="lazy">
              <div class="search-result-meta text-body">
                <code>${item.joke_id}</code>
              </div>
            `;

            card.onclick = () => toggleSelection(card, item.joke_id);
            searchResults.appendChild(card);
          });

        } catch (err) {
          console.error(err);
          alert('Failed to search jokes');
        } finally {
          searchBtn.disabled = false;
          searchBtn.textContent = 'Search';
        }
      };

      searchBtn.addEventListener('click', performSearch);
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') performSearch();
      });
    }

    function toggleSelection(card, jokeId) {
      if (selectedJokeIds.has(jokeId)) {
        selectedJokeIds.delete(jokeId);
        // Revert to CSS default
        card.style.border = '';
      } else {
        selectedJokeIds.add(jokeId);
        // Use the active border style defined globally
        card.style.border = activeVariantBorder;
      }
      updateAddButton();
    }

    function updateAddButton() {
      if (addSelectedBtn) {
        addSelectedBtn.disabled = selectedJokeIds.size === 0;
        addSelectedBtn.textContent = selectedJokeIds.size > 0
          ? `Add ${selectedJokeIds.size} Selected`
          : 'Add Selected';
      }
    }

    if (addSelectedBtn) {
      addSelectedBtn.addEventListener('click', async () => {
        if (selectedJokeIds.size === 0) return;

        const originalText = addSelectedBtn.textContent;
        addSelectedBtn.textContent = 'Adding...';
        addSelectedBtn.disabled = true;

        try {
          const resp = await fetch(`/admin/joke-books/${encodeURIComponent(bookId)}/jokes/add`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ joke_ids: Array.from(selectedJokeIds) }),
          });
          if (!resp.ok) throw new Error('Add failed');
          window.location.reload();
        } catch (err) {
          console.error(err);
          alert('Failed to add jokes: ' + err.message);
          addSelectedBtn.textContent = originalText;
          addSelectedBtn.disabled = false;
        }
      });
    }

    function reindexJokes() {
      const cards = document.querySelectorAll('.joke-book-detail-card');
      const total = cards.length;

      cards.forEach((card, index) => {
        const sequence = index + 1;

        // Update header label
        const headerStrong = card.querySelector('.joke-book-detail-header strong');
        if (headerStrong) headerStrong.textContent = `Joke ${sequence}`;

        // Update dropdown
        const select = card.querySelector('.position-select');
        if (select) {
          // Clear and rebuild options
          select.innerHTML = '';
          for (let i = 1; i <= total; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            if (i === sequence) option.selected = true;
            select.appendChild(option);
          }
        }
      });
    }

    document.querySelectorAll('.remove-joke-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('Are you sure you want to remove this joke?')) return;

        const jokeId = btn.dataset.jokeId;
        const originalText = btn.textContent;
        const card = btn.closest('.joke-book-detail-card');

        btn.textContent = '...';
        btn.disabled = true;

        try {
          const resp = await fetch(`/admin/joke-books/${encodeURIComponent(bookId)}/jokes/${encodeURIComponent(jokeId)}/remove`, {
            method: 'POST',
          });
          if (!resp.ok) throw new Error('Remove failed');

          // Remove from DOM and reindex
          if (card) {
            card.remove();
            reindexJokes();
          } else {
             window.location.reload(); // Fallback
          }

        } catch (err) {
          console.error(err);
          alert('Failed to remove joke');
          btn.textContent = originalText;
          btn.disabled = false;
        }
      });
    });

    document.querySelectorAll('.position-select').forEach(select => {
      select.addEventListener('change', async (e) => {
        const jokeId = select.dataset.jokeId;
        const newPosition = parseInt(select.value);
        const card = select.closest('.joke-book-detail-card');
        const container = document.querySelector('.joke-book-detail-grid');

        select.disabled = true;

        try {
          const resp = await fetch(`/admin/joke-books/${encodeURIComponent(bookId)}/jokes/${encodeURIComponent(jokeId)}/reorder`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ new_position: newPosition }),
          });
          if (!resp.ok) throw new Error('Reorder failed');

          // Move in DOM
          if (card && container) {
            const currentPosition = Array.from(container.children).indexOf(card) + 1;

            if (newPosition !== currentPosition) {
              // If moving down (e.g. 1 -> 3), we insertBefore the element *after* the target index
              // If moving up (e.g. 3 -> 1), we insertBefore the target index
              // Actually, simplified: newPosition is 1-based target.
              // DOM index is newPosition - 1.

              const targetIndex = newPosition - 1;
              const allCards = Array.from(container.children);

              // Remove first to avoid index confusion? Or just move?
              // `insertBefore` moves if node is already in tree.

              if (targetIndex >= allCards.length) {
                container.appendChild(card);
              } else {
                // If moving down, we need to account for the fact that removing it shifts indices.
                // But insertBefore handles this reference node logic.
                // If we want it to BE at targetIndex, we insert before the node currently at targetIndex,
                // UNLESS we are moving down past it?
                // Actually, if we move item from 0 to 2.
                // List: [A, B, C, D]. Move A to pos 3 (index 2, which is C).
                // insertBefore(A, D). Result: [B, C, A, D]. Correct.
                // So we want to insert before the item at `targetIndex` if moving up?
                // If moving down, we want it to be at `targetIndex`.
                // Let's use `insertBefore` relative to the current state of list (excluding self potentially?)

                // Simpler: get list of other cards. Insert into that list. Re-append all.
                // Or:
                const otherCards = Array.from(container.querySelectorAll('.joke-book-detail-card')).filter(c => c !== card);
                // Insert card into otherCards at proper index
                // Clamp index
                const safeIndex = Math.max(0, Math.min(targetIndex, otherCards.length));

                if (safeIndex === otherCards.length) {
                   container.appendChild(card);
                } else {
                   container.insertBefore(card, otherCards[safeIndex]);
                }
              }
              reindexJokes();
            }
          }

        } catch (err) {
          console.error(err);
          alert('Failed to reorder joke');
          // Revert selection?
        } finally {
          select.disabled = false;
        }
      });
    });

  })();
</script>
{% endblock %}
