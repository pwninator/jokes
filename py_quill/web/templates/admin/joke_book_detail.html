{% extends "admin/base.html" %}

{% block title %}{{ book.book_name }} · Joke Book · {{ site_name }} Admin{% endblock %}

{% block head_extra %}
<style>
  .search-section {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 20px;
    padding: 16px;
    margin-bottom: 24px;
    box-shadow: 0 4px 12px rgba(196, 171, 140, 0.1);
  }

  .search-controls {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
  }

  .search-input {
    flex: 1;
    padding: 8px 16px;
    border: 1px solid var(--color-border);
    border-radius: 999px;
    font-size: 16px;
    font-family: inherit;
  }

  .search-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 16px;
  }

  .search-result-card {
    border: 1px solid var(--color-border);
    border-radius: 12px;
    overflow: hidden;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    background: var(--color-surface);
  }

  .search-result-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: var(--color-primary);
  }

  .search-result-img {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
    display: block;
  }

  .search-result-meta {
    padding: 8px;
    font-size: 12px;
    color: var(--color-muted);
    text-align: center;
  }

  .page-actions {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
  }

  .zip-action-group {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .joke-grid {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .joke-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 20px;
    padding: 16px;
    box-shadow: 0 12px 30px rgba(196, 171, 140, 0.18);
  }

  .joke-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    justify-content: space-between;
  }

  .joke-meta {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .position-select {
    padding: 4px 8px;
    border-radius: 6px;
    border: 1px solid var(--color-border);
    background: var(--color-surface);
    font-family: inherit;
    font-size: 14px;
    cursor: pointer;
  }

  .remove-joke-btn {
    background: transparent;
    border: 1px solid var(--color-border);
    color: #ef5350;
    padding: 6px 12px;
    border-radius: 999px;
    cursor: pointer;
    font-size: 13px;
    margin-left: 8px;
  }

  .remove-joke-btn:hover {
    background: #ffebee;
    border-color: #ef5350;
  }

  .joke-metrics {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 8px;
  }

  .metric-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 999px;
    background: var(--color-pill-bg);
    border: 1px solid var(--color-border);
    font-variant-numeric: tabular-nums;
  }

  .metric-label {
    color: var(--color-muted);
    font-size: 12px;
  }

  .metric-value {
    font-weight: 600;
  }

  .joke-images {
    display: grid;
    grid-template-columns: repeat(2, minmax(400px, 1fr));
    gap: 24px;
    align-items: start;
  }

  .image-frame {
    background: var(--color-accent-surface);
    border: 1px solid var(--color-border);
    border-radius: 16px;
    min-height: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px;
  }

  .image-frame img,
  .image-frame .placeholder {
    width: 100%;
    max-width: 800px;
    height: auto;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    border-radius: 12px;
  }

  .image-actions {
    align-self: flex-start;
    margin-top: 4px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .download-link {
    color: var(--color-primary);
    text-decoration: none;
  }

  .download-link:hover {
    text-decoration: underline;
  }

  .placeholder {
    background: repeating-linear-gradient(
      45deg,
      rgba(212, 160, 23, 0.08),
      rgba(212, 160, 23, 0.08) 12px,
      rgba(212, 160, 23, 0.15) 12px,
      rgba(212, 160, 23, 0.15) 24px
    );
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
  }

  .back-link {
    text-decoration: none;
  }

  .back-link:hover {
    text-decoration: underline;
  }

  .joke-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto;
  }

  .cta-btn {
    background: var(--color-primary);
    border: none;
    padding: 8px 14px;
    border-radius: 999px;
    cursor: pointer;
  }

  .cta-btn:hover {
    opacity: 0.9;
  }

  .cta-btn[disabled],
  .cta-btn[disabled]:hover {
    background: rgba(74, 59, 50, 0.2);
    cursor: default;
    opacity: 1;
  }

  .cost-pill {
    background: var(--color-pill-bg);
    border-radius: 999px;
    padding: 6px 12px;
  }

  .hidden {
    display: none !important;
  }

  .instructions {
    margin-top: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .instructions textarea {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    padding: 10px;
    min-height: 64px;
    resize: vertical;
  }

  .status-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 0;
  }

  .timer-chip {
    background: var(--color-pill-bg);
    border-radius: 999px;
    padding: 4px 10px;
  }

  .variant-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    grid-auto-rows: auto;
    grid-auto-flow: dense;
    gap: 8px;
    width: 100%;
    max-width: 800px;
    align-self: stretch;
    justify-content: start;
  }

  .variants {
    display: contents;
    margin-bottom: 12px;
    flex: 1 1 0%;
  }

  .variant-tile {
    width: 100%;
    min-width: 100px;
    min-height: 0;
    aspect-ratio: 1 / 1;
    box-sizing: border-box;
    border: 2px solid rgba(212, 160, 23, 0.25);
    background: var(--color-accent-surface);
    border-radius: 10px;
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .variant-tile.original-variant {
    grid-column: span 2;
    grid-row: span 2;
  }

  .variant-tile img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
  }

  .variant-label {
    margin-bottom: 6px;
  }


  .regenerate-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
    margin-top: 0;
  }

  .regenerate-footer {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 12px;
  }

  .regenerate-footer .status-row {
    margin-top: 0;
  }

  @media (max-width: 1100px) {
    .joke-images {
      grid-template-columns: 1fr;
    }

    .image-frame {
      width: 100%;
    }

    .instructions-row {
      grid-template-columns: 1fr;
    }
  }

  .upload-btn {
    width: 100%;
    height: 100%;
    min-width: 100px;
    min-height: 0;
    aspect-ratio: 1 / 1;
    box-sizing: border-box;
    border: 2px dashed rgba(212, 160, 23, 0.4);
    background: rgba(212, 160, 23, 0.05);
    border-radius: 10px;
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-primary);
    font-size: 24px;
    transition: all 0.2s ease;
  }

  .upload-btn:hover {
    background: rgba(212, 160, 23, 0.15);
    border-color: var(--color-primary);
  }

  .upload-input {
    display: none;
  }
</style>
{% endblock %}
{% macro render_variants(variants, label, target_field, joke_id, book_id, original_image=None, original_preview=None) -%}
  <div class="variant-group">
    <div class="variant-label text-button">{{ label }}</div>
    <div class="variant-row">
      <div class="variants" data-target-field="{{ target_field }}">
        {% set original_url = original_image or original_preview %}
        {% set original_src = original_preview or original_image %}
        {% if original_url and original_src %}
        <button class="variant-tile original-variant"
          type="button"
          data-joke-id="{{ joke_id }}"
          data-book-id="{{ book_id }}"
          data-target-field="{{ target_field }}"
          data-image-url="{{ original_url }}">
          <img src="{{ original_src }}" alt="Original image option">
        </button>
        {% endif %}
        {% if variants %}
          {% for variant in variants %}
          <button class="variant-tile"
            type="button"
            data-joke-id="{{ joke_id }}"
            data-book-id="{{ book_id }}"
            data-target-field="{{ target_field }}"
            data-image-url="{{ variant }}">
            <img src="{{ variant }}" alt="{{ label }} option {{ loop.index }}">
          </button>
          {% endfor %}
        {% endif %}
        <label class="upload-btn" title="Upload custom image">
          +
          <input type="file" 
            class="upload-input" 
            accept="image/*"
            data-joke-id="{{ joke_id }}"
            data-book-id="{{ book_id }}"
            data-target-field="{{ target_field }}">
        </label>
      </div>
    </div>
  </div>
{%- endmacro %}

{% block content %}
<div class="page-actions">
  <a class="back-link site-footer__link text-button" href="{{ url_for('web.admin_joke_books') }}">← Back to joke books</a>
  <div class="zip-action-group">
    {% if book.zip_url %}
    <a class="back-link site-footer__link text-button download-zip-link" href="{{ book.zip_url }}" target="_blank" rel="noopener noreferrer">Download all pages (ZIP)</a>
    {% else %}
    <span class="muted download-zip-missing">ZIP not generated</span>
    {% endif %}
    <button
      class="cta-btn nav-cta text-button book-zip-regenerate"
      type="button"
      data-book-id="{{ book.id }}">
      {% if book.zip_url %}Regenerate ZIP{% else %}Generate ZIP{% endif %}
    </button>
  </div>
</div>

<h2 class="text-section-heading">
  {{ book.book_name }}
  {% if book_total_cost is not none %}
  <span class="cost-pill text-button">${{ '%.4f'|format(book_total_cost) }}</span>
  {% endif %}
</h2>
<p class="muted"><code>{{ book.id }}</code></p>

<section class="search-section">
  <div class="search-controls">
    <input type="text" class="search-input" placeholder="Search for jokes to add..." id="joke-search-input">
    <div style="display: flex; align-items: center; gap: 8px;">
      <input type="checkbox" id="joke-search-category-checkbox" style="width: 20px; height: 20px;">
      <label for="joke-search-category-checkbox" class="text-body">Category</label>
    </div>
    <button class="cta-btn text-button" type="button" id="joke-search-btn">Search</button>
  </div>
  <div class="search-grid" id="search-results"></div>
  <div style="display: flex; justify-content: flex-end; margin-top: 16px;">
    <button class="cta-btn text-button" type="button" id="add-selected-btn" disabled>Add Selected</button>
  </div>
</section>

{% if not jokes %}
<p class="muted">No jokes found for this book.</p>
{% else %}
<div class="joke-grid">
  {% for joke in jokes %}
  <article class="joke-card" data-joke-id="{{ joke.id }}">
    <form method="post"
      class="regenerate-form"
      data-joke-id="{{ joke.id }}"
      data-book-id="{{ book.id }}"
      action="{{ generate_book_page_url }}"
      target="_blank">
      <input type="hidden" name="joke_id" value="{{ joke.id }}">
      <div class="joke-header text-body">
        <div class="joke-meta text-body">
          <select class="position-select" data-joke-id="{{ joke.id }}" aria-label="Joke position">
            {% for i in range(1, jokes|length + 1) %}
            <option value="{{ i }}" {% if i == joke.sequence %}selected{% endif %}>{{ i }}</option>
            {% endfor %}
          </select>
          <strong>Joke {{ joke.sequence }}</strong>
          <code>{{ joke.id }}</code>
          {% if joke.total_cost is not none %}
          <span class="cost-pill cost-pill-value text-button">${{ '%.4f'|format(joke.total_cost) }}</span>
          {% else %}
          <span class="cost-pill cost-pill-value text-button muted">Cost unavailable</span>
          {% endif %}
          <button class="remove-joke-btn text-button" type="button" data-joke-id="{{ joke.id }}">Remove</button>
        </div>
        <button class="cta-btn nav-cta text-button reveal-btn" type="button">Regenerate pages</button>
      </div>
      <div class="joke-metrics text-button">
        <div class="metric-pill">
          <span class="metric-label">Views</span>
          <span class="metric-value" data-metric="num_views">{{ joke.num_views }}</span>
        </div>
        <div class="metric-pill">
          <span class="metric-label">Saves</span>
          <span class="metric-value" data-metric="num_saves">{{ joke.num_saves }}</span>
        </div>
        <div class="metric-pill">
          <span class="metric-label">Shares</span>
          <span class="metric-value" data-metric="num_shares">{{ joke.num_shares }}</span>
        </div>
        <div class="metric-pill">
          <span class="metric-label">Popularity</span>
          <span class="metric-value" data-metric="popularity_score">{{ '%.3f'|format(joke.popularity_score or 0) }}</span>
        </div>
        <div class="metric-pill">
          <span class="metric-label">Save %</span>
          <span class="metric-value" data-metric="num_saved_users_fraction">{{ '%.2f'|format(joke.num_saved_users_fraction or 0) }}</span>
        </div>
      </div>
      <div class="instructions instructions-row hidden">
        <div class="text-body source-toggle">
          <div class="text-button">Regenerate from</div>
          <label class="text-body">
            <input type="radio" name="base_image_source" value="original" checked>
            Original joke images
          </label>
          <label class="text-body">
            <input type="radio" name="base_image_source" value="book_page">
            Current book page images
          </label>
          <label class="text-body">
            <input type="checkbox" name="style_update" value="true">
            Style Update
          </label>
        </div>
        <div>
          <label class="text-button" for="setup-{{ joke.id }}">Setup instructions (optional)</label>
          <textarea id="setup-{{ joke.id }}" name="setup_instructions" placeholder="Extra guidance for the setup image"></textarea>
        </div>
        <div>
          <label class="text-button" for="punch-{{ joke.id }}">Punchline instructions (optional)</label>
          <textarea id="punch-{{ joke.id }}" name="punchline_instructions" placeholder="Extra guidance for the punchline image"></textarea>
        </div>
      </div>
      <div class="regenerate-footer">
        <div class="status-row hidden">
          <span class="timer-chip timer-display text-button">0:00</span>
          <span class="inline-error form-error text-button"></span>
        </div>
        <button class="cta-btn nav-cta text-button submit-btn hidden" type="submit">Submit</button>
      </div>
    </form>
    <div class="joke-images">
      <div class="image-column">
        {{ render_variants(
            joke.setup_variants,
            "Setup options",
            "book_page_setup_image_url",
            joke.id,
            book.id,
            original_image=joke.setup_original_image,
            original_preview=joke.setup_preview) }}
        <div class="image-frame">
          <img class="joke-image setup-img {% if not joke.setup_image %}hidden{% endif %}"
            src="{{ joke.setup_image or '' }}" alt="Setup image for {{ joke.id }}" width="800" height="800" loading="lazy">
          <div class="placeholder text-body text-button setup-placeholder {% if joke.setup_image %}hidden{% endif %}" role="img"
            aria-label="Setup image missing">No setup image</div>
        </div>
        <div class="image-actions setup-download {% if not joke.setup_image_download %}hidden{% endif %}">
          <a class="download-link text-button"
            href="{{ joke.setup_image_download or '' }}"
            target="_blank"
            rel="noopener noreferrer">
            Download
          </a>
          <a class="download-link text-button set-main-link"
            href="#"
            data-target="setup"
            data-joke-id="{{ joke.id }}">
            Set as main joke image
          </a>
        </div>
      </div>
      <div class="image-column">
        {{ render_variants(
            joke.punchline_variants,
            "Punchline options",
            "book_page_punchline_image_url",
            joke.id,
            book.id,
            original_image=joke.punchline_original_image,
            original_preview=joke.punchline_preview) }}
        <div class="image-frame">
          <img class="joke-image punchline-img {% if not joke.punchline_image %}hidden{% endif %}"
            src="{{ joke.punchline_image or '' }}" alt="Punchline image for {{ joke.id }}" width="800" height="800"
            loading="lazy">
          <div class="placeholder text-body text-button punchline-placeholder {% if joke.punchline_image %}hidden{% endif %}" role="img"
            aria-label="No punchline image">No punchline image</div>
        </div>
        <div class="image-actions punchline-download {% if not joke.punchline_image_download %}hidden{% endif %}">
          <a class="download-link text-button"
            href="{{ joke.punchline_image_download or '' }}"
            target="_blank"
            rel="noopener noreferrer">
            Download
          </a>
          <a class="download-link text-button set-main-link"
            href="#"
            data-target="punchline"
            data-joke-id="{{ joke.id }}">
            Set as main joke image
          </a>
        </div>
      </div>
    </div>
  </article>
  {% endfor %}
</div>
{% endif %}

<script>
  (function () {
    const bookId = {{ book.id | tojson }};
    const forms = Array.from(document.querySelectorAll('.regenerate-form'));
    const updateBookPageUrl = "{{ update_book_page_url }}";
    const setMainImageUrl = {{ set_main_image_url | tojson }};
    const functionsOrigin = {{ functions_origin | tojson }};
    const regenerateZipEndpoint = functionsOrigin
      ? `${functionsOrigin}/update_joke_book_zip`
      : '/update_joke_book_zip';
    const activeColor = getComputedStyle(document.documentElement)
      .getPropertyValue('--color-primary-dark')
      .trim() || '#ff0000';
    const inactiveColor = getComputedStyle(document.documentElement)
      .getPropertyValue('--color-surface')
      .trim() || '#ffffff';
    const activeVariantBorder = `3px solid ${activeColor}`;
    const inactiveVariantBorder = `3px solid ${inactiveColor}`;
    const bustCache = (url) => {
      if (!url) return '';
      const sep = url.includes('?') ? '&' : '?';
      return `${url}${sep}t=${Date.now()}`;
    };
    const normalizeUrl = (url) => {
      if (!url) return '';
      const noQuery = url.replace(/\?.*$/, '');
      const prefix = "https://images.quillsstorybook.com/cdn-cgi/image/";
      if (!noQuery.startsWith(prefix)) return noQuery;
      const remainder = noQuery.slice(prefix.length);
      const slashIndex = remainder.indexOf('/');
      if (slashIndex === -1) return noQuery;
      return remainder.slice(slashIndex + 1);
    };

    const updateDownloadLink = (card, selector, url) => {
      const container = card.querySelector(selector);
      const link = container?.querySelector('a');
      if (!container || !link) return;
      if (url) {
        link.href = url;
        container.classList.remove('hidden');
      } else {
        link.removeAttribute('href');
        container.classList.add('hidden');
      }
    };

    const applyTileHighlight = (tile, isActive) => {
      tile.style.border = isActive ? activeVariantBorder : inactiveVariantBorder;
    };

    const setupZipRegenerator = () => {
      const button = document.querySelector('.book-zip-regenerate');
      const container = button?.closest('.zip-action-group');
      if (!button || !container) return;
      const bookId = button.dataset.bookId;
      if (!bookId) return;

      button.addEventListener('click', async () => {
        const originalLabel = button.textContent;
        button.disabled = true;
        button.textContent = 'Regenerating...';
        try {
          const resp = await fetch(regenerateZipEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: { joke_book_id: bookId } }),
          });

          if (!resp.ok) {
            const text = await resp.text();
            throw new Error(`Request failed (${resp.status}): ${text}`);
          }

          const payload = await resp.json();
          const newUrl = payload?.data?.zip_url;
          if (!newUrl) {
            throw new Error('zip_url missing from response');
          }

          let link = container.querySelector('.download-zip-link');
          if (!link) {
            link = document.createElement('a');
            link.className =
              'back-link site-footer__link text-button download-zip-link';
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            link.textContent = 'Download all pages (ZIP)';
            container.insertBefore(link, button);
          }
          link.href = newUrl;

          const missingLabel = container.querySelector('.download-zip-missing');
          if (missingLabel) {
            missingLabel.remove();
          }

          button.textContent = 'Regenerate ZIP';
        } catch (error) {
          console.error('Failed to regenerate ZIP', error);
          alert(error?.message || 'Failed to regenerate ZIP');
          button.textContent = originalLabel;
        } finally {
          button.disabled = false;
        }
      });
    };

    const startTimer = (statusRow, timerDisplay) => {
      statusRow.classList.remove('hidden');
      const start = Date.now();
      const renderTime = () => {
        const elapsed = Math.floor((Date.now() - start) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = String(elapsed % 60).padStart(2, '0');
        timerDisplay.textContent = `${minutes}:${seconds}`;
      };
      renderTime();
      const id = window.setInterval(renderTime, 1000);
      return () => window.clearInterval(id);
    };

    const setLinkLoadingState = (link, isLoading) => {
      if (!link) return;
      if (isLoading) {
        link.dataset.originalText = link.textContent;
        link.textContent = 'Setting...';
        link.dataset.loading = 'true';
        link.style.pointerEvents = 'none';
      } else {
        const original = link.dataset.originalText;
        if (original) {
          link.textContent = original;
        }
        link.dataset.loading = 'false';
        link.style.pointerEvents = '';
      }
    };

    function attachSetMainListener(link) {
      if (!link) return;
      link.addEventListener('click', (evt) => {
        evt.preventDefault();
        if (link.dataset.loading === 'true') return;
        const jokeId = link.dataset.jokeId;
        const target = link.dataset.target;
        const card = link.closest('.joke-card');
        const statusRow = card?.querySelector('.status-row');
        const timerDisplay = card?.querySelector('.timer-display');
        const errorBox = card?.querySelector('.inline-error');
        if (!jokeId || !target || !card || !statusRow || !timerDisplay || !errorBox) {
          return;
        }
        errorBox.textContent = '';
        const stopper = startTimer(statusRow, timerDisplay);
        setLinkLoadingState(link, true);

        const formData = new FormData();
        formData.set('joke_book_id', bookId);
        formData.set('joke_id', jokeId);
        formData.set('target', target);

        fetch(setMainImageUrl, {
          method: 'POST',
          body: formData,
          mode: 'cors',
        })
          .then((resp) => {
            if (!resp.ok) {
              return resp.text().then((txt) => {
                throw new Error(txt || 'Failed to set main image');
              });
            }
            return resp.json();
          })
          .then(() => updateRow(bookId, jokeId))
          .catch((err) => {
            console.error(err);
            errorBox.textContent = err?.message || 'Failed to set main image.';
          })
          .finally(() => {
            if (stopper) stopper();
            setLinkLoadingState(link, false);
          });
      });
    }

    function attachTileListener(tile) {
      tile.addEventListener('click', () => {
        const bookId = tile.dataset.bookId;
        const jokeId = tile.dataset.jokeId;
        const targetField = tile.dataset.targetField;
        const imageUrl = tile.dataset.imageUrl;
        const card = tile.closest('.joke-card');
        const statusRow = card?.querySelector('.status-row');
        const timerDisplay = card?.querySelector('.timer-display');
        const errorBox = card?.querySelector('.inline-error');
        if (!bookId || !jokeId || !card || !statusRow || !timerDisplay || !errorBox) {
          return;
        }
        errorBox.textContent = '';
        const stopper = startTimer(statusRow, timerDisplay);

        const formData = new FormData();
        formData.set('joke_book_id', bookId);
        formData.set('joke_id', jokeId);
        if (targetField === 'book_page_setup_image_url') {
          formData.set('new_book_page_setup_image_url', imageUrl);
        } else {
          formData.set('new_book_page_punchline_image_url', imageUrl);
        }

        fetch(updateBookPageUrl, {
          method: 'POST',
          body: formData,
          mode: 'cors',
        })
          .then((resp) => {
            if (!resp.ok) {
              return resp.text().then((txt) => {
                throw new Error(txt || 'Failed to update image');
              });
            }
            return resp.text();
          })
          .then(() => updateRow(bookId, jokeId))
          .catch((err) => {
            console.error(err);
            errorBox.textContent = err?.message || 'Failed to update image.';
          })
          .finally(() => {
            if (stopper) stopper();
          });
      });
    }

    function createUploadButton(bookId, jokeId, targetField) {
      const label = document.createElement('label');
      label.className = 'upload-btn';
      label.title = 'Upload custom image';
      label.textContent = '+';

      const input = document.createElement('input');
      input.type = 'file';
      input.className = 'upload-input';
      input.accept = 'image/*';
      input.dataset.jokeId = jokeId;
      input.dataset.bookId = bookId;
      input.dataset.targetField = targetField;
      
      input.addEventListener('change', handleUpload);
      label.appendChild(input);
      return label;
    }

    function handleUpload(evt) {
      const input = evt.target;
      const file = input.files[0];
      if (!file) return;

      const jokeId = input.dataset.jokeId;
      const bookId = input.dataset.bookId;
      const targetField = input.dataset.targetField;
      const label = input.parentElement;
      
      // UI Loading state
      const originalText = label.childNodes[0].textContent; // The text node '+'
      label.childNodes[0].textContent = '...';
      input.disabled = true;

      const formData = new FormData();
      formData.set('file', file);
      formData.set('joke_id', jokeId);
      formData.set('joke_book_id', bookId);
      formData.set('target_field', targetField);

      fetch('/admin/joke-books/upload-image', {
        method: 'POST',
        body: formData
      })
      .then(resp => {
        if (!resp.ok) return resp.text().then(t => { throw new Error(t) });
        return resp.json();
      })
      .then(() => updateRow(bookId, jokeId))
      .catch(err => {
        console.error('Upload failed:', err);
        alert('Upload failed: ' + err.message);
        label.childNodes[0].textContent = originalText; // Reset on error
      })
      .finally(() => {
        input.disabled = false;
        input.value = ''; // Reset input
      });
    }

    function rebuildVariantTiles(card, bookId, jokeId, targetField, variants, labelPrefix, originalTile) {
      const container = card.querySelector(`.variants[data-target-field="${targetField}"]`);
      if (!container) return;
      container.innerHTML = '';
      if (originalTile && originalTile.imageUrl && originalTile.previewUrl) {
        const originalButton = document.createElement('button');
        originalButton.className = 'variant-tile original-variant';
        originalButton.type = 'button';
        originalButton.dataset.jokeId = jokeId;
        originalButton.dataset.bookId = bookId;
        originalButton.dataset.targetField = targetField;
        originalButton.dataset.imageUrl = originalTile.imageUrl;
        const img = document.createElement('img');
        img.src = originalTile.previewUrl;
        img.alt = `${labelPrefix} original image`;
        originalButton.appendChild(img);
        attachTileListener(originalButton);
        container.appendChild(originalButton);
      }
      (variants || []).forEach((imageUrl, index) => {
        if (!imageUrl) return;
        const tile = document.createElement('button');
        tile.className = 'variant-tile';
        tile.type = 'button';
        tile.dataset.jokeId = jokeId;
        tile.dataset.bookId = bookId;
        tile.dataset.targetField = targetField;
        tile.dataset.imageUrl = imageUrl;
        const img = document.createElement('img');
        img.src = imageUrl;
        img.alt = `${labelPrefix} option ${index + 1}`;
        tile.appendChild(img);
        attachTileListener(tile);
        container.appendChild(tile);
      });
      // Append upload button
      container.appendChild(createUploadButton(bookId, jokeId, targetField));
    }

    function updateRow(bookId, jokeId) {
      return fetch(
        `/admin/joke-books/${encodeURIComponent(bookId)}/jokes/${encodeURIComponent(jokeId)}/refresh`)
        .then((resp) => {
          if (!resp.ok) throw new Error('Failed to refresh joke');
          return resp.json();
        })
        .then((data) => {
          const card = document.querySelector(`[data-joke-id="${jokeId}"]`);
          if (!card) return data;
          const setupImg = card.querySelector('.setup-img');
          const punchImg = card.querySelector('.punchline-img');
          const setupPh = card.querySelector('.setup-placeholder');
          const punchPh = card.querySelector('.punchline-placeholder');
          const costPill = card.querySelector('.cost-pill-value');

          if (data.setup_image) {
            setupImg.classList.remove('hidden');
            setupImg.src = bustCache(data.setup_image);
            setupPh.classList.add('hidden');
          } else {
            setupImg.classList.add('hidden');
            setupImg.removeAttribute('src');
            setupPh.classList.remove('hidden');
          }

          if (data.punchline_image) {
            punchImg.classList.remove('hidden');
            punchImg.src = bustCache(data.punchline_image);
            punchPh.classList.add('hidden');
          } else {
            punchImg.classList.add('hidden');
            punchImg.removeAttribute('src');
            punchPh.classList.remove('hidden');
          }

          updateDownloadLink(card, '.setup-download', data.setup_image_download);
          updateDownloadLink(card, '.punchline-download', data.punchline_image_download);

          if (typeof data.total_cost === 'number') {
            costPill.textContent = `$${data.total_cost.toFixed(4)}`;
            costPill.classList.remove('muted');
          } else {
            costPill.textContent = 'Cost unavailable';
            costPill.classList.add('muted');
          }

          rebuildVariantTiles(
            card,
            bookId,
            jokeId,
            'book_page_setup_image_url',
            Array.isArray(data.setup_variants) ? data.setup_variants : [],
            'Setup options',
            {
              imageUrl: data.setup_original_image || '',
              previewUrl: data.setup_original_preview || data.setup_original_image || '',
            },
          );
          rebuildVariantTiles(
            card,
            bookId,
            jokeId,
            'book_page_punchline_image_url',
            Array.isArray(data.punchline_variants) ? data.punchline_variants : [],
            'Punchline options',
            {
              imageUrl: data.punchline_original_image || '',
              previewUrl: data.punchline_original_preview || data.punchline_original_image || '',
            },
          );

          const tiles = card.querySelectorAll('.variant-tile');
          tiles.forEach((tile) => {
            const url = tile.dataset.imageUrl;
            const isSetup = tile.dataset.targetField === 'book_page_setup_image_url';
            const current = isSetup ? data.setup_image : data.punchline_image;
            applyTileHighlight(
              tile,
              current && url && normalizeUrl(current) === normalizeUrl(url),
            );
          });

          const metricDefaults = {
            num_views: 0,
            num_saves: 0,
            num_shares: 0,
            popularity_score: 0,
            num_saved_users_fraction: 0,
          };
          Object.entries(metricDefaults).forEach(([key, defaultValue]) => {
            const el = card.querySelector(`[data-metric="${key}"]`);
            if (!el) return;
            const raw = data[key];
            const value = typeof raw === 'number' ? raw : defaultValue;
            if (key === 'popularity_score') {
              el.textContent = value.toFixed(3);
            } else if (key === 'num_saved_users_fraction') {
              el.textContent = value.toFixed(2);
            } else {
              el.textContent = Math.trunc(value);
            }
          });
          return data;
        });
    }

    setupZipRegenerator();

    forms.forEach((form) => {
      const revealBtn = form.querySelector('.reveal-btn');
      const submitBtn = form.querySelector('.submit-btn');
      const instructions = form.querySelector('.instructions');
      const statusRow = form.querySelector('.status-row');
      const timerDisplay = form.querySelector('.timer-display');
      const errorBox = form.querySelector('.inline-error');
      let timerStopper = null;

      revealBtn.addEventListener('click', () => {
      instructions.classList.remove('hidden');
      submitBtn.classList.remove('hidden');
      revealBtn.classList.add('hidden');
      const firstField = instructions.querySelector('textarea');
      if (firstField) firstField.focus();
    });

      form.addEventListener('submit', (evt) => {
        evt.preventDefault();
        const jokeId = form.dataset.jokeId;
        const bookId = form.dataset.bookId;
        const formData = new FormData(form);
        formData.set('joke_id', jokeId);
        const original = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Regenerating...';
        errorBox.textContent = '';
        timerStopper = startTimer(statusRow, timerDisplay);
        const runRefresh = () => updateRow(bookId, jokeId).catch((err) => {
          console.error(err);
          errorBox.textContent = 'Regenerated, but failed to refresh images.';
        });

        fetch(form.action, {
          method: 'POST',
          body: formData,
          mode: 'cors',
        })
          .then((resp) => {
            if (!resp.ok) {
              return resp.text().then((txt) => {
                throw new Error(txt || 'Regeneration failed');
              });
            }
            return resp.text();
          })
          .then(() => runRefresh())
          .catch((err) => {
            console.error(err);
            // Even if fetch failed (CORS/network), still try to refresh assuming backend ran.
            errorBox.textContent = err?.message || 'Failed to regenerate pages.';
            return runRefresh();
          })
          .finally(() => {
            if (timerStopper) timerStopper();
            submitBtn.disabled = false;
            submitBtn.textContent = original;
          });
      });
    });

    document.querySelectorAll('.set-main-link')
      .forEach((link) => attachSetMainListener(link));

    document.querySelectorAll('.variant-tile')
      .forEach((tile) => attachTileListener(tile));

    document.querySelectorAll('.upload-input')
      .forEach((input) => input.addEventListener('change', handleUpload));

    // Initial highlight on load
    document.querySelectorAll('.joke-card').forEach((card) => {
      const tiles = card.querySelectorAll('.variant-tile');
      const setupImg = card.querySelector('.setup-img')?.getAttribute('src') || '';
      const punchImg = card.querySelector('.punchline-img')?.getAttribute('src') || '';
      tiles.forEach((tile) => {
        const url = tile.dataset.imageUrl;
        const isSetup = tile.dataset.targetField === 'book_page_setup_image_url';
        const current = isSetup ? setupImg : punchImg;
        applyTileHighlight(
          tile,
          current && url && normalizeUrl(current) === normalizeUrl(url),
        );
      });
    });

    // --- New Functionality: Search, Add, Remove, Reorder ---

    const searchInput = document.getElementById('joke-search-input');
    const searchCategoryCheckbox = document.getElementById('joke-search-category-checkbox');
    const searchBtn = document.getElementById('joke-search-btn');
    const searchResults = document.getElementById('search-results');
    const addSelectedBtn = document.getElementById('add-selected-btn');
    let selectedJokeIds = new Set();

    if (searchBtn && searchInput) {
      if (searchCategoryCheckbox) {
        searchCategoryCheckbox.addEventListener('change', () => {
          searchInput.placeholder = searchCategoryCheckbox.checked
            ? 'Enter category ID...'
            : 'Search for jokes to add...';
        });
      }

      const performSearch = async () => {
        const query = searchInput.value.trim();
        if (!query) return;

        searchBtn.disabled = true;
        searchBtn.textContent = 'Searching...';
        searchResults.innerHTML = '';
        selectedJokeIds.clear();
        updateAddButton();

        // Collect existing joke IDs from the DOM
        const existingJokeIds = new Set();
        document.querySelectorAll('[data-joke-id]').forEach(el => {
          if(el.dataset.jokeId) existingJokeIds.add(el.dataset.jokeId);
        });

        try {
          const searchUrl = functionsOrigin
            ? `${functionsOrigin}/search_jokes`
            : '/search_jokes';

          // Construct URL with query params
          const url = new URL(searchUrl, window.location.origin);
          if (searchCategoryCheckbox && searchCategoryCheckbox.checked) {
            url.searchParams.append('category', query);
          } else {
            url.searchParams.append('search_query', query);
          }
          url.searchParams.append('max_results', '50');
          url.searchParams.append('return_jokes', 'true');
          url.searchParams.append('public_only', 'false');

          const resp = await fetch(url.toString());

          if (!resp.ok) throw new Error('Search failed');
          const payload = await resp.json();
          const data = payload.data || {};
          const jokes = data.jokes || [];

          // Filter client-side
          const candidates = jokes.filter(j => !existingJokeIds.has(j.joke_id));

          if (candidates.length === 0) {
            searchResults.innerHTML = '<p class="text-body muted" style="grid-column: 1/-1; text-align: center;">No matching jokes found (or all already in book).</p>';
            return;
          }

          candidates.slice(0, 10).forEach(item => { // Show top 10 new candidates
            const card = document.createElement('div');
            card.className = 'search-result-card';

            let thumbUrl = item.setup_image_url || '';
            if (thumbUrl && thumbUrl.includes('images.quillsstorybook.com')) {
               thumbUrl = normalizeUrl(thumbUrl); // remove existing params
               thumbUrl = `https://images.quillsstorybook.com/cdn-cgi/image/width=200,quality=70,format=auto/${thumbUrl}`;
            }

            card.innerHTML = `
              <img src="${thumbUrl}" class="search-result-img" alt="Joke Setup" loading="lazy">
              <div class="search-result-meta text-body">
                <code>${item.joke_id}</code>
              </div>
            `;

            card.onclick = () => toggleSelection(card, item.joke_id);
            searchResults.appendChild(card);
          });

        } catch (err) {
          console.error(err);
          alert('Failed to search jokes');
        } finally {
          searchBtn.disabled = false;
          searchBtn.textContent = 'Search';
        }
      };

      searchBtn.addEventListener('click', performSearch);
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') performSearch();
      });
    }

    function toggleSelection(card, jokeId) {
      if (selectedJokeIds.has(jokeId)) {
        selectedJokeIds.delete(jokeId);
        // Revert to CSS default
        card.style.border = '';
      } else {
        selectedJokeIds.add(jokeId);
        // Use the active border style defined globally
        card.style.border = activeVariantBorder;
      }
      updateAddButton();
    }

    function updateAddButton() {
      if (addSelectedBtn) {
        addSelectedBtn.disabled = selectedJokeIds.size === 0;
        addSelectedBtn.textContent = selectedJokeIds.size > 0
          ? `Add ${selectedJokeIds.size} Selected`
          : 'Add Selected';
      }
    }

    if (addSelectedBtn) {
      addSelectedBtn.addEventListener('click', async () => {
        if (selectedJokeIds.size === 0) return;

        const originalText = addSelectedBtn.textContent;
        addSelectedBtn.textContent = 'Adding...';
        addSelectedBtn.disabled = true;

        try {
          const resp = await fetch(`/admin/joke-books/${encodeURIComponent(bookId)}/jokes/add`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ joke_ids: Array.from(selectedJokeIds) }),
          });
          if (!resp.ok) throw new Error('Add failed');
          window.location.reload();
        } catch (err) {
          console.error(err);
          alert('Failed to add jokes: ' + err.message);
          addSelectedBtn.textContent = originalText;
          addSelectedBtn.disabled = false;
        }
      });
    }

    function reindexJokes() {
      const cards = document.querySelectorAll('.joke-card');
      const total = cards.length;

      cards.forEach((card, index) => {
        const sequence = index + 1;

        // Update header label
        const headerStrong = card.querySelector('.joke-header strong');
        if (headerStrong) headerStrong.textContent = `Joke ${sequence}`;

        // Update dropdown
        const select = card.querySelector('.position-select');
        if (select) {
          // Clear and rebuild options
          select.innerHTML = '';
          for (let i = 1; i <= total; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            if (i === sequence) option.selected = true;
            select.appendChild(option);
          }
        }
      });
    }

    document.querySelectorAll('.remove-joke-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('Are you sure you want to remove this joke?')) return;

        const jokeId = btn.dataset.jokeId;
        const originalText = btn.textContent;
        const card = btn.closest('.joke-card');

        btn.textContent = '...';
        btn.disabled = true;

        try {
          const resp = await fetch(`/admin/joke-books/${encodeURIComponent(bookId)}/jokes/${encodeURIComponent(jokeId)}/remove`, {
            method: 'POST',
          });
          if (!resp.ok) throw new Error('Remove failed');

          // Remove from DOM and reindex
          if (card) {
            card.remove();
            reindexJokes();
          } else {
             window.location.reload(); // Fallback
          }

        } catch (err) {
          console.error(err);
          alert('Failed to remove joke');
          btn.textContent = originalText;
          btn.disabled = false;
        }
      });
    });

    document.querySelectorAll('.position-select').forEach(select => {
      select.addEventListener('change', async (e) => {
        const jokeId = select.dataset.jokeId;
        const newPosition = parseInt(select.value);
        const card = select.closest('.joke-card');
        const container = document.querySelector('.joke-grid');

        select.disabled = true;

        try {
          const resp = await fetch(`/admin/joke-books/${encodeURIComponent(bookId)}/jokes/${encodeURIComponent(jokeId)}/reorder`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ new_position: newPosition }),
          });
          if (!resp.ok) throw new Error('Reorder failed');

          // Move in DOM
          if (card && container) {
            const currentPosition = Array.from(container.children).indexOf(card) + 1;

            if (newPosition !== currentPosition) {
              // If moving down (e.g. 1 -> 3), we insertBefore the element *after* the target index
              // If moving up (e.g. 3 -> 1), we insertBefore the target index
              // Actually, simplified: newPosition is 1-based target.
              // DOM index is newPosition - 1.

              const targetIndex = newPosition - 1;
              const allCards = Array.from(container.children);

              // Remove first to avoid index confusion? Or just move?
              // `insertBefore` moves if node is already in tree.

              if (targetIndex >= allCards.length) {
                container.appendChild(card);
              } else {
                // If moving down, we need to account for the fact that removing it shifts indices.
                // But insertBefore handles this reference node logic.
                // If we want it to BE at targetIndex, we insert before the node currently at targetIndex,
                // UNLESS we are moving down past it?
                // Actually, if we move item from 0 to 2.
                // List: [A, B, C, D]. Move A to pos 3 (index 2, which is C).
                // insertBefore(A, D). Result: [B, C, A, D]. Correct.
                // So we want to insert before the item at `targetIndex` if moving up?
                // If moving down, we want it to be at `targetIndex`.
                // Let's use `insertBefore` relative to the current state of list (excluding self potentially?)

                // Simpler: get list of other cards. Insert into that list. Re-append all.
                // Or:
                const otherCards = Array.from(container.querySelectorAll('.joke-card')).filter(c => c !== card);
                // Insert card into otherCards at proper index
                // Clamp index
                const safeIndex = Math.max(0, Math.min(targetIndex, otherCards.length));

                if (safeIndex === otherCards.length) {
                   container.appendChild(card);
                } else {
                   container.insertBefore(card, otherCards[safeIndex]);
                }
              }
              reindexJokes();
            }
          }

        } catch (err) {
          console.error(err);
          alert('Failed to reorder joke');
          // Revert selection?
        } finally {
          select.disabled = false;
        }
      });
    });

  })();
</script>
{% endblock %}
