{% extends "admin/base.html" %}

{% block title %}{{ book.book_name }} · Joke Book · {{ site_name }} Admin{% endblock %}

{% block head_extra %}
<style>
  .page-actions {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
  }

  .joke-grid {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .joke-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 20px;
    padding: 16px;
    box-shadow: 0 12px 30px rgba(196, 171, 140, 0.18);
  }

  .joke-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    justify-content: space-between;
  }

  .joke-meta {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .joke-images {
    display: grid;
    grid-template-columns: repeat(2, minmax(400px, 1fr));
    gap: 24px;
    align-items: start;
  }

  .image-frame {
    background: var(--color-accent-surface);
    border: 1px solid var(--color-border);
    border-radius: 16px;
    min-height: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px;
  }

  .image-frame img,
  .image-frame .placeholder {
    width: 100%;
    max-width: 800px;
    height: auto;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    border-radius: 12px;
  }

  .image-actions {
    align-self: flex-start;
    margin-top: 4px;
  }

  .download-link {
    color: var(--color-primary);
    text-decoration: none;
  }

  .download-link:hover {
    text-decoration: underline;
  }

  .placeholder {
    background: repeating-linear-gradient(
      45deg,
      rgba(212, 160, 23, 0.08),
      rgba(212, 160, 23, 0.08) 12px,
      rgba(212, 160, 23, 0.15) 12px,
      rgba(212, 160, 23, 0.15) 24px
    );
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
  }

  .back-link {
    text-decoration: none;
  }

  .back-link:hover {
    text-decoration: underline;
  }

  .joke-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto;
  }

  .cta-btn {
    background: var(--color-primary);
    border: none;
    padding: 8px 14px;
    border-radius: 999px;
    cursor: pointer;
  }

  .cta-btn:hover {
    opacity: 0.9;
  }

  .cta-btn[disabled],
  .cta-btn[disabled]:hover {
    background: rgba(74, 59, 50, 0.2);
    cursor: default;
    opacity: 1;
  }

  .cost-pill {
    background: var(--color-pill-bg);
    border-radius: 999px;
    padding: 6px 12px;
  }

  .hidden {
    display: none !important;
  }

  .instructions {
    margin-top: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .instructions textarea {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    padding: 10px;
    min-height: 64px;
    resize: vertical;
  }

  .status-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 0;
  }

  .timer-chip {
    background: var(--color-pill-bg);
    border-radius: 999px;
    padding: 4px 10px;
  }

  .variants {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 12px;
    flex: 1 1 0%;
  }

  .variant-tile {
    width: 100px;
    height: 100px;
    box-sizing: border-box;
    border: 2px solid rgba(212, 160, 23, 0.25);
    background: var(--color-accent-surface);
    border-radius: 10px;
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .variant-tile img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
  }

  .variant-label {
    margin-bottom: 6px;
  }

  .image-column {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
    align-items: center;
  }

  .instructions-row {
    display: grid;
    grid-template-columns: repeat(2, minmax(320px, 1fr));
    gap: 12px;
    width: 100%;
    margin-top: 8px;
  }

  .instructions-row textarea {
    width: 100%;
  }

  .variant-row {
    display: flex;
    align-items: stretch;
    gap: 12px;
    width: 100%;
    max-width: 800px;
    justify-content: flex-start;
  }

  .variant-preview {
    flex: 0 1 20%;
    min-width: 200px;
    min-height: 200px;
    aspect-ratio: 1 / 1;
    border-radius: 10px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-accent-surface);
    border: 1px solid var(--color-border);
  }

  .variant-preview.standalone {
    flex: 0 0 200px;
    min-height: 200px;
    aspect-ratio: 1 / 1;
  }

  .variant-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
    display: block;
  }

  .regenerate-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
    margin-top: 0;
  }

  .regenerate-footer {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 12px;
  }

  .regenerate-footer .status-row {
    margin-top: 0;
  }

  @media (max-width: 1100px) {
    .joke-images {
      grid-template-columns: 1fr;
    }

    .image-frame {
      width: 100%;
    }

    .instructions-row {
      grid-template-columns: 1fr;
    }
  }

  .upload-btn {
    width: 100px;
    height: 100px;
    box-sizing: border-box;
    border: 2px dashed rgba(212, 160, 23, 0.4);
    background: rgba(212, 160, 23, 0.05);
    border-radius: 10px;
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-primary);
    font-size: 24px;
    transition: all 0.2s ease;
  }

  .upload-btn:hover {
    background: rgba(212, 160, 23, 0.15);
    border-color: var(--color-primary);
  }

  .upload-input {
    display: none;
  }
</style>
{% endblock %}
{% macro render_variants(variants, label, target_field, joke_id, book_id, preview=None) -%}
  <div class="variant-group">
    <div class="variant-label text-button">{{ label }}</div>
    <div class="variant-row">
      {% if preview %}
      <div class="variant-preview">
        <img src="{{ preview }}" alt="{{ label }} preview">
      </div>
      {% endif %}
      <div class="variants" data-target-field="{{ target_field }}">
        {% if variants %}
          {% for variant in variants %}
          <button class="variant-tile"
            type="button"
            data-joke-id="{{ joke_id }}"
            data-book-id="{{ book_id }}"
            data-target-field="{{ target_field }}"
            data-image-url="{{ variant }}">
            <img src="{{ variant }}" alt="{{ label }} option {{ loop.index }}">
          </button>
          {% endfor %}
        {% endif %}
        <label class="upload-btn" title="Upload custom image">
          +
          <input type="file" 
            class="upload-input" 
            accept="image/*"
            data-joke-id="{{ joke_id }}"
            data-book-id="{{ book_id }}"
            data-target-field="{{ target_field }}">
        </label>
      </div>
    </div>
  </div>
{%- endmacro %}

{% block content %}
<div class="page-actions">
  <a class="back-link site-footer__link text-button" href="{{ url_for('web.admin_joke_books') }}">← Back to joke books</a>
  {% if book.zip_url %}
  <a class="back-link site-footer__link text-button" href="{{ book.zip_url }}" target="_blank" rel="noopener noreferrer">Download all pages (ZIP)</a>
  {% endif %}
</div>

<h2 class="text-section-heading">
  {{ book.book_name }}
  {% if book_total_cost is not none %}
  <span class="cost-pill text-button">${{ '%.4f'|format(book_total_cost) }}</span>
  {% endif %}
</h2>
<p class="muted"><code>{{ book.id }}</code></p>

{% if not jokes %}
<p class="muted">No jokes found for this book.</p>
{% else %}
<div class="joke-grid">
  {% for joke in jokes %}
  <article class="joke-card" data-joke-id="{{ joke.id }}">
    <form method="post"
      class="regenerate-form"
      data-joke-id="{{ joke.id }}"
      data-book-id="{{ book.id }}"
      action="{{ generate_book_page_url }}"
      target="_blank">
      <input type="hidden" name="joke_id" value="{{ joke.id }}">
      <div class="joke-header text-body">
        <div class="joke-meta text-body">
          <strong>Joke {{ joke.sequence }}</strong>
          <code>{{ joke.id }}</code>
          {% if joke.total_cost is not none %}
          <span class="cost-pill cost-pill-value text-button">${{ '%.4f'|format(joke.total_cost) }}</span>
          {% else %}
          <span class="cost-pill cost-pill-value text-button muted">Cost unavailable</span>
          {% endif %}
        </div>
        <button class="cta-btn nav-cta text-button reveal-btn" type="button">Regenerate pages</button>
      </div>
      <div class="instructions instructions-row hidden">
        <div>
          <label class="text-button" for="setup-{{ joke.id }}">Setup instructions (optional)</label>
          <textarea id="setup-{{ joke.id }}" name="setup_instructions" placeholder="Extra guidance for the setup image"></textarea>
        </div>
        <div>
          <label class="text-button" for="punch-{{ joke.id }}">Punchline instructions (optional)</label>
          <textarea id="punch-{{ joke.id }}" name="punchline_instructions" placeholder="Extra guidance for the punchline image"></textarea>
        </div>
      </div>
      <div class="regenerate-footer">
        <div class="status-row hidden">
          <span class="timer-chip timer-display text-button">0:00</span>
          <span class="inline-error form-error text-button"></span>
        </div>
        <button class="cta-btn nav-cta text-button submit-btn hidden" type="submit">Submit</button>
      </div>
    </form>
    <div class="joke-images">
      <div class="image-column">
        {{ render_variants(joke.setup_variants, "Setup options", "book_page_setup_image_url", joke.id, book.id, preview=joke.setup_preview) }}
        <div class="image-frame">
          <img class="joke-image setup-img {% if not joke.setup_image %}hidden{% endif %}"
            src="{{ joke.setup_image or '' }}" alt="Setup image for {{ joke.id }}" width="800" height="800" loading="lazy">
          <div class="placeholder text-body text-button setup-placeholder {% if joke.setup_image %}hidden{% endif %}" role="img"
            aria-label="Setup image missing">No setup image</div>
        </div>
        <div class="image-actions setup-download {% if not joke.setup_image_download %}hidden{% endif %}">
          <a class="download-link text-button"
            href="{{ joke.setup_image_download or '' }}"
            target="_blank"
            rel="noopener noreferrer">
            Download
          </a>
        </div>
      </div>
      <div class="image-column">
        {{ render_variants(joke.punchline_variants, "Punchline options", "book_page_punchline_image_url", joke.id, book.id, preview=joke.punchline_preview) }}
        <div class="image-frame">
          <img class="joke-image punchline-img {% if not joke.punchline_image %}hidden{% endif %}"
            src="{{ joke.punchline_image or '' }}" alt="Punchline image for {{ joke.id }}" width="800" height="800"
            loading="lazy">
          <div class="placeholder text-body text-button punchline-placeholder {% if joke.punchline_image %}hidden{% endif %}" role="img"
            aria-label="No punchline image">No punchline image</div>
        </div>
        <div class="image-actions punchline-download {% if not joke.punchline_image_download %}hidden{% endif %}">
          <a class="download-link text-button"
            href="{{ joke.punchline_image_download or '' }}"
            target="_blank"
            rel="noopener noreferrer">
            Download
          </a>
        </div>
      </div>
    </div>
  </article>
  {% endfor %}
</div>
{% endif %}

<script>
  (function () {
    const forms = Array.from(document.querySelectorAll('.regenerate-form'));
    const updateBookPageUrl = "{{ update_book_page_url }}";
    const accentColor = getComputedStyle(document.documentElement)
      .getPropertyValue('--color-primary')
      .trim() || '#d4a017';
    const inactiveVariantBorder = '2px solid rgba(74, 59, 50, 0.25)';
    const bustCache = (url) => {
      if (!url) return '';
      const sep = url.includes('?') ? '&' : '?';
      return `${url}${sep}t=${Date.now()}`;
    };
    const normalizeUrl = (url) => {
      if (!url) return '';
      const noQuery = url.replace(/\?.*$/, '');
      const prefix = "https://images.quillsstorybook.com/cdn-cgi/image/";
      if (!noQuery.startsWith(prefix)) return noQuery;
      const remainder = noQuery.slice(prefix.length);
      const slashIndex = remainder.indexOf('/');
      if (slashIndex === -1) return noQuery;
      return remainder.slice(slashIndex + 1);
    };

    const updateDownloadLink = (card, selector, url) => {
      const container = card.querySelector(selector);
      const link = container?.querySelector('a');
      if (!container || !link) return;
      if (url) {
        link.href = url;
        container.classList.remove('hidden');
      } else {
        link.removeAttribute('href');
        container.classList.add('hidden');
      }
    };

    const applyTileHighlight = (tile, isActive) => {
      tile.style.border = isActive ? `2px solid ${accentColor}` : inactiveVariantBorder;
    };

    const startTimer = (statusRow, timerDisplay) => {
      statusRow.classList.remove('hidden');
      const start = Date.now();
      const renderTime = () => {
        const elapsed = Math.floor((Date.now() - start) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = String(elapsed % 60).padStart(2, '0');
        timerDisplay.textContent = `${minutes}:${seconds}`;
      };
      renderTime();
      const id = window.setInterval(renderTime, 1000);
      return () => window.clearInterval(id);
    };

    function attachTileListener(tile) {
      tile.addEventListener('click', () => {
        const bookId = tile.dataset.bookId;
        const jokeId = tile.dataset.jokeId;
        const targetField = tile.dataset.targetField;
        const imageUrl = tile.dataset.imageUrl;
        const card = tile.closest('.joke-card');
        const statusRow = card?.querySelector('.status-row');
        const timerDisplay = card?.querySelector('.timer-display');
        const errorBox = card?.querySelector('.inline-error');
        if (!bookId || !jokeId || !card || !statusRow || !timerDisplay || !errorBox) {
          return;
        }
        errorBox.textContent = '';
        const stopper = startTimer(statusRow, timerDisplay);

        const formData = new FormData();
        formData.set('joke_book_id', bookId);
        formData.set('joke_id', jokeId);
        if (targetField === 'book_page_setup_image_url') {
          formData.set('new_book_page_setup_image_url', imageUrl);
        } else {
          formData.set('new_book_page_punchline_image_url', imageUrl);
        }

        fetch(updateBookPageUrl, {
          method: 'POST',
          body: formData,
          mode: 'cors',
        })
          .then((resp) => {
            if (!resp.ok) {
              return resp.text().then((txt) => {
                throw new Error(txt || 'Failed to update image');
              });
            }
            return resp.text();
          })
          .then(() => updateRow(bookId, jokeId))
          .catch((err) => {
            console.error(err);
            errorBox.textContent = err?.message || 'Failed to update image.';
          })
          .finally(() => {
            if (stopper) stopper();
          });
      });
    }

    function createUploadButton(bookId, jokeId, targetField) {
      const label = document.createElement('label');
      label.className = 'upload-btn';
      label.title = 'Upload custom image';
      label.textContent = '+';

      const input = document.createElement('input');
      input.type = 'file';
      input.className = 'upload-input';
      input.accept = 'image/*';
      input.dataset.jokeId = jokeId;
      input.dataset.bookId = bookId;
      input.dataset.targetField = targetField;
      
      input.addEventListener('change', handleUpload);
      label.appendChild(input);
      return label;
    }

    function handleUpload(evt) {
      const input = evt.target;
      const file = input.files[0];
      if (!file) return;

      const jokeId = input.dataset.jokeId;
      const bookId = input.dataset.bookId;
      const targetField = input.dataset.targetField;
      const label = input.parentElement;
      
      // UI Loading state
      const originalText = label.childNodes[0].textContent; // The text node '+'
      label.childNodes[0].textContent = '...';
      input.disabled = true;

      const formData = new FormData();
      formData.set('file', file);
      formData.set('joke_id', jokeId);
      formData.set('joke_book_id', bookId);
      formData.set('target_field', targetField);

      fetch('/admin/joke-books/upload-image', {
        method: 'POST',
        body: formData
      })
      .then(resp => {
        if (!resp.ok) return resp.text().then(t => { throw new Error(t) });
        return resp.json();
      })
      .then(() => updateRow(bookId, jokeId))
      .catch(err => {
        console.error('Upload failed:', err);
        alert('Upload failed: ' + err.message);
        label.childNodes[0].textContent = originalText; // Reset on error
      })
      .finally(() => {
        input.disabled = false;
        input.value = ''; // Reset input
      });
    }

    function rebuildVariantTiles(card, bookId, jokeId, targetField, variants, labelPrefix) {
      const container = card.querySelector(`.variants[data-target-field="${targetField}"]`);
      if (!container) return;
      container.innerHTML = '';
      (variants || []).forEach((imageUrl, index) => {
        if (!imageUrl) return;
        const tile = document.createElement('button');
        tile.className = 'variant-tile';
        tile.type = 'button';
        tile.dataset.jokeId = jokeId;
        tile.dataset.bookId = bookId;
        tile.dataset.targetField = targetField;
        tile.dataset.imageUrl = imageUrl;
        const img = document.createElement('img');
        img.src = imageUrl;
        img.alt = `${labelPrefix} option ${index + 1}`;
        tile.appendChild(img);
        attachTileListener(tile);
        container.appendChild(tile);
      });
      // Append upload button
      container.appendChild(createUploadButton(bookId, jokeId, targetField));
    }

    function updateRow(bookId, jokeId) {
      return fetch(
        `/admin/joke-books/${encodeURIComponent(bookId)}/jokes/${encodeURIComponent(jokeId)}/refresh`)
        .then((resp) => {
          if (!resp.ok) throw new Error('Failed to refresh joke');
          return resp.json();
        })
        .then((data) => {
          const card = document.querySelector(`[data-joke-id="${jokeId}"]`);
          if (!card) return data;
          const setupImg = card.querySelector('.setup-img');
          const punchImg = card.querySelector('.punchline-img');
          const setupPh = card.querySelector('.setup-placeholder');
          const punchPh = card.querySelector('.punchline-placeholder');
          const costPill = card.querySelector('.cost-pill-value');

          if (data.setup_image) {
            setupImg.classList.remove('hidden');
            setupImg.src = bustCache(data.setup_image);
            setupPh.classList.add('hidden');
          } else {
            setupImg.classList.add('hidden');
            setupImg.removeAttribute('src');
            setupPh.classList.remove('hidden');
          }

          if (data.punchline_image) {
            punchImg.classList.remove('hidden');
            punchImg.src = bustCache(data.punchline_image);
            punchPh.classList.add('hidden');
          } else {
            punchImg.classList.add('hidden');
            punchImg.removeAttribute('src');
            punchPh.classList.remove('hidden');
          }

          updateDownloadLink(card, '.setup-download', data.setup_image_download);
          updateDownloadLink(card, '.punchline-download', data.punchline_image_download);

          if (typeof data.total_cost === 'number') {
            costPill.textContent = `$${data.total_cost.toFixed(4)}`;
            costPill.classList.remove('muted');
          } else {
            costPill.textContent = 'Cost unavailable';
            costPill.classList.add('muted');
          }

          rebuildVariantTiles(
            card,
            bookId,
            jokeId,
            'book_page_setup_image_url',
            Array.isArray(data.setup_variants) ? data.setup_variants : [],
            'Setup options',
          );
          rebuildVariantTiles(
            card,
            bookId,
            jokeId,
            'book_page_punchline_image_url',
            Array.isArray(data.punchline_variants) ? data.punchline_variants : [],
            'Punchline options',
          );

          const tiles = card.querySelectorAll('.variant-tile');
          tiles.forEach((tile) => {
            const url = tile.dataset.imageUrl;
            const isSetup = tile.dataset.targetField === 'book_page_setup_image_url';
            const current = isSetup ? data.setup_image : data.punchline_image;
            applyTileHighlight(
              tile,
              current && url && normalizeUrl(current) === normalizeUrl(url),
            );
          });
          return data;
        });
    }

    forms.forEach((form) => {
      const revealBtn = form.querySelector('.reveal-btn');
      const submitBtn = form.querySelector('.submit-btn');
      const instructions = form.querySelector('.instructions');
      const statusRow = form.querySelector('.status-row');
      const timerDisplay = form.querySelector('.timer-display');
      const errorBox = form.querySelector('.inline-error');
      let timerStopper = null;

      revealBtn.addEventListener('click', () => {
      instructions.classList.remove('hidden');
      submitBtn.classList.remove('hidden');
      revealBtn.classList.add('hidden');
      const firstField = instructions.querySelector('textarea');
      if (firstField) firstField.focus();
    });

      form.addEventListener('submit', (evt) => {
        evt.preventDefault();
        const jokeId = form.dataset.jokeId;
        const bookId = form.dataset.bookId;
        const formData = new FormData(form);
        formData.set('joke_id', jokeId);
        const original = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Regenerating...';
        errorBox.textContent = '';
        timerStopper = startTimer(statusRow, timerDisplay);
        const runRefresh = () => updateRow(bookId, jokeId).catch((err) => {
          console.error(err);
          errorBox.textContent = 'Regenerated, but failed to refresh images.';
        });

        fetch(form.action, {
          method: 'POST',
          body: formData,
          mode: 'cors',
        })
          .then((resp) => {
            if (!resp.ok) {
              return resp.text().then((txt) => {
                throw new Error(txt || 'Regeneration failed');
              });
            }
            return resp.text();
          })
          .then(() => runRefresh())
          .catch((err) => {
            console.error(err);
            // Even if fetch failed (CORS/network), still try to refresh assuming backend ran.
            errorBox.textContent = err?.message || 'Failed to regenerate pages.';
            return runRefresh();
          })
          .finally(() => {
            if (timerStopper) timerStopper();
            submitBtn.disabled = false;
            submitBtn.textContent = original;
          });
      });
    });

    document.querySelectorAll('.variant-tile')
      .forEach((tile) => attachTileListener(tile));

    document.querySelectorAll('.upload-input')
      .forEach((input) => input.addEventListener('change', handleUpload));

    // Initial highlight on load
    document.querySelectorAll('.joke-card').forEach((card) => {
      const tiles = card.querySelectorAll('.variant-tile');
      const setupImg = card.querySelector('.setup-img')?.getAttribute('src') || '';
      const punchImg = card.querySelector('.punchline-img')?.getAttribute('src') || '';
      tiles.forEach((tile) => {
        const url = tile.dataset.imageUrl;
        const isSetup = tile.dataset.targetField === 'book_page_setup_image_url';
        const current = isSetup ? setupImg : punchImg;
        applyTileHighlight(
          tile,
          current && url && normalizeUrl(current) === normalizeUrl(url),
        );
      });
    });
  })();
</script>
{% endblock %}
