{% extends "admin/base.html" %}

{% block title %}{{ book.book_name }} · Joke Book · {{ site_name }} Admin{% endblock %}

{% block head_extra %}
<style>
  .page-actions {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
  }

  .joke-grid {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .joke-card {
    background: var(--surface);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 14px;
    padding: 16px;
  }

  .joke-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    color: var(--muted);
    justify-content: space-between;
  }

  .joke-meta {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .joke-images {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 12px;
  }

  .image-frame {
    background: #0f0f0f;
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 10px;
    min-height: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px;
  }

  .image-frame img,
  .image-frame .placeholder {
    width: min(600px, 100%);
    max-width: 100%;
    height: auto;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    border-radius: 8px;
  }

  .placeholder {
    background: repeating-linear-gradient(
      45deg,
      rgba(255, 255, 255, 0.04),
      rgba(255, 255, 255, 0.04) 12px,
      rgba(255, 255, 255, 0.08) 12px,
      rgba(255, 255, 255, 0.08) 24px
    );
    color: var(--muted);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    text-align: center;
  }

  .back-link {
    color: var(--accent);
    text-decoration: none;
    font-weight: 700;
  }

  .back-link:hover {
    text-decoration: underline;
  }

  .joke-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto;
  }

  .cta-btn {
    background: var(--accent);
    border: none;
    color: #181818;
    font-weight: 700;
    padding: 8px 14px;
    border-radius: 999px;
    cursor: pointer;
  }

  .cta-btn:hover {
    opacity: 0.9;
  }

  .cost-pill {
    background: rgba(255, 255, 255, 0.08);
    color: var(--text);
    border-radius: 999px;
    padding: 6px 12px;
    font-weight: 700;
    font-size: 0.9rem;
  }

  .cost-pill.muted {
    color: var(--muted);
  }
</style>
{% endblock %}

{% block content %}
<div class="page-actions">
  <a class="back-link" href="{{ url_for('web.admin_joke_books') }}">← Back to joke books</a>
  {% if book.zip_url %}
  <a class="back-link" href="{{ book.zip_url }}" target="_blank" rel="noopener noreferrer">Download all pages (ZIP)</a>
  {% endif %}
</div>

<h2>
  {{ book.book_name }}
  {% if book_total_cost is not none %}
  <span class="cost-pill">${{ '%.4f'|format(book_total_cost) }}</span>
  {% endif %}
</h2>
<p class="muted"><code>{{ book.id }}</code></p>

{% if not jokes %}
<p class="muted">No jokes found for this book.</p>
{% else %}
<div class="joke-grid">
  {% for joke in jokes %}
  <article class="joke-card">
    <div class="joke-header">
      <div class="joke-meta">
        <strong>Joke {{ joke.sequence }}</strong>
        <code>{{ joke.id }}</code>
        {% if joke.total_cost is not none %}
        <span class="cost-pill">${{ '%.4f'|format(joke.total_cost) }}</span>
        {% else %}
        <span class="cost-pill muted">Cost unavailable</span>
        {% endif %}
      </div>
      <div class="joke-actions">
        <form method="post" action="{{ generate_book_page_url }}" target="_blank">
          <input type="hidden" name="joke_id" value="{{ joke.id }}">
          <button class="cta-btn" type="submit">Regenerate pages</button>
        </form>
      </div>
    </div>
    <div class="joke-images">
      <div class="image-frame">
        {% if joke.setup_image %}
        <img src="{{ joke.setup_image }}" alt="Setup image for {{ joke.id }}" width="600" height="600" loading="lazy">
        {% else %}
        <div class="placeholder" role="img" aria-label="Setup image missing">No setup image</div>
        {% endif %}
      </div>
      <div class="image-frame">
        {% if joke.punchline_image %}
        <img src="{{ joke.punchline_image }}" alt="Punchline image for {{ joke.id }}" width="600" height="600" loading="lazy">
        {% else %}
        <div class="placeholder" role="img" aria-label="Punchline image missing">No punchline image</div>
        {% endif %}
      </div>
    </div>
  </article>
  {% endfor %}
</div>
{% endif %}
{% endblock %}
