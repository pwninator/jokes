{% extends "admin/admin_base.html" %}

{% block title %}Joke Categories Â· {{ site_name }} Admin{% endblock %}

{% block content %}
<div style="display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap;">
  <h2 style="margin: 0;">Joke Categories</h2>
  <details class="create-category-panel">
    <summary class="text-button">Create category</summary>
    <form method="post" action="{{ url_for('web.admin_create_joke_category') }}" style="margin-top: 12px;">
      <div style="display: grid; gap: 10px; margin-top: 12px; max-width: 560px;">
        <label class="text-body">
          <div class="text-button">Display name</div>
          <input name="display_name" type="text" required
            style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-border); border-radius: 10px; background: var(--color-surface); font-family: inherit;">
        </label>

        <label class="text-body">
          <div class="text-button">Search</div>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input name="joke_description_query" type="text"
              placeholder="cats"
              style="flex: 1 1 auto; min-width: 0; padding: 8px 12px; border: 1px solid var(--color-border); border-radius: 10px; background: var(--color-surface); font-family: inherit;">
            <input name="search_distance" type="text"
              inputmode="decimal"
              placeholder="{{ joke_search_tight_threshold }}"
              title="Optional search distance threshold"
              style="width: 90px; padding: 8px 10px; border: 1px solid var(--color-border); border-radius: 10px; background: var(--color-surface); font-family: inherit;">
          </div>
        </label>

        <label class="text-body">
          <div class="text-button">Seasonal name</div>
          <input name="seasonal_name" type="text"
            style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-border); border-radius: 10px; background: var(--color-surface); font-family: inherit;">
        </label>

        <label class="text-body">
          <div class="text-button">Book ID</div>
          <input name="book_id" type="text"
            placeholder="book-123"
            style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-border); border-radius: 10px; background: var(--color-surface); font-family: inherit;">
        </label>

        <label class="text-body">
          <div class="text-button">Tags (comma-separated)</div>
          <input name="tags" type="text"
            style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-border); border-radius: 10px; background: var(--color-surface); font-family: inherit;">
        </label>

        <label class="text-body">
          <div class="text-button">Negative tags (comma-separated)</div>
          <input name="negative_tags" type="text"
            placeholder="nsfw, politics"
            style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-border); border-radius: 10px; background: var(--color-surface); font-family: inherit;">
        </label>

        <label class="text-body">
          <div class="text-button">Image description (optional)</div>
          <input name="image_description" type="text"
            style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-border); border-radius: 10px; background: var(--color-surface); font-family: inherit;">
        </label>

        <div style="display: flex; justify-content: flex-end;">
          <button class="text-button" type="submit">Create (PROPOSED)</button>
        </div>
      </div>
    </form>
  </details>
</div>

{% if created %}
<p class="muted">Category created.</p>
{% endif %}
{% if updated %}
<p class="muted">Category updated: <code>{{ updated }}</code></p>
{% endif %}
{% if notes_generated %}
<p class="muted">Lunchbox notes generated: <code>{{ notes_generated }}</code></p>
{% endif %}
{% if error %}
<p class="muted">Error: <code>{{ error }}</code></p>
{% endif %}

<style>
  .hidden {
    display: none !important;
  }
  .category-section {
    margin-top: 18px;
  }
  .category-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 10px;
  }
  details.category-details {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 14px;
    padding: 10px 12px;
  }
  details.category-details > summary {
    cursor: pointer;
    list-style: none;
    display: flex;
    align-items: center;
    gap: 10px;
    justify-content: space-between;
  }
  details.category-details > summary::-webkit-details-marker {
    display: none;
  }
  .category-meta {
    display: flex;
    flex-direction: column;
    gap: 4px;
    min-width: 0;
  }
  .category-left {
    display: flex;
    align-items: center;
    gap: 12px;
    min-width: 0;
  }
  .category-thumb {
    width: 100px;
    height: 100px;
    border-radius: 14px;
    border: 1px solid var(--color-border);
    overflow: hidden;
    background: var(--color-accent-surface);
    flex: 0 0 auto;
  }
  .category-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  .category-name {
    display: inline-flex;
    align-items: baseline;
    gap: 8px;
    flex-wrap: wrap;
  }
  .category-subline {
    display: inline-flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  .category-actions {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    flex: 0 0 auto;
  }
  .category-actions .link-button {
    background: transparent;
    border: none;
    padding: 0;
    margin: 0;
    font: inherit;
    cursor: pointer;
    color: inherit;
  }
  .category-actions .link-button:focus-visible {
    outline: 2px solid var(--color-focus-ring);
    outline-offset: 2px;
    border-radius: 6px;
  }
  .edit-panel {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px dashed var(--color-border);
  }
  .category-download-actions {
    margin-top: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }
  .sheet-preview-link-group {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
  }
  .sheet-preview-panel {
    margin-top: 12px;
    padding: 12px;
    border: 1px solid var(--color-border);
    border-radius: 12px;
    background: var(--color-accent-surface);
  }
  .sheet-preview-panel h4 {
    margin: 0 0 10px;
  }
  .sheet-preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 12px;
  }
  .sheet-preview-grid img {
    width: 100%;
    height: auto;
    display: block;
    border-radius: 10px;
    border: 1px solid var(--color-border);
    background: var(--color-surface);
  }
  .edit-flex {
    display: flex;
    flex-wrap: wrap;
    gap: 16px 12px;
    align-items: start;
  }
  .edit-flex label {
    display: flex;
    flex-direction: column;
    gap: 4px;
    min-width: 0;
  }
  .edit-flex .field-small {
    flex: 1 1 120px;
  }
  .edit-flex .field-medium {
    flex: 2 1 240px;
  }
  .edit-flex .field-large {
    flex: 1 0 100%;
  }
  .edit-flex input,
  .edit-flex select,
  .edit-flex textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--color-border);
    border-radius: 10px;
    background: var(--color-surface);
    font-family: inherit;
  }
  .edit-flex textarea {
    min-height: 90px;
    resize: vertical;
  }
  .pill {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid var(--color-border);
    background: var(--color-pill-bg);
    font-variant-numeric: tabular-nums;
  }
  .joke-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
    margin-top: 10px;
  }
  .joke-tile {
    border: 1px solid var(--color-border);
    border-radius: 12px;
    overflow: hidden;
    background: var(--color-surface);
  }
  .joke-tile img,
  .joke-tile .placeholder {
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    display: block;
  }
  .joke-tile .placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    background: repeating-linear-gradient(
      45deg,
      rgba(212, 160, 23, 0.08),
      rgba(212, 160, 23, 0.08) 12px,
      rgba(212, 160, 23, 0.15) 12px,
      rgba(212, 160, 23, 0.15) 24px
    );
  }
</style>

{%- macro joke_tooltip_text(joke) -%}
  {%- set seasonal_value = joke.seasonal if joke.seasonal else "None" -%}
  {%- set tags_text = (joke.tags or []) | join('\n') -%}
  {{- (joke.key or '') ~ '\n\nseasonal: ' ~ seasonal_value ~ '\n\ntags:\n' ~ tags_text -}}
{%- endmacro -%}

{%- macro joke_tooltip_title_attr(joke) -%}
  {%- set newline = '&#10;' | safe -%}
  {{- joke_tooltip_text(joke) | e | replace('\n', newline) -}}
{%- endmacro -%}

{% macro render_category_list(categories) -%}
  {% if not categories %}
  <p class="muted">None.</p>
  {% else %}
  <div class="category-list">
    {% for category in categories %}
    {% set joke_count = (category.jokes | length) %}
    {% set thumb_url = category.image_url %}
    {% if not thumb_url and category.all_image_urls %}
      {% set thumb_url = category.all_image_urls[0] %}
    {% endif %}
    <details class="category-details" data-lazy-scope="category">
      <summary class="text-body">
        <div class="category-left">
          <div class="category-thumb">
            {% if thumb_url %}
            <img src="{{ thumb_url }}" alt="Category image" width="100" height="100" loading="lazy">
            {% endif %}
          </div>
          <div class="category-meta">
            <div class="category-name">
              <strong>{{ category.display_name or 'Untitled' }}</strong>
              {% if category.id %}
              <span class="muted">({{ category.id }})</span>
              {% endif %}
            </div>
            <div class="category-subline text-body">
              {% set has_query = (category.joke_description_query or '').strip() %}
              {% set has_seasonal = (category.seasonal_name or '').strip() %}
              {% set tags_count = (category.tags | length) if category.tags else 0 %}
              {% set neg_tags_count = (category.negative_tags | length) if category.negative_tags else 0 %}
              {% if has_query %}<span class="pill text-button">search</span>{% endif %}
              {% if has_seasonal %}<span class="pill text-button">seasonal</span>{% endif %}
              {% if tags_count %}<span class="pill text-button">{{ tags_count }} tags</span>{% endif %}
              {% if neg_tags_count %}<span class="pill text-button" style="background: var(--color-error-surface); color: var(--color-error);">{{ neg_tags_count }} neg</span>{% endif %}
              <span class="muted">{{ joke_count }} jokes</span>
            </div>
          </div>
        </div>
        <div class="category-actions">
          <button class="link-button muted text-button" type="button"
            data-edit-button="true"
            data-category-id="{{ category.id }}">
            Edit
          </button>
          <span class="muted text-button">Expand</span>
        </div>
      </summary>
      <div class="edit-panel hidden" data-edit-panel="true" data-category-id="{{ category.id }}">
        <form method="post" action="{{ url_for('web.admin_update_joke_category', category_id=category.id) }}">
          <div class="edit-flex">
            <label class="text-body field-medium">
              <div class="text-button">Display name</div>
              <input name="display_name" type="text" value="{{ category.display_name }}" required>
            </label>

            <label class="text-body field-small">
              <div class="text-button">State</div>
              <select name="state">
                {% set st = (category.state or 'PROPOSED') | upper %}
                <option value="PROPOSED" {% if st == 'PROPOSED' %}selected{% endif %}>PROPOSED</option>
                <option value="APPROVED" {% if st == 'APPROVED' %}selected{% endif %}>APPROVED</option>
                <option value="SEASONAL" {% if st == 'SEASONAL' %}selected{% endif %}>SEASONAL</option>
                <option value="BOOK" {% if st == 'BOOK' %}selected{% endif %}>BOOK</option>
                <option value="REJECTED" {% if st == 'REJECTED' %}selected{% endif %}>REJECTED</option>
              </select>
            </label>

            <label class="text-body field-small">
              <div class="text-button">Search</div>
              <div style="display: flex; gap: 10px; align-items: center;">
                <input name="joke_description_query" type="text"
                  value="{{ category.joke_description_query or '' }}"
                  style="flex: 1 1 auto; min-width: 0;">
                <input name="search_distance" type="text"
                  inputmode="decimal"
                  placeholder="{{ joke_search_default_threshold }}"
                  title="Optional search distance threshold"
                  value="{{ category.search_distance if category.search_distance is not none else '' }}"
                  style="width: 70px; padding: 8px 6px;">
              </div>
            </label>

            <label class="text-body field-small">
              <div class="text-button">Seasonal name</div>
              <input name="seasonal_name" type="text"
                value="{{ category.seasonal_name or '' }}">
            </label>

            <label class="text-body field-small">
              <div class="text-button">Book ID</div>
              <input name="book_id" type="text"
                placeholder="book-123"
                value="{{ category.book_id or '' }}">
            </label>

            <label class="text-body field-medium">
              <div class="text-button">Tags (comma-separated)</div>
              <input name="tags" type="text"
                value="{{ (category.tags or []) | join(', ') }}">
            </label>

            <label class="text-body field-medium">
              <div class="text-button">Negative tags (comma-separated)</div>
              <input name="negative_tags" type="text"
                value="{{ (category.negative_tags or []) | join(', ') }}">
            </label>

            <label class="text-body field-medium">
              <div class="text-button">Image URL</div>
              <input name="image_url" type="text" value="{{ category.image_url or '' }}">
            </label>

            <label class="text-body field-large">
              <div class="text-button">Image description</div>
              <textarea name="image_description">{{ category.image_description or '' }}</textarea>
            </label>
            
            <input name="joke_id_order" type="hidden" value="{{ (category.joke_id_order or []) | join(',') }}">
          </div>
          <div style="display: flex; justify-content: flex-end; margin-top: 10px; gap: 10px;">
            <button class="text-button" type="button" data-action="reset-order">Reset order</button>
            <button class="text-button" type="submit">Save</button>
          </div>
        </form>
      </div>
      <div class="category-download-actions">
        <button class="text-button" type="button"
          data-generate-lunchbox-notes="true"
          data-category-id="{{ category.id }}">
          Generate lunchbox notes
        </button>
        {% set branded_sheet = category.lunchbox_notes_branded_sheet %}
        {% if branded_sheet %}
        <span class="sheet-preview-link-group">
          <a class="text-button" href="{{ public_file_url_for_gcs(branded_sheet.pdf_gcs_uri) }}" target="_blank" rel="noopener noreferrer">Branded PDF</a>
          <button class="text-button" type="button"
            data-toggle-sheet-images="true"
            data-target-id="branded-images-{{ category.id }}">
            images
          </button>
        </span>
        {% endif %}
        {% set unbranded_sheet = category.lunchbox_notes_unbranded_sheet %}
        {% if unbranded_sheet %}
        <span class="sheet-preview-link-group">
          <a class="text-button" href="{{ public_file_url_for_gcs(unbranded_sheet.pdf_gcs_uri) }}" target="_blank" rel="noopener noreferrer">Unbranded PDF</a>
          <button class="text-button" type="button"
            data-toggle-sheet-images="true"
            data-target-id="unbranded-images-{{ category.id }}">
            images
          </button>
        </span>
        {% endif %}
      </div>
      {% if branded_sheet %}
      <section id="branded-images-{{ category.id }}" class="sheet-preview-panel hidden" data-sheet-images-panel="true">
        <h4 class="text-button">Branded Images</h4>
        <div class="sheet-preview-grid">
          {% for image_url in category.lunchbox_notes_branded_image_urls %}
          <img
            width="1024"
            loading="lazy"
            data-src="{{ image_url }}"
            alt="Branded lunchbox notes preview page {{ loop.index }} for {{ category.display_name }}">
          {% endfor %}
        </div>
      </section>
      {% endif %}
      {% if unbranded_sheet %}
      <section id="unbranded-images-{{ category.id }}" class="sheet-preview-panel hidden" data-sheet-images-panel="true">
        <h4 class="text-button">Unbranded Images</h4>
        <div class="sheet-preview-grid">
          {% for image_url in category.lunchbox_notes_unbranded_image_urls %}
          <img
            width="1024"
            loading="lazy"
            data-src="{{ image_url }}"
            alt="Unbranded lunchbox notes preview page {{ loop.index }} for {{ category.display_name }}">
          {% endfor %}
        </div>
      </section>
      {% endif %}
      <div class="joke-grid" aria-label="Category joke thumbnails">
        {% for joke in category.jokes %}
        <div class="joke-tile" title="{{ joke_tooltip_title_attr(joke) | safe }}" data-joke-id="{{ joke.key }}" draggable="false">
          {% if joke.setup_image_url %}
          <img
            class="joke-thumb"
            width="200"
            height="200"
            loading="lazy"
            data-src="{{ joke.setup_image_url }}"
            alt="Setup image for {{ joke.key }}">
          {% else %}
          <div class="placeholder text-body muted" role="img"
            aria-label="Setup image missing">No image</div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </details>
    {% endfor %}
  </div>
  {% endif %}
{%- endmacro %}

<section class="category-section">
  <h3>Approved <span class="pill text-button">{{ approved_unique_joke_count }} unique jokes</span></h3>
  {{ render_category_list(approved_categories) }}
</section>

<section class="category-section">
  <h3>Seasonal <span class="pill text-button">{{ seasonal_unique_joke_count }} unique jokes</span></h3>
  {{ render_category_list(seasonal_categories) }}
</section>

<section class="category-section">
  <h3>Proposed <span class="pill text-button">{{ proposed_unique_joke_count }} unique jokes</span></h3>
  {{ render_category_list(proposed_categories) }}
</section>

<section class="category-section">
  <h3>Book <span class="pill text-button">{{ book_unique_joke_count }} unique jokes</span></h3>
  {{ render_category_list(book_categories) }}
</section>

<section class="category-section">
  <h3>Rejected <span class="pill text-button">{{ rejected_unique_joke_count }} unique jokes</span></h3>
  {{ render_category_list(rejected_categories) }}
</section>

<section class="category-section">
  <h3>Uncategorized <span class="pill text-button">{{ uncategorized_unique_joke_count }} unique jokes</span></h3>
  <details class="category-details" data-lazy-scope="uncategorized">
    <summary class="text-body">
      <div class="category-meta">
        <strong>Uncategorized</strong>
        <span class="pill text-button">{{ (uncategorized_jokes | length) }} jokes</span>
      </div>
      <span class="muted text-button">Expand</span>
    </summary>
    <div class="joke-grid" aria-label="Uncategorized joke thumbnails">
      {% for joke in uncategorized_jokes %}
      <div class="joke-tile" title="{{ joke_tooltip_title_attr(joke) | safe }}" data-joke-id="{{ joke.key }}">
        {% if joke.setup_image_url %}
        <img
          class="joke-thumb"
          width="200"
          height="200"
          loading="lazy"
          data-src="{{ joke.setup_image_url }}"
          alt="Setup image for {{ joke.key }}">
        {% else %}
        <div class="placeholder text-body muted" role="img"
          aria-label="Setup image missing">No image</div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </details>
</section>

<script>
  (function () {
    const jokeCreationUrl = {{ joke_creation_url | tojson }};

    function hydrateImages(scope) {
      if (!scope) return;
      scope.querySelectorAll('img[data-src]').forEach((img) => {
        img.src = img.dataset.src;
        img.removeAttribute('data-src');
      });
    }

    async function hydrateEditForm(details, categoryId) {
      if (!details || !categoryId) return;
      if (details.dataset.formHydrated === 'true') return;
      if (details.dataset.formHydrating === 'true') return;

      const panel = details.querySelector('[data-edit-panel="true"]');
      if (!panel) return;

      const saveButton = panel.querySelector('button[type="submit"]');
      if (saveButton) saveButton.disabled = true;

      details.dataset.formHydrating = 'true';
      try {
        const resp = await fetch(
          `/admin/joke-categories/${encodeURIComponent(categoryId)}/live`,
          {
            method: 'GET',
            credentials: 'same-origin',
            headers: { 'Accept': 'application/json' },
            cache: 'no-store',
          },
        );
        if (!resp.ok) {
          throw new Error(`Failed fetching live category data (${resp.status})`);
        }

        const data = await resp.json();

        const setInputValue = (name, value) => {
          const input = panel.querySelector(`[name="${name}"]`);
          if (!input) return;
          input.value = value == null ? '' : String(value);
        };

        const setSelectValue = (name, value) => {
          const select = panel.querySelector(`select[name="${name}"]`);
          if (!select) return;
          const target = (value == null ? '' : String(value)).toUpperCase();
          select.value = target;
        };

        setInputValue('display_name', data.display_name);
        setSelectValue('state', data.state);
        setInputValue('joke_description_query', data.joke_description_query);
        setInputValue('search_distance', data.search_distance);
        setInputValue('seasonal_name', data.seasonal_name);
        setInputValue('book_id', data.book_id);
        setInputValue('image_url', data.image_url);

        // List fields are stored as arrays in Firestore, but the form uses CSV.
        const tags = Array.isArray(data.tags) ? data.tags : [];
        const negativeTags = Array.isArray(data.negative_tags)
          ? data.negative_tags
          : [];
        setInputValue('tags', tags.join(', '));
        setInputValue('negative_tags', negativeTags.join(', '));

        const jokeIdOrder = Array.isArray(data.joke_id_order)
          ? data.joke_id_order
          : [];
        setInputValue('joke_id_order', jokeIdOrder.join(','));

        const textarea = panel.querySelector('textarea[name="image_description"]');
        if (textarea) {
          textarea.value = data.image_description == null ? '' : String(data.image_description);
        }

        details.dataset.formHydrated = 'true';
      } catch (err) {
        console.error(err);
        alert('Failed loading live category fields. Please refresh and try again.');
      } finally {
        details.dataset.formHydrating = 'false';
        if (saveButton) saveButton.disabled = false;
      }
    }

    document.querySelectorAll('details.category-details').forEach((details) => {
      details.addEventListener('toggle', () => {
        if (!details.open) return;
        hydrateImages(details);
        // Expanding via summary should never show the edit form.
        details.dataset.editMode = 'false';
        const panel = details.querySelector('[data-edit-panel="true"]');
        if (panel) panel.classList.add('hidden');
        updateDraggableState(details, false);
      });
    });

    document.querySelectorAll('[data-generate-lunchbox-notes="true"]').forEach((button) => {
      button.addEventListener('click', async () => {
        const categoryId = button.dataset.categoryId || '';
        if (!categoryId) {
          alert('Missing category id.');
          return;
        }

        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'Generating...';

        try {
          const resp = await fetch(jokeCreationUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              data: {
                op: 'lunchbox_note',
                category_id: categoryId,
              },
            }),
          });

          if (!resp.ok) {
            const data = await resp.json().catch(() => ({}));
            const error = data?.data?.error || 'Failed to generate lunchbox notes';
            throw new Error(error);
          }

          window.location.href = `/admin/joke-categories?notes_generated=${encodeURIComponent(categoryId)}`;
        } catch (error) {
          console.error('Failed to generate lunchbox notes:', error);
          alert('Failed to generate lunchbox notes: ' + error.message);
          button.disabled = false;
          button.textContent = originalText;
        }
      });
    });

    document.querySelectorAll('[data-toggle-sheet-images="true"]').forEach((button) => {
      button.addEventListener('click', () => {
        const targetId = button.dataset.targetId || '';
        if (!targetId) return;
        const panel = document.getElementById(targetId);
        if (!panel) return;
        panel.classList.toggle('hidden');
        if (!panel.classList.contains('hidden')) {
          hydrateImages(panel);
        }
      });
    });

    const toggleEditPanel = (details, show) => {
      const panel = details.querySelector('[data-edit-panel="true"]');
      if (!panel) return;
      panel.classList.toggle('hidden', !show);
      updateDraggableState(details, show);
    };

    const updateDraggableState = (details, canDrag) => {
      const grid = details.querySelector('.joke-grid');
      if (!grid) return;
      grid.querySelectorAll('.joke-tile').forEach(tile => {
        tile.draggable = canDrag;
        tile.style.cursor = canDrag ? 'move' : 'default';
      });
    };

    document.querySelectorAll('button[data-edit-button="true"]').forEach((btn) => {
      btn.addEventListener('click', (evt) => {
        evt.preventDefault();
        evt.stopPropagation();
        const details = btn.closest('details.category-details');
        if (!details) return;
        details.open = true;
        hydrateImages(details);
        const panel = details.querySelector('[data-edit-panel="true"]');
        const isHidden = panel?.classList.contains('hidden');
        const nextShow = Boolean(isHidden);
        details.dataset.editMode = nextShow ? 'true' : 'false';
        toggleEditPanel(details, nextShow);
        if (nextShow) {
          hydrateEditForm(details, btn.dataset.categoryId);
        }
      });
    });

    // Reset Order Handler
    document.querySelectorAll('button[data-action="reset-order"]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const form = btn.closest('form');
        const input = form.querySelector('input[name="joke_id_order"]');
        if (input) {
           input.value = '';
           alert('Order cleared. Save to apply default sort.');
        }
      });
    });

    // Drag and Drop Logic
    document.querySelectorAll('.joke-grid').forEach(grid => {
      let draggedItem = null;

      grid.addEventListener('dragstart', (e) => {
        const tile = e.target.closest('.joke-tile');
        if (!tile || !tile.draggable) {
          e.preventDefault();
          return;
        }
        draggedItem = tile;
        e.dataTransfer.effectAllowed = 'move';
        // e.dataTransfer.setData('text/plain', tile.dataset.jokeId); // Not strictly needed for internal move
        tile.style.opacity = '0.5';
      });

      grid.addEventListener('dragend', (e) => {
        const tile = e.target.closest('.joke-tile');
        if (tile) tile.style.opacity = '1';
        draggedItem = null;
        
        // Update hidden input
        const details = grid.closest('details.category-details');
        if (details) {
          const input = details.querySelector('input[name="joke_id_order"]');
          if (input) {
             const ids = Array.from(grid.querySelectorAll('.joke-tile'))
               .map(t => t.dataset.jokeId)
               .filter(Boolean);
             input.value = ids.join(',');
          }
        }
      });

      grid.addEventListener('dragover', (e) => {
        e.preventDefault();
        if (!draggedItem) return;
        
        const target = e.target.closest('.joke-tile');
        if (target && target !== draggedItem && grid.contains(target)) {
          const children = Array.from(grid.children);
          const draggedIndex = children.indexOf(draggedItem);
          const targetIndex = children.indexOf(target);
          
          if (draggedIndex < targetIndex) {
            grid.insertBefore(draggedItem, target.nextSibling);
          } else {
            grid.insertBefore(draggedItem, target);
          }
        }
      });
    });

  })();
</script>
{% endblock %}



