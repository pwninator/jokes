{% extends "admin/admin_base.html" %}
{% from "components/joke_picker.html" import joke_picker %}

{% block title %}Joke Media Generator - {{ site_name }} Admin{% endblock %}

{% block content %}
<style>
  .audio-tuner {
    display: flex;
    flex-direction: column;
    gap: 18px;
  }

  .audio-header {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .audio-actions {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 12px;
  }

  .error-banner {
    padding: 10px 12px;
    border-radius: 12px;
    background: rgba(255, 226, 226, 0.6);
    border: 1px solid rgba(200, 60, 60, 0.3);
    color: #7b1d1d;
  }

  .is-hidden {
    display: none;
  }

  .audio-results {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 16px;
  }

  #video-results {
    grid-template-columns: minmax(0, max-content);
    justify-content: start;
  }

  .audio-result-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 16px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .audio-result-card audio {
    width: 100%;
  }

  #video-card {
    width: fit-content;
    max-width: 100%;
  }

  #video-card video {
    display: block;
    width: auto;
    max-width: 4000px;
    height: auto;
  }

  .mono {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
      "Liberation Mono", "Courier New", monospace;
    font-size: 0.82rem;
    overflow-wrap: anywhere;
  }

  .stats-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 16px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 10px;
  }

  .script-template textarea {
    width: 100%;
    min-height: 260px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
      "Liberation Mono", "Courier New", monospace;
  }

  .turn-grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .turn-row {
    display: grid;
    grid-template-columns: minmax(220px, 260px) minmax(0, 1fr) minmax(110px, 140px);
    gap: 12px;
    align-items: start;
  }

  .turn-row select,
  .turn-row textarea,
  .turn-row input {
    width: 100%;
  }

  .turn-row textarea {
    min-height: 64px;
    resize: vertical;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
      "Liberation Mono", "Courier New", monospace;
  }

  @media (max-width: 900px) {
    .turn-row {
      grid-template-columns: 1fr;
    }
  }
</style>

<div class="audio-tuner">
  <div class="audio-header">
    <h2>Joke Media Generator</h2>
    <p class="muted">
      Pick a joke, generate the dialog audio, and preview the audio clips plus the slideshow video.
    </p>
  </div>

  <div id="error-banner" class="error-banner {% if not error_message %}is-hidden{% endif %}">
    <span id="error-banner-text">{% if error_message %}{{ error_message }}{% endif %}</span>
  </div>

  <section class="card" aria-label="Dialog turn template">
    <h3>Dialog turns</h3>
    <p class="muted small">
      Each row is a dialog turn with a voice, script, and optional pause_sec_after.
      Scripts can use {setup_text} and {punchline_text} placeholders.
    </p>
    <div style="max-width: 360px; margin-bottom: 12px;">
      <label for="audio-model" class="muted small">Audio model</label>
      <select id="audio-model">
        {% for model in audio_models %}
          <option value="{{ model.value }}" {% if model.value == default_audio_model %}selected{% endif %}>
            {{ model.label }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="turn-grid">
      {% for idx in range(3) %}
        {% set turn = default_dialog_turns[idx] if default_dialog_turns and (default_dialog_turns|length > idx) else {} %}
        <div class="turn-row">
          <div>
            <label for="turn{{ idx + 1 }}-voice-gemini" class="muted small">Voice</label>
            <select id="turn{{ idx + 1 }}-voice-gemini">
              {% for voice in gemini_voices %}
                <option value="{{ voice.value }}" {% if voice.value == turn.voice %}selected{% endif %}>
                  {{ voice.label }}
                </option>
              {% endfor %}
            </select>
            <select id="turn{{ idx + 1 }}-voice-eleven" class="is-hidden" disabled>
              {% for voice in elevenlabs_voices %}
                {% set default_voice = default_elevenlabs_voice_names[idx] if default_elevenlabs_voice_names and (default_elevenlabs_voice_names|length > idx) else '' %}
                <option value="{{ voice.value }}" {% if voice.value == default_voice %}selected{% endif %}>
                  {{ voice.label }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="turn{{ idx + 1 }}-script" class="muted small">Script</label>
            <textarea id="turn{{ idx + 1 }}-script" rows="2">{{ turn.script or '' }}</textarea>
          </div>
          <div>
            <label for="turn{{ idx + 1 }}-pause-after" class="muted small">Pause after</label>
            <input id="turn{{ idx + 1 }}-pause-after" type="number" step="0.1" min="0" placeholder="(sec)"
                   value="{% if turn.pause_sec_after is not none %}{{ turn.pause_sec_after }}{% endif %}">
          </div>
        </div>
      {% endfor %}
    </div>
  </section>

  <section id="video-results" class="audio-results is-hidden" aria-label="Generated video">
    <div class="audio-result-card" id="video-card">
      <h3>Video</h3>
      <video id="joke-video" controls></video>
      <div class="muted mono" id="video-uri"></div>
    </div>
  </section>

  <section id="audio-results" class="audio-results is-hidden" aria-label="Generated audio">
    <div class="stats-card" id="audio-stats-card">
      <h3>Generation stats</h3>
      <div class="stats-grid">
        <div>
          <div class="muted small">Model</div>
          <div class="mono" id="audio-meta-model"></div>
        </div>
        <div>
          <div class="muted small">Cost (USD)</div>
          <div class="mono" id="audio-meta-cost"></div>
        </div>
        <div>
          <div class="muted small">Prompt tokens</div>
          <div class="mono" id="audio-meta-prompt-tokens"></div>
        </div>
        <div>
          <div class="muted small">Output tokens</div>
          <div class="mono" id="audio-meta-output-tokens"></div>
        </div>
      </div>
      <details>
        <summary class="muted small">Raw token counts</summary>
        <pre class="mono" id="audio-meta-token-counts" style="margin: 0; white-space: pre-wrap;"></pre>
      </details>
    </div>
    <div class="audio-result-card" id="dialog-card">
      <h3>Full dialog</h3>
      <audio id="dialog-audio" controls></audio>
      <div class="muted mono" id="dialog-uri"></div>
    </div>
    <div class="audio-result-card" id="setup-card">
      <h3>Setup</h3>
      <audio id="setup-audio" controls></audio>
      <div class="muted mono" id="setup-uri"></div>
    </div>
    <div class="audio-result-card" id="response-card">
      <h3>Response</h3>
      <audio id="response-audio" controls></audio>
      <div class="muted mono" id="response-uri"></div>
    </div>
    <div class="audio-result-card" id="punchline-card">
      <h3>Punchline</h3>
      <audio id="punchline-audio" controls></audio>
      <div class="muted mono" id="punchline-uri"></div>
    </div>
  </section>

  <form id="video-tuner-form" class="card" method="GET">
    <input type="hidden" name="op" value="{{ joke_video_op }}">
    <div class="audio-actions">
      <button id="generate-video-button" type="button" class="text-button" disabled>Generate Video</button>
    </div>
  </form>

  <form id="audio-tuner-form" class="card" method="GET">
    <input type="hidden" name="op" value="{{ joke_audio_op }}">
    <div class="audio-actions">
      <button id="generate-audio-button" type="button" class="text-button" disabled>Generate Audio</button>
    </div>
  </form>

  <div class="card">
    {{ joke_picker('joke-media-generator-picker') }}
  </div>
</div>

<script src="/static/js/joke_picker.js"></script>
<script>
  (function () {
    const audioForm = document.getElementById('audio-tuner-form');
    const videoForm = document.getElementById('video-tuner-form');
    const generateAudioButton = document.getElementById('generate-audio-button');
    const generateVideoButton = document.getElementById('generate-video-button');
    const errorBanner = document.getElementById('error-banner');
    const errorBannerText = document.getElementById('error-banner-text');
    const results = document.getElementById('audio-results');
    const videoResults = document.getElementById('video-results');
    const audioModelInput = document.getElementById('audio-model');
    const dialogTurns = [
      {
        geminiVoice: document.getElementById('turn1-voice-gemini'),
        elevenVoice: document.getElementById('turn1-voice-eleven'),
        script: document.getElementById('turn1-script'),
        pauseAfter: document.getElementById('turn1-pause-after'),
      },
      {
        geminiVoice: document.getElementById('turn2-voice-gemini'),
        elevenVoice: document.getElementById('turn2-voice-eleven'),
        script: document.getElementById('turn2-script'),
        pauseAfter: document.getElementById('turn2-pause-after'),
      },
      {
        geminiVoice: document.getElementById('turn3-voice-gemini'),
        elevenVoice: document.getElementById('turn3-voice-eleven'),
        script: document.getElementById('turn3-script'),
        pauseAfter: document.getElementById('turn3-pause-after'),
      },
    ];

    const dialogAudio = document.getElementById('dialog-audio');
    const setupAudio = document.getElementById('setup-audio');
    const responseAudio = document.getElementById('response-audio');
    const punchlineAudio = document.getElementById('punchline-audio');
    const jokeVideo = document.getElementById('joke-video');

    const dialogUri = document.getElementById('dialog-uri');
    const setupUri = document.getElementById('setup-uri');
    const responseUri = document.getElementById('response-uri');
    const punchlineUri = document.getElementById('punchline-uri');
    const videoUri = document.getElementById('video-uri');

    const metaModel = document.getElementById('audio-meta-model');
    const metaCost = document.getElementById('audio-meta-cost');
    const metaPromptTokens = document.getElementById('audio-meta-prompt-tokens');
    const metaOutputTokens = document.getElementById('audio-meta-output-tokens');
    const metaTokenCounts = document.getElementById('audio-meta-token-counts');

    const jokeCreationUrl = {{ joke_creation_url | tojson }};

    function showError(message) {
      if (errorBannerText) {
        errorBannerText.textContent = message || 'Audio generation failed';
      }
      if (errorBanner) {
        errorBanner.classList.remove('is-hidden');
      }
    }

    function clearError() {
      if (errorBannerText) {
        errorBannerText.textContent = '';
      }
      if (errorBanner) {
        errorBanner.classList.add('is-hidden');
      }
    }

    function hideResults() {
      if (videoResults) {
        videoResults.classList.add('is-hidden');
      }
      if (results) {
        results.classList.add('is-hidden');
      }
      [dialogAudio, setupAudio, responseAudio, punchlineAudio].forEach((el) => {
        if (!el) return;
        el.pause();
        el.removeAttribute('src');
        el.load();
      });
      if (jokeVideo) {
        jokeVideo.pause();
        jokeVideo.removeAttribute('src');
        jokeVideo.load();
      }
      if (dialogUri) dialogUri.textContent = '';
      if (setupUri) setupUri.textContent = '';
      if (responseUri) responseUri.textContent = '';
      if (punchlineUri) punchlineUri.textContent = '';
      if (videoUri) videoUri.textContent = '';
      if (metaModel) metaModel.textContent = '';
      if (metaCost) metaCost.textContent = '';
      if (metaPromptTokens) metaPromptTokens.textContent = '';
      if (metaOutputTokens) metaOutputTokens.textContent = '';
      if (metaTokenCounts) metaTokenCounts.textContent = '';
    }

    function setLoading(button, isLoading, label) {
      if (!button) return;
      button.disabled = Boolean(isLoading);
      button.textContent = isLoading ? 'Generatingâ€¦' : label;
    }

    function gcsToCdnUrl(gcsUri) {
      if (!gcsUri) return '';
      return 'https://' + String(gcsUri).replace(/^gs:\/\//, '');
    }

    function setAudioResult(audioEl, uriEl, gcsUri) {
      if (!audioEl || !uriEl) return false;
      if (!gcsUri) {
        audioEl.pause();
        audioEl.removeAttribute('src');
        audioEl.load();
        uriEl.textContent = '';
        return false;
      }
      const url = gcsToCdnUrl(gcsUri);
      audioEl.src = url;
      uriEl.textContent = gcsUri;
      return true;
    }

    function populateAudioResults(data) {
      const dialogGcs = data?.dialog_audio_gcs_uri;
      const setupGcs = data?.setup_audio_gcs_uri;
      const responseGcs = data?.response_audio_gcs_uri;
      const punchlineGcs = data?.punchline_audio_gcs_uri;

      const hasDialog = setAudioResult(dialogAudio, dialogUri, dialogGcs);
      const hasSetup = setAudioResult(setupAudio, setupUri, setupGcs);
      const hasResponse = setAudioResult(responseAudio, responseUri, responseGcs);
      const hasPunchline = setAudioResult(punchlineAudio, punchlineUri, punchlineGcs);

      return hasDialog || hasSetup || hasResponse || hasPunchline;
    }

    function populateAudioMeta(meta) {
      const tokenCounts = meta?.token_counts || {};
      if (metaModel) metaModel.textContent = meta?.model_name || '';
      if (metaCost) {
        const costValue = typeof meta?.cost === 'number' ? meta.cost : null;
        metaCost.textContent = costValue === null ? '' : costValue.toFixed(6);
      }
      if (metaPromptTokens) metaPromptTokens.textContent = String(tokenCounts.prompt_tokens ?? '');
      if (metaOutputTokens) metaOutputTokens.textContent = String(tokenCounts.output_tokens ?? '');
      if (metaTokenCounts) metaTokenCounts.textContent = JSON.stringify(tokenCounts, null, 2);
    }

    if (!audioForm || !videoForm || !generateAudioButton || !generateVideoButton || !window.JokePicker) {
      return;
    }

    function isElevenLabsModel(modelValue) {
      return String(modelValue || '').startsWith('eleven');
    }

    function syncVoiceInputs() {
      const modelValue = audioModelInput?.value || '';
      const showElevenLabs = isElevenLabsModel(modelValue);
      dialogTurns.forEach((row) => {
        if (row.geminiVoice) {
          row.geminiVoice.disabled = showElevenLabs;
          row.geminiVoice.classList.toggle('is-hidden', showElevenLabs);
        }
        if (row.elevenVoice) {
          row.elevenVoice.disabled = !showElevenLabs;
          row.elevenVoice.classList.toggle('is-hidden', !showElevenLabs);
        }
      });
    }

    if (audioModelInput) {
      audioModelInput.addEventListener('change', syncVoiceInputs);
    }
    syncVoiceInputs();

    const picker = new window.JokePicker({
      container: '#joke-media-generator-picker',
      states: ['DAILY', 'PUBLISHED'],
      publicOnly: true,
      maxSelection: 1,
      onSelectionChange: (selection) => {
        const disable = selection.length !== 1;
        generateAudioButton.disabled = disable;
        generateVideoButton.disabled = disable;
      },
    });

    function buildDialogTurnTemplate() {
      const turns = [];
      const modelValue = (audioModelInput?.value || '').trim();
      const useElevenLabs = isElevenLabsModel(modelValue);
      dialogTurns.forEach((row, idx) => {
        const voice = useElevenLabs ? (row.elevenVoice?.value || '').trim() : (row.geminiVoice?.value || '').trim();
        const script = (row.script?.value || '').trim();
        const pauseAfterRaw = (row.pauseAfter?.value || '').trim();

        if (!voice && !script && !pauseAfterRaw) {
          return;
        }

        if (!voice) {
          throw new Error(`Turn ${idx + 1} voice is required.`);
        }
        if (!script) {
          throw new Error(`Turn ${idx + 1} script is required.`);
        }

        const turn = { voice, script };
        if (pauseAfterRaw) {
          const pauseAfter = Number(pauseAfterRaw);
          if (!Number.isFinite(pauseAfter) || pauseAfter < 0) {
            throw new Error(`Turn ${idx + 1} pause_sec_after must be a number >= 0.`);
          }
          turn.pause_sec_after = pauseAfter;
        }
        turns.push(turn);
      });

      if (!turns.length) {
        throw new Error('At least one dialog turn is required.');
      }
      return turns;
    }

    async function requestGeneration(requestUrl, opValue, jokeId, extraData) {
      const resp = await fetch(requestUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
          data: {
            op: opValue,
            joke_id: jokeId,
            ...(extraData || {}),
          },
        }),
      });

      let json = null;
      try {
        json = await resp.json();
      } catch (e) {
        json = null;
      }
      const data = json && json.data ? json.data : {};
      if (!resp.ok) {
        throw new Error(data.error || `Request failed (${resp.status})`);
      }
      return data;
    }

    generateAudioButton.addEventListener('click', async function () {
      clearError();
      hideResults();
      setLoading(generateAudioButton, true, 'Generate Audio');

      const selected = picker ? picker.getSelectedJokes() : [];
      if (!selected || selected.length !== 1) {
        setLoading(generateAudioButton, false, 'Generate Audio');
        showError('Please select exactly one joke.');
        return;
      }

      const jokeId = selected[0].id;
      const opValue = (audioForm.querySelector('input[name="op"]') || {}).value;

      try {
        const data = await requestGeneration(jokeCreationUrl, opValue, jokeId, {
          audio_model: (audioModelInput?.value || '').trim(),
          script_template: buildDialogTurnTemplate(),
          allow_partial: true,
        });

        const hasAnyAudio = populateAudioResults(data);
        const meta = data.audio_generation_metadata || {};
        populateAudioMeta(meta);

        if (!hasAnyAudio) {
          showError(data?.error || 'Audio generation succeeded but returned no URIs');
          return;
        }

        if (data?.error) {
          showError(data.error);
        }

        results.classList.remove('is-hidden');
      } catch (err) {
        showError(String(err || 'Unexpected error'));
      } finally {
        setLoading(generateAudioButton, false, 'Generate Audio');
      }
    });

    function extractAudioGeneration(meta) {
      if (!meta) return null;
      const generations = Array.isArray(meta.generations) ? meta.generations : [];
      const candidates = generations.filter((gen) => gen && typeof gen === 'object');

      const withTokenCounts = candidates.find((gen) => {
        const tokenCounts = gen?.token_counts || {};
        return tokenCounts.prompt_tokens || tokenCounts.output_tokens;
      });
      if (withTokenCounts) return withTokenCounts;

      const withCost = candidates.find((gen) => {
        const cost = gen?.cost;
        return typeof cost === 'number' && Number.isFinite(cost) && cost !== 0;
      });
      if (withCost) return withCost;

      return candidates.find((gen) => Boolean(gen?.model_name)) || candidates[0] || null;
    }

    generateVideoButton.addEventListener('click', async function () {
      clearError();
      hideResults();
      setLoading(generateVideoButton, true, 'Generate Video');

      const selected = picker ? picker.getSelectedJokes() : [];
      if (!selected || selected.length !== 1) {
        setLoading(generateVideoButton, false, 'Generate Video');
        showError('Please select exactly one joke.');
        return;
      }

      const jokeId = selected[0].id;
      const opValue = (videoForm.querySelector('input[name="op"]') || {}).value;

      try {
        const data = await requestGeneration(jokeCreationUrl, opValue, jokeId, {
          audio_model: (audioModelInput?.value || '').trim(),
          script_template: buildDialogTurnTemplate(),
          allow_partial: true,
        });
        const videoGcs = data.video_gcs_uri;
        const meta = data.video_generation_metadata || {};
        const hasAnyAudio = populateAudioResults(data);

        const audioMeta = data.audio_generation_metadata || extractAudioGeneration(meta);
        if (audioMeta) {
          populateAudioMeta(audioMeta);
        }

        if (hasAnyAudio && results) {
          results.classList.remove('is-hidden');
        }

        if (videoGcs) {
          const videoUrl = gcsToCdnUrl(videoGcs);
          if (jokeVideo) {
            jokeVideo.src = videoUrl;
          }
          if (videoUri) {
            videoUri.textContent = videoGcs;
          }
          if (videoResults) {
            videoResults.classList.remove('is-hidden');
          }
        }

        if (data?.error) {
          showError(data.error);
          return;
        }

        if (!videoGcs && !hasAnyAudio) {
          showError('Video generation succeeded but returned no media URIs');
        } else if (!videoGcs) {
          showError('Video generation failed, but audio was generated.');
        }
      } catch (err) {
        showError(String(err || 'Unexpected error'));
      } finally {
        setLoading(generateVideoButton, false, 'Generate Video');
      }
    });
  })();
</script>
{% endblock %}

