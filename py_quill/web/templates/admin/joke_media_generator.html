{% extends "admin/admin_base.html" %}
{% from "components/joke_picker.html" import joke_picker %}

{% block title %}Joke Media Generator - {{ site_name }} Admin{% endblock %}

{% block content %}
<style>
  .audio-tuner {
    display: flex;
    flex-direction: column;
    gap: 18px;
  }

  .audio-header {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .audio-actions {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 12px;
  }

  .error-banner {
    padding: 10px 12px;
    border-radius: 12px;
    background: rgba(255, 226, 226, 0.6);
    border: 1px solid rgba(200, 60, 60, 0.3);
    color: #7b1d1d;
  }

  .is-hidden {
    display: none;
  }

  .audio-results {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 16px;
  }

  #video-results {
    grid-template-columns: minmax(0, max-content);
    justify-content: start;
  }

  .audio-result-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 16px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .audio-result-card audio {
    width: 100%;
  }

  #video-card {
    width: fit-content;
    max-width: 100%;
  }

  #video-card video {
    display: block;
    width: auto;
    max-width: 400px;
    height: auto;
  }

  .mono {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
      "Liberation Mono", "Courier New", monospace;
    font-size: 0.82rem;
    overflow-wrap: anywhere;
  }

  .stats-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 16px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 10px;
  }

  .script-template textarea {
    width: 100%;
    min-height: 260px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
      "Liberation Mono", "Courier New", monospace;
  }

  .speaker-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 12px;
  }

  .speaker-grid input {
    width: 100%;
  }
</style>

<div class="audio-tuner">
  <div class="audio-header">
    <h2>Joke Media Generator</h2>
    <p class="muted">
      Pick a joke, generate the dialog audio, and preview the audio clips plus the slideshow video.
    </p>
  </div>

  <div id="error-banner" class="error-banner {% if not error_message %}is-hidden{% endif %}">
    <span id="error-banner-text">{% if error_message %}{{ error_message }}{% endif %}</span>
  </div>

  <section class="card script-template" aria-label="Script template">
    <h3>Script template</h3>
    <p class="muted small">
      Use {setup_text} and {punchline_text} placeholders in the script.
    </p>
    <textarea id="script-template" rows="14">{{ default_script_template }}</textarea>
  </section>

  <section class="card" aria-label="Speakers and voices">
    <h3>Speakers + voices</h3>
    <div class="speaker-grid">
      <div>
        <label for="speaker1-name" class="muted small">Speaker 1</label>
        <input id="speaker1-name" type="text" value="{{ default_speaker1_name }}">
      </div>
      <div>
        <label for="speaker1-voice" class="muted small">Voice 1</label>
        <input id="speaker1-voice" type="text" value="{{ default_speaker1_voice }}">
      </div>
      <div>
        <label for="speaker2-name" class="muted small">Speaker 2</label>
        <input id="speaker2-name" type="text" value="{{ default_speaker2_name }}">
      </div>
      <div>
        <label for="speaker2-voice" class="muted small">Voice 2</label>
        <input id="speaker2-voice" type="text" value="{{ default_speaker2_voice }}">
      </div>
    </div>
  </section>

  <section id="video-results" class="audio-results is-hidden" aria-label="Generated video">
    <div class="audio-result-card" id="video-card">
      <h3>Video</h3>
      <video id="joke-video" controls></video>
      <div class="muted mono" id="video-uri"></div>
    </div>
  </section>

  <section id="audio-results" class="audio-results is-hidden" aria-label="Generated audio">
    <div class="stats-card" id="audio-stats-card">
      <h3>Generation stats</h3>
      <div class="stats-grid">
        <div>
          <div class="muted small">Model</div>
          <div class="mono" id="audio-meta-model"></div>
        </div>
        <div>
          <div class="muted small">Cost (USD)</div>
          <div class="mono" id="audio-meta-cost"></div>
        </div>
        <div>
          <div class="muted small">Prompt tokens</div>
          <div class="mono" id="audio-meta-prompt-tokens"></div>
        </div>
        <div>
          <div class="muted small">Output tokens</div>
          <div class="mono" id="audio-meta-output-tokens"></div>
        </div>
      </div>
      <details>
        <summary class="muted small">Raw token counts</summary>
        <pre class="mono" id="audio-meta-token-counts" style="margin: 0; white-space: pre-wrap;"></pre>
      </details>
    </div>
    <div class="audio-result-card" id="dialog-card">
      <h3>Full dialog</h3>
      <audio id="dialog-audio" controls></audio>
      <div class="muted mono" id="dialog-uri"></div>
    </div>
    <div class="audio-result-card" id="setup-card">
      <h3>Setup</h3>
      <audio id="setup-audio" controls></audio>
      <div class="muted mono" id="setup-uri"></div>
    </div>
    <div class="audio-result-card" id="response-card">
      <h3>Response</h3>
      <audio id="response-audio" controls></audio>
      <div class="muted mono" id="response-uri"></div>
    </div>
    <div class="audio-result-card" id="punchline-card">
      <h3>Punchline</h3>
      <audio id="punchline-audio" controls></audio>
      <div class="muted mono" id="punchline-uri"></div>
    </div>
  </section>

  <form id="video-tuner-form" class="card" method="GET">
    <input type="hidden" name="op" value="{{ joke_video_op }}">
    <div class="audio-actions">
      <button id="generate-video-button" type="button" class="text-button" disabled>Generate Video</button>
    </div>
  </form>

  <form id="audio-tuner-form" class="card" method="GET">
    <input type="hidden" name="op" value="{{ joke_audio_op }}">
    <div class="audio-actions">
      <button id="generate-audio-button" type="button" class="text-button" disabled>Generate Audio</button>
    </div>
  </form>

  <div class="card">
    {{ joke_picker('joke-media-generator-picker') }}
  </div>
</div>

<script src="/static/js/joke_picker.js"></script>
<script>
  (function () {
    const audioForm = document.getElementById('audio-tuner-form');
    const videoForm = document.getElementById('video-tuner-form');
    const generateAudioButton = document.getElementById('generate-audio-button');
    const generateVideoButton = document.getElementById('generate-video-button');
    const errorBanner = document.getElementById('error-banner');
    const errorBannerText = document.getElementById('error-banner-text');
    const results = document.getElementById('audio-results');
    const videoResults = document.getElementById('video-results');
    const scriptTemplateInput = document.getElementById('script-template');
    const speaker1NameInput = document.getElementById('speaker1-name');
    const speaker1VoiceInput = document.getElementById('speaker1-voice');
    const speaker2NameInput = document.getElementById('speaker2-name');
    const speaker2VoiceInput = document.getElementById('speaker2-voice');

    const dialogAudio = document.getElementById('dialog-audio');
    const setupAudio = document.getElementById('setup-audio');
    const responseAudio = document.getElementById('response-audio');
    const punchlineAudio = document.getElementById('punchline-audio');
    const jokeVideo = document.getElementById('joke-video');

    const dialogUri = document.getElementById('dialog-uri');
    const setupUri = document.getElementById('setup-uri');
    const responseUri = document.getElementById('response-uri');
    const punchlineUri = document.getElementById('punchline-uri');
    const videoUri = document.getElementById('video-uri');

    const metaModel = document.getElementById('audio-meta-model');
    const metaCost = document.getElementById('audio-meta-cost');
    const metaPromptTokens = document.getElementById('audio-meta-prompt-tokens');
    const metaOutputTokens = document.getElementById('audio-meta-output-tokens');
    const metaTokenCounts = document.getElementById('audio-meta-token-counts');

    const jokeCreationUrl = {{ joke_creation_url | tojson }};

    function showError(message) {
      if (errorBannerText) {
        errorBannerText.textContent = message || 'Audio generation failed';
      }
      if (errorBanner) {
        errorBanner.classList.remove('is-hidden');
      }
    }

    function clearError() {
      if (errorBannerText) {
        errorBannerText.textContent = '';
      }
      if (errorBanner) {
        errorBanner.classList.add('is-hidden');
      }
    }

    function hideResults() {
      if (videoResults) {
        videoResults.classList.add('is-hidden');
      }
      if (results) {
        results.classList.add('is-hidden');
      }
      [dialogAudio, setupAudio, responseAudio, punchlineAudio].forEach((el) => {
        if (!el) return;
        el.pause();
        el.removeAttribute('src');
        el.load();
      });
      if (jokeVideo) {
        jokeVideo.pause();
        jokeVideo.removeAttribute('src');
        jokeVideo.load();
      }
      if (dialogUri) dialogUri.textContent = '';
      if (setupUri) setupUri.textContent = '';
      if (responseUri) responseUri.textContent = '';
      if (punchlineUri) punchlineUri.textContent = '';
      if (videoUri) videoUri.textContent = '';
      if (metaModel) metaModel.textContent = '';
      if (metaCost) metaCost.textContent = '';
      if (metaPromptTokens) metaPromptTokens.textContent = '';
      if (metaOutputTokens) metaOutputTokens.textContent = '';
      if (metaTokenCounts) metaTokenCounts.textContent = '';
    }

    function setLoading(button, isLoading, label) {
      if (!button) return;
      button.disabled = Boolean(isLoading);
      button.textContent = isLoading ? 'Generatingâ€¦' : label;
    }

    function gcsToCdnUrl(gcsUri) {
      if (!gcsUri) return '';
      return 'https://' + String(gcsUri).replace(/^gs:\/\//, '');
    }

    if (!audioForm || !videoForm || !generateAudioButton || !generateVideoButton || !window.JokePicker) {
      return;
    }

    const picker = new window.JokePicker({
      container: '#joke-media-generator-picker',
      states: ['DAILY', 'PUBLISHED'],
      publicOnly: true,
      maxSelection: 1,
      onSelectionChange: (selection) => {
        const disable = selection.length !== 1;
        generateAudioButton.disabled = disable;
        generateVideoButton.disabled = disable;
      },
    });

    function buildSpeakerVoicePairs() {
      const pairs = [];
      const speaker1Name = (speaker1NameInput?.value || '').trim();
      const speaker1Voice = (speaker1VoiceInput?.value || '').trim();
      const speaker2Name = (speaker2NameInput?.value || '').trim();
      const speaker2Voice = (speaker2VoiceInput?.value || '').trim();

      if ((speaker1Name && !speaker1Voice) || (!speaker1Name && speaker1Voice)) {
        throw new Error('Speaker 1 name and voice must both be filled in.');
      }
      if ((speaker2Name && !speaker2Voice) || (!speaker2Name && speaker2Voice)) {
        throw new Error('Speaker 2 name and voice must both be filled in.');
      }

      if (speaker1Name && speaker1Voice) {
        pairs.push(`${speaker1Name}:${speaker1Voice}`);
      }
      if (speaker2Name && speaker2Voice) {
        pairs.push(`${speaker2Name}:${speaker2Voice}`);
      }

      return pairs.join('|');
    }

    async function requestGeneration(requestUrl, opValue, jokeId, extraData) {
      const resp = await fetch(requestUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
          data: {
            op: opValue,
            joke_id: jokeId,
            ...(extraData || {}),
          },
        }),
      });

      let json = null;
      try {
        json = await resp.json();
      } catch (e) {
        json = null;
      }
      const data = json && json.data ? json.data : {};
      if (!resp.ok) {
        throw new Error(data.error || `Request failed (${resp.status})`);
      }
      return data;
    }

    generateAudioButton.addEventListener('click', async function () {
      clearError();
      hideResults();
      setLoading(generateAudioButton, true, 'Generate Audio');

      const selected = picker ? picker.getSelectedJokes() : [];
      if (!selected || selected.length !== 1) {
        setLoading(generateAudioButton, false, 'Generate Audio');
        showError('Please select exactly one joke.');
        return;
      }

      const jokeId = selected[0].id;
      const opValue = (audioForm.querySelector('input[name="op"]') || {}).value;

      try {
        const data = await requestGeneration(jokeCreationUrl, opValue, jokeId, {
          script_template: scriptTemplateInput?.value || '',
          speaker_voice_pairs: buildSpeakerVoicePairs(),
        });

        const dialogGcs = data.dialog_audio_gcs_uri;
        const setupGcs = data.setup_audio_gcs_uri;
        const responseGcs = data.response_audio_gcs_uri;
        const punchlineGcs = data.punchline_audio_gcs_uri;
        const meta = data.audio_generation_metadata || {};

        if (!dialogGcs || !setupGcs || !responseGcs || !punchlineGcs) {
          showError('Audio generation succeeded but returned no URIs');
          return;
        }

        const dialogUrl = gcsToCdnUrl(dialogGcs);
        const setupUrl = gcsToCdnUrl(setupGcs);
        const responseUrl = gcsToCdnUrl(responseGcs);
        const punchlineUrl = gcsToCdnUrl(punchlineGcs);

        dialogAudio.src = dialogUrl;
        setupAudio.src = setupUrl;
        responseAudio.src = responseUrl;
        punchlineAudio.src = punchlineUrl;

        dialogUri.textContent = dialogGcs;
        setupUri.textContent = setupGcs;
        responseUri.textContent = responseGcs;
        punchlineUri.textContent = punchlineGcs;

        const tokenCounts = meta.token_counts || {};
        if (metaModel) metaModel.textContent = meta.model_name || '';
        if (metaCost) {
          const costValue = typeof meta.cost === 'number' ? meta.cost : null;
          metaCost.textContent = costValue === null ? '' : costValue.toFixed(6);
        }
        if (metaPromptTokens) metaPromptTokens.textContent = String(tokenCounts.prompt_tokens ?? '');
        if (metaOutputTokens) metaOutputTokens.textContent = String(tokenCounts.output_tokens ?? '');
        if (metaTokenCounts) metaTokenCounts.textContent = JSON.stringify(tokenCounts, null, 2);

        results.classList.remove('is-hidden');
      } catch (err) {
        showError(String(err || 'Unexpected error'));
      } finally {
        setLoading(generateAudioButton, false, 'Generate Audio');
      }
    });

    function extractAudioGeneration(meta) {
      if (!meta) return null;
      const generations = Array.isArray(meta.generations) ? meta.generations : [];
      return generations.find((gen) => {
        const tokenCounts = gen?.token_counts || {};
        return tokenCounts.prompt_tokens || tokenCounts.output_tokens;
      }) || null;
    }

    generateVideoButton.addEventListener('click', async function () {
      clearError();
      hideResults();
      setLoading(generateVideoButton, true, 'Generate Video');

      const selected = picker ? picker.getSelectedJokes() : [];
      if (!selected || selected.length !== 1) {
        setLoading(generateVideoButton, false, 'Generate Video');
        showError('Please select exactly one joke.');
        return;
      }

      const jokeId = selected[0].id;
      const opValue = (videoForm.querySelector('input[name="op"]') || {}).value;

      try {
        const data = await requestGeneration(jokeCreationUrl, opValue, jokeId, {
          script_template: scriptTemplateInput?.value || '',
          speaker_voice_pairs: buildSpeakerVoicePairs(),
        });
        const videoGcs = data.video_gcs_uri;
        const meta = data.video_generation_metadata || {};
        if (!videoGcs) {
          showError('Video generation succeeded but returned no URI');
          return;
        }

        const videoUrl = gcsToCdnUrl(videoGcs);
        if (jokeVideo) {
          jokeVideo.src = videoUrl;
        }
        if (videoUri) {
          videoUri.textContent = videoGcs;
        }
        if (videoResults) {
          videoResults.classList.remove('is-hidden');
        }

        const audioMeta = extractAudioGeneration(meta);
        if (audioMeta) {
          const tokenCounts = audioMeta.token_counts || {};
          if (metaModel) metaModel.textContent = audioMeta.model_name || '';
          if (metaCost) {
            const costValue = typeof audioMeta.cost === 'number' ? audioMeta.cost : null;
            metaCost.textContent = costValue === null ? '' : costValue.toFixed(6);
          }
          if (metaPromptTokens) metaPromptTokens.textContent = String(tokenCounts.prompt_tokens ?? '');
          if (metaOutputTokens) metaOutputTokens.textContent = String(tokenCounts.output_tokens ?? '');
          if (metaTokenCounts) metaTokenCounts.textContent = JSON.stringify(tokenCounts, null, 2);
          if (results) {
            results.classList.remove('is-hidden');
          }
        }
      } catch (err) {
        showError(String(err || 'Unexpected error'));
      } finally {
        setLoading(generateVideoButton, false, 'Generate Video');
      }
    });
  })();
</script>
{% endblock %}

