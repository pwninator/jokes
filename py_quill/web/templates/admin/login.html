{% extends "root.html" %}

{% block title %}Admin Sign In Â· {{ site_name }}{% endblock %}

{% block body %}
<div class="site-shell">
  <header class="site-header">
    <div class="header-inner">
      <a class="brand" href="{{ url_for('web.index') }}" aria-label="{{ site_name }} home">
        <img class="brand-logo" alt="{{ site_name }} logo"
          src="https://images.quillsstorybook.com/cdn-cgi/image/width=128,format=auto,quality=60/_joke_assets/icon_cookie_01_transparent_light_128.png" />
        <span class="brand-text text-brand">{{ site_name }}</span>
      </a>
      <nav class="primary-nav" aria-label="Main navigation">
        <a class="nav-cta text-button" href="https://play.google.com/store/apps/details?id=com.builtwithporpoise.jokes"
          target="_blank" rel="noopener noreferrer">
          Get the App
        </a>
      </nav>
    </div>
  </header>
  <main class="site-main">
    <div class="main-container">
      <section class="centered-section" aria-label="Admin login">
        <article class="hero-card centered-card">
          <h1 class="text-section-heading">{{ site_name }} Admin</h1>
          <p class="text-body">Sign in with Google using an account that has admin access.</p>
          <button id="google-signin" class="nav-cta text-button" type="button">Continue with Google</button>
          <div id="login-error" class="form-error" role="alert"></div>
        </article>
      </section>
    </div>
  </main>
  <footer class="site-footer">
    <div class="site-footer__inner text-footer">
      <small>&copy; {{ site_name }} {{ now_year|default(2025) }}</small>
      <a class="site-footer__link"
        href="/privacy.html"
        target="_blank"
        rel="noopener noreferrer"
        data-analytics-event="web_footer_privacy_click"
        data-analytics-label="privacy_policy">
        Privacy Policy
      </a>
    </div>
  </footer>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="module">
  const firebaseConfig = {{ firebase_config | tojson }};
  const nextUrl = {{ next_url | tojson }};
  const errorEl = document.getElementById('login-error');
  const button = document.getElementById('google-signin');

  if (button) {
    function showError(message) {
      if (!errorEl) return;
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }

    button.addEventListener('click', async () => {
      if (errorEl) {
        errorEl.style.display = 'none';
      }
      button.disabled = true;
      try {
        const app = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js');
        const authModule = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');

        const initializedApp = app.getApps().length
          ? app.getApp()
          : app.initializeApp(firebaseConfig);
        const auth = authModule.getAuth(initializedApp);
        auth.languageCode = 'en';

        const provider = new authModule.GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });

        const result = await authModule.signInWithPopup(auth, provider);
        const idToken = await result.user.getIdToken(true);

        const response = await fetch('/admin/session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ idToken }),
        });

        if (!response.ok) {
          throw new Error('Unable to create session. Please ensure your account has admin access.');
        }

        try {
          await authModule.signOut(auth);
        } catch (signOutErr) {
          console.warn('Failed to sign out Firebase Auth session', signOutErr); // eslint-disable-line no-console
        }

        window.location.href = nextUrl || '/admin';
      } catch (err) {
        console.error('Admin login failed', err); // eslint-disable-line no-console
        showError(err?.message ?? 'Sign-in failed. Please try again.');
      } finally {
        button.disabled = false;
      }
    });
  } else {
    console.error('Google sign-in button missing'); // eslint-disable-line no-console
  }
</script>
{% endblock %}

