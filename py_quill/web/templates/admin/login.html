<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Sign In Â· {{ site_name }}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>{{ admin_css|safe }}</style>
</head>

<body class="login-body">
  <section class="login-card" aria-label="Admin login">
    <h1>{{ site_name }} Admin</h1>
    <p>Sign in with Google using an account that has admin access.</p>
    <button id="google-signin" class="signin-btn" type="button">Continue with Google</button>
    <div id="login-error" class="error" role="alert"></div>
  </section>

  <script type="module">
    const firebaseConfig = {{ firebase_config | tojson }};
    const nextUrl = {{ next_url | tojson }};
    const errorEl = document.getElementById('login-error');
    const button = document.getElementById('google-signin');

    if (button) {
      function showError(message) {
        if (!errorEl) return;
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      }

      button.addEventListener('click', async () => {
        if (errorEl) {
          errorEl.style.display = 'none';
        }
        button.disabled = true;
        try {
          const app = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js');
          const authModule = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');

          const initializedApp = app.getApps().length
            ? app.getApp()
            : app.initializeApp(firebaseConfig);
          const auth = authModule.getAuth(initializedApp);
          auth.languageCode = 'en';

          const provider = new authModule.GoogleAuthProvider();
          provider.setCustomParameters({ prompt: 'select_account' });

          const result = await authModule.signInWithPopup(auth, provider);
          const idToken = await result.user.getIdToken(true);

          const response = await fetch('/admin/session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ idToken }),
          });

          if (!response.ok) {
            throw new Error('Unable to create session. Please ensure your account has admin access.');
          }

          try {
            await authModule.signOut(auth);
          } catch (signOutErr) {
            console.warn('Failed to sign out Firebase Auth session', signOutErr); // eslint-disable-line no-console
          }

          window.location.href = nextUrl || '/admin';
        } catch (err) {
          console.error('Admin login failed', err); // eslint-disable-line no-console
          showError(err?.message ?? 'Sign-in failed. Please try again.');
        } finally {
          button.disabled = false;
        }
      });
    } else {
      console.error('Google sign-in button missing'); // eslint-disable-line no-console
    }
  </script>
</body>

</html>

