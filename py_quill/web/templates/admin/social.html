{% extends "admin/admin_base.html" %}
{% from "components/infinite_scroll_feed.html" import infinite_scroll_feed %}

{% block title %}Social | {{ site_name }} Admin{% endblock %}

{% block head_extra %}
{{ super() }}
<style>
  .social-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
    margin-bottom: 16px;
  }

  .social-header h2 {
    margin: 0;
  }

  .social-header p {
    margin: 6px 0 0;
  }

  .social-actions {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    flex-wrap: wrap;
  }

  .pin-selection-row {
    display: flex;
    align-items: center;
    gap: 6px;
    min-height: 52px;
  }

  .pin-selection-item {
    width: 52px;
    height: 52px;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--color-border);
    background: var(--color-accent-surface);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    color: var(--color-text-muted);
  }

  .pin-selection-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .pin-controls {
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: flex-end;
  }

  .create-post-btn {
    background: var(--color-primary);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: opacity 0.2s;
  }

  .create-post-btn:hover:not(:disabled) {
    opacity: 0.9;
  }

  .create-post-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .pin-image-container {
    max-width: 260px;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--color-border);
    background: white;
  }

  .pin-image-container img {
    width: 100%;
    height: auto;
    display: block;
  }

  .joke-card--selectable .joke-slide-media,
  .joke-card--selectable .joke-slide-placeholder {
    cursor: pointer;
  }

  .joke-card--selectable.joke-card--selected {
    border-color: var(--color-primary, #c56f3a);
    box-shadow: 0 0 0 2px var(--color-primary, #c56f3a);
  }

  .social-posts {
    margin-bottom: 24px;
  }

  .social-posts-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 8px;
  }

  .social-posts-table {
    width: 100%;
    border-collapse: collapse;
  }

  .social-posts-table th,
  .social-posts-table td {
    text-align: left;
    padding: 10px 12px;
    border-bottom: 1px solid var(--color-border);
    vertical-align: top;
  }

  .social-posts-table th {
    font-size: 0.85rem;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .social-posts-title {
    font-weight: 600;
    margin-bottom: 4px;
  }

  .social-posts-description {
    color: var(--color-text-muted);
  }

  .social-posts-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
  }

  .social-posts-edit {
    margin-top: 10px;
    padding: 10px;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    background: var(--color-surface, #fff);
  }

  .social-posts-edit-label {
    display: block;
    font-size: 0.8rem;
    color: var(--color-text-muted);
    margin-bottom: 4px;
  }

  .social-posts-edit-input,
  .social-posts-edit-textarea {
    width: 100%;
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid var(--color-border);
    font-size: 0.9rem;
    margin-bottom: 8px;
  }

  .social-posts-edit-textarea {
    min-height: 70px;
    resize: vertical;
  }

  .social-posts-edit-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }

  .social-posts-thumb {
    width: 56px;
    height: 56px;
    border-radius: 8px;
    object-fit: cover;
    border: 1px solid var(--color-border);
    display: block;
  }

  .post-type-select {
    padding: 6px 10px;
    border-radius: 8px;
    border: 1px solid var(--color-border);
    background: white;
    font-size: 14px;
  }

  .post-type-select-label {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    display: block;
    margin-bottom: 4px;
  }
</style>
{% endblock %}

{% block content %}
<div class="admin-jokes">
  <header class="social-header">
    <div>
      <h2>Social</h2>
      <p class="muted">Public jokes in Daily or Published state.</p>
    </div>
    <div class="social-actions">
      <div class="pin-selection-row" id="admin-social-pin-selection"></div>
      <div class="pin-controls">
        <label class="post-type-select-label" for="admin-social-post-type">Post type</label>
        <select class="post-type-select" id="admin-social-post-type">
          {% for option in post_type_options %}
          <option value="{{ option }}" {% if option == default_post_type %}selected{% endif %}>
            {{ option.replace('_', ' ') }}
          </option>
          {% endfor %}
        </select>
        <button class="create-post-btn" type="button" id="admin-social-create-button" disabled>
          Create Post
        </button>
        <div class="pin-image-container" id="admin-social-pin-preview" style="display: none;"></div>
      </div>
    </div>
  </header>

  <section class="social-posts" aria-label="Social posts list">
    <div class="social-posts-header">
      <h3>Social Posts</h3>
      <span class="muted">{{ social_posts | length }} posts</span>
    </div>
    {% if not social_posts %}
    <p class="muted">No social posts yet.</p>
    {% else %}
    <table class="social-posts-table" aria-label="Social posts table">
      <thead>
        <tr>
          <th scope="col">Created</th>
          <th scope="col">Type</th>
          <th scope="col">Content</th>
          <th scope="col">Pinterest</th>
          <th scope="col">Instagram</th>
          <th scope="col">Facebook</th>
        </tr>
      </thead>
      <tbody>
        {% for post, creation_time in social_posts %}
        <tr data-post-id="{{ post.key or '' }}"
            data-pinterest-title="{{ (post.pinterest_title or '') | e }}"
            data-pinterest-description="{{ (post.pinterest_description or '') | e }}"
            data-pinterest-alt-text="{{ (post.pinterest_alt_text or '') | e }}">
          <td>
            {% if creation_time %}
            {{ creation_time.strftime('%Y-%m-%d %H:%M') }}
            {% else %}
            <span class="muted">Unknown</span>
            {% endif %}
          </td>
          <td>{{ post.type.value }}</td>
          <td>
            <div class="social-posts-title">{{ post.pinterest_title or '' }}</div>
            <div class="social-posts-description">{{ post.pinterest_description or '' }}</div>
            <div class="social-posts-actions">
              <button type="button" class="text-button js-social-edit">Edit text</button>
              <button type="button" class="text-button js-social-regenerate" data-regenerate-image="false">
                Regenerate text
              </button>
              <button type="button" class="text-button js-social-regenerate" data-regenerate-image="true">
                Regenerate image + text
              </button>
            </div>
            <div class="social-posts-edit" hidden>
              <label class="social-posts-edit-label" for="social-title-{{ post.key or loop.index }}">
                Pinterest title
              </label>
              <input class="social-posts-edit-input js-social-title"
                     id="social-title-{{ post.key or loop.index }}"
                     type="text"
                     maxlength="100">
              <label class="social-posts-edit-label" for="social-description-{{ post.key or loop.index }}">
                Pinterest description
              </label>
              <textarea class="social-posts-edit-textarea js-social-description"
                        id="social-description-{{ post.key or loop.index }}"
                        maxlength="500"></textarea>
              <label class="social-posts-edit-label" for="social-alt-{{ post.key or loop.index }}">
                Pinterest alt text
              </label>
              <textarea class="social-posts-edit-textarea js-social-alt-text"
                        id="social-alt-{{ post.key or loop.index }}"
                        maxlength="500"></textarea>
              <div class="social-posts-edit-actions">
                <button type="button" class="text-button js-social-cancel">Cancel</button>
                <button type="button" class="text-button js-social-save">Save</button>
              </div>
            </div>
          </td>
          <td>
            {% if post.pinterest_image_url %}
            <img class="social-posts-thumb" src="{{ post.pinterest_image_url }}" alt="Pinterest image">
            {% else %}
            <span class="muted">No image</span>
            {% endif %}
            <div class="muted">
              {% if post.pinterest_post_date %}
              {{ post.pinterest_post_date.strftime('%Y-%m-%d') }}
              {% else %}
              Not posted
              {% endif %}
            </div>
          </td>
          <td>
            <div class="muted">
              {% if post.instagram_post_date %}
              {{ post.instagram_post_date.strftime('%Y-%m-%d') }}
              {% else %}
              Not posted
              {% endif %}
            </div>
          </td>
          <td>
            <div class="muted">
              {% if post.facebook_post_date %}
              {{ post.facebook_post_date.strftime('%Y-%m-%d') }}
              {% else %}
              Not posted
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}
  </section>

  <section class="filter-chips" aria-label="Joke category filters">
    {% set all_selected = selected_category_id is none %}
    <button type="button" class="filter-chip text-button{% if all_selected %} filter-chip--selected{% endif %}"
      data-category="" aria-pressed="{{ 'true' if all_selected else 'false' }}">
      All
    </button>
    {% for category in categories %}
    {% set category_id = category.id %}
    {% set is_selected = category_id and (category_id == selected_category_id) %}
    <button type="button" class="filter-chip text-button{% if is_selected %} filter-chip--selected{% endif %}"
      data-category="{{ category_id }}" aria-pressed="{{ 'true' if is_selected else 'false' }}">
      {{ category.display_name }} ({{ category.public_joke_count or 0 }})
    </button>
    {% endfor %}
  </section>

  {{ infinite_scroll_feed(
  slug='admin-social',
  initial_jokes=jokes,
  initial_cursor=next_cursor,
  initial_has_more=has_more,
  width=image_size,
  feed_id='admin-social-feed',
  end_of_feed_message="No more jokes match these filters.",
  extra_query_params={'category': selected_category_id},
  admin_stats_enabled=true,
  grid_enabled=true,
  selectable_cards=true,
  ) }}
</div>

<script>
  (function () {
    const maxSelection = 5;
    const feedContainer = document.getElementById('admin-social-feed');
    const createPostBtn = document.getElementById('admin-social-create-button');
    const postTypeSelect = document.getElementById('admin-social-post-type');
    const pinPreview = document.getElementById('admin-social-pin-preview');
    const selectionRow = document.getElementById('admin-social-pin-selection');
    const socialPostsTable = document.querySelector('.social-posts-table');
    const selectedJokes = [];
    const categoryChips = Array.from(document.querySelectorAll('.filter-chip[data-category]'));
    // Use same-origin rewrite so the admin session cookie is included.
    const createPostEndpoint = '/social_post_creation_process';

    async function sendSocialRequest(payload) {
      const resp = await fetch(createPostEndpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ data: payload }),
      });

      if (!resp.ok) {
        const data = await resp.json().catch(() => ({}));
        const error = data?.data?.error || 'Failed to update social post';
        throw new Error(error);
      }

      const data = await resp.json().catch(() => ({}));
      return data?.data || {};
    }

    async function runWithButtonState(button, actionText, action) {
      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = actionText;
      try {
        await action();
      } finally {
        button.disabled = false;
        button.textContent = originalText;
      }
    }

    function renderSelectionRow() {
      if (!selectionRow) {
        return;
      }
      selectionRow.innerHTML = '';
      selectedJokes.forEach((joke) => {
        const thumb = document.createElement('div');
        thumb.className = 'pin-selection-item';
        if (joke.setupUrl) {
          const img = document.createElement('img');
          img.src = joke.setupUrl;
          img.alt = 'Selected setup image';
          img.loading = 'lazy';
          thumb.appendChild(img);
        } else {
          thumb.textContent = 'No setup';
        }
        selectionRow.appendChild(thumb);
      });
    }

    function escapeSelector(value) {
      if (window.CSS && typeof CSS.escape === 'function') {
        return CSS.escape(value);
      }
      return value.replace(/["\\]/g, '\\$&');
    }

    function formatPostDate(value) {
      if (!value) {
        return 'Not posted';
      }
      const parsed = new Date(value);
      if (Number.isNaN(parsed.getTime())) {
        return String(value);
      }
      return parsed.toISOString().slice(0, 10);
    }

    function updatePostsCount() {
      const countLabel = document.querySelector('.social-posts-header .muted');
      if (!countLabel || !socialPostsTable) {
        return;
      }
      const rows = socialPostsTable.querySelectorAll('tbody tr');
      countLabel.textContent = `${rows.length} posts`;
    }

    function updatePostRow(row, postId, postData) {
      row.dataset.postId = postId || '';
      row.dataset.pinterestTitle = postData.pinterest_title || '';
      row.dataset.pinterestDescription = postData.pinterest_description || '';
      row.dataset.pinterestAltText = postData.pinterest_alt_text || '';

      const titleEl = row.querySelector('.social-posts-title');
      if (titleEl) {
        titleEl.textContent = postData.pinterest_title || '';
      }
      const descEl = row.querySelector('.social-posts-description');
      if (descEl) {
        descEl.textContent = postData.pinterest_description || '';
      }

      const titleInput = row.querySelector('.js-social-title');
      const descriptionInput = row.querySelector('.js-social-description');
      const altInput = row.querySelector('.js-social-alt-text');
      if (titleInput) titleInput.value = postData.pinterest_title || '';
      if (descriptionInput) descriptionInput.value = postData.pinterest_description || '';
      if (altInput) altInput.value = postData.pinterest_alt_text || '';

      if (postData.type) {
        const typeCell = row.querySelectorAll('td')[1];
        if (typeCell) {
          typeCell.textContent = postData.type;
        }
      }

      const pinterestCell = row.querySelectorAll('td')[3];
      if (pinterestCell) {
        const existingImg = pinterestCell.querySelector('img.social-posts-thumb');
        const noImage = pinterestCell.querySelector('.js-social-no-image');
        if (postData.pinterest_image_url) {
          const img = existingImg || document.createElement('img');
          img.className = 'social-posts-thumb';
          img.alt = 'Pinterest image';
          img.src = postData.pinterest_image_url;
          if (!existingImg) {
            pinterestCell.insertBefore(img, pinterestCell.firstChild);
          }
          if (noImage) {
            noImage.remove();
          }
        } else if (!noImage) {
          if (existingImg) {
            existingImg.remove();
          }
          const empty = document.createElement('span');
          empty.className = 'muted js-social-no-image';
          empty.textContent = 'No image';
          pinterestCell.insertBefore(empty, pinterestCell.firstChild);
        }

        const dateEl = pinterestCell.querySelector('.js-social-pinterest-date');
        if (dateEl) {
          dateEl.textContent = formatPostDate(postData.pinterest_post_date);
        }
      }
    }

    function createPostRow(postId, postData) {
      if (!socialPostsTable) {
        return null;
      }
      let tbody = socialPostsTable.querySelector('tbody');
      if (!tbody) {
        tbody = document.createElement('tbody');
        socialPostsTable.appendChild(tbody);
      }

      const row = document.createElement('tr');
      row.dataset.postId = postId || '';
      row.dataset.pinterestTitle = postData.pinterest_title || '';
      row.dataset.pinterestDescription = postData.pinterest_description || '';
      row.dataset.pinterestAltText = postData.pinterest_alt_text || '';

      const createdCell = document.createElement('td');
      const createdLabel = document.createElement('span');
      createdLabel.className = 'muted';
      createdLabel.textContent = 'Just now';
      createdCell.appendChild(createdLabel);

      const typeCell = document.createElement('td');
      typeCell.textContent = postData.type || '';

      const contentCell = document.createElement('td');
      const titleEl = document.createElement('div');
      titleEl.className = 'social-posts-title';
      titleEl.textContent = postData.pinterest_title || '';
      const descEl = document.createElement('div');
      descEl.className = 'social-posts-description';
      descEl.textContent = postData.pinterest_description || '';

      const actions = document.createElement('div');
      actions.className = 'social-posts-actions';

      const editButton = document.createElement('button');
      editButton.type = 'button';
      editButton.className = 'text-button js-social-edit';
      editButton.textContent = 'Edit text';
      actions.appendChild(editButton);

      const regenTextButton = document.createElement('button');
      regenTextButton.type = 'button';
      regenTextButton.className = 'text-button js-social-regenerate';
      regenTextButton.dataset.regenerateImage = 'false';
      regenTextButton.textContent = 'Regenerate text';
      actions.appendChild(regenTextButton);

      const regenImageButton = document.createElement('button');
      regenImageButton.type = 'button';
      regenImageButton.className = 'text-button js-social-regenerate';
      regenImageButton.dataset.regenerateImage = 'true';
      regenImageButton.textContent = 'Regenerate image + text';
      actions.appendChild(regenImageButton);

      const editPanel = document.createElement('div');
      editPanel.className = 'social-posts-edit';
      editPanel.hidden = true;

      const fallbackId = postId || `new-${Date.now()}`;

      const titleLabel = document.createElement('label');
      titleLabel.className = 'social-posts-edit-label';
      titleLabel.htmlFor = `social-title-${fallbackId}`;
      titleLabel.textContent = 'Pinterest title';
      const titleInput = document.createElement('input');
      titleInput.className = 'social-posts-edit-input js-social-title';
      titleInput.id = `social-title-${fallbackId}`;
      titleInput.type = 'text';
      titleInput.maxLength = 100;
      titleInput.value = postData.pinterest_title || '';

      const descriptionLabel = document.createElement('label');
      descriptionLabel.className = 'social-posts-edit-label';
      descriptionLabel.htmlFor = `social-description-${fallbackId}`;
      descriptionLabel.textContent = 'Pinterest description';
      const descriptionInput = document.createElement('textarea');
      descriptionInput.className = 'social-posts-edit-textarea js-social-description';
      descriptionInput.id = `social-description-${fallbackId}`;
      descriptionInput.maxLength = 500;
      descriptionInput.value = postData.pinterest_description || '';

      const altLabel = document.createElement('label');
      altLabel.className = 'social-posts-edit-label';
      altLabel.htmlFor = `social-alt-${fallbackId}`;
      altLabel.textContent = 'Pinterest alt text';
      const altInput = document.createElement('textarea');
      altInput.className = 'social-posts-edit-textarea js-social-alt-text';
      altInput.id = `social-alt-${fallbackId}`;
      altInput.maxLength = 500;
      altInput.value = postData.pinterest_alt_text || '';

      const editActions = document.createElement('div');
      editActions.className = 'social-posts-edit-actions';
      const cancelButton = document.createElement('button');
      cancelButton.type = 'button';
      cancelButton.className = 'text-button js-social-cancel';
      cancelButton.textContent = 'Cancel';
      const saveButton = document.createElement('button');
      saveButton.type = 'button';
      saveButton.className = 'text-button js-social-save';
      saveButton.textContent = 'Save';
      editActions.appendChild(cancelButton);
      editActions.appendChild(saveButton);

      editPanel.appendChild(titleLabel);
      editPanel.appendChild(titleInput);
      editPanel.appendChild(descriptionLabel);
      editPanel.appendChild(descriptionInput);
      editPanel.appendChild(altLabel);
      editPanel.appendChild(altInput);
      editPanel.appendChild(editActions);

      contentCell.appendChild(titleEl);
      contentCell.appendChild(descEl);
      contentCell.appendChild(actions);
      contentCell.appendChild(editPanel);

      const pinterestCell = document.createElement('td');
      if (postData.pinterest_image_url) {
        const img = document.createElement('img');
        img.className = 'social-posts-thumb';
        img.alt = 'Pinterest image';
        img.src = postData.pinterest_image_url;
        pinterestCell.appendChild(img);
      } else {
        const empty = document.createElement('span');
        empty.className = 'muted js-social-no-image';
        empty.textContent = 'No image';
        pinterestCell.appendChild(empty);
      }
      const pinterestDate = document.createElement('div');
      pinterestDate.className = 'muted js-social-pinterest-date';
      pinterestDate.textContent = formatPostDate(postData.pinterest_post_date);
      pinterestCell.appendChild(pinterestDate);

      const instagramCell = document.createElement('td');
      const instagramDate = document.createElement('div');
      instagramDate.className = 'muted';
      instagramDate.textContent = formatPostDate(postData.instagram_post_date);
      instagramCell.appendChild(instagramDate);

      const facebookCell = document.createElement('td');
      const facebookDate = document.createElement('div');
      facebookDate.className = 'muted';
      facebookDate.textContent = formatPostDate(postData.facebook_post_date);
      facebookCell.appendChild(facebookDate);

      row.appendChild(createdCell);
      row.appendChild(typeCell);
      row.appendChild(contentCell);
      row.appendChild(pinterestCell);
      row.appendChild(instagramCell);
      row.appendChild(facebookCell);

      tbody.insertBefore(row, tbody.firstChild);
      updatePostsCount();
      return row;
    }

    function upsertPostRow(postId, postData) {
      if (!socialPostsTable || !postId) {
        return;
      }
      const selector = `tr[data-post-id="${escapeSelector(postId)}"]`;
      const existingRow = socialPostsTable.querySelector(selector);
      if (existingRow) {
        updatePostRow(existingRow, postId, postData);
        return;
      }
      createPostRow(postId, postData);
    }

    function clearSelection() {
      selectedJokes.length = 0;
      if (feedContainer) {
        feedContainer.querySelectorAll('.joke-card--selected').forEach((card) => {
          card.classList.remove('joke-card--selected');
          card.setAttribute('aria-selected', 'false');
        });
      }
      if (createPostBtn) {
        createPostBtn.disabled = true;
      }
      if (pinPreview) {
        pinPreview.style.display = 'none';
        pinPreview.innerHTML = '';
      }
      renderSelectionRow();
    }

    function setSelected(chip, isSelected) {
      chip.classList.toggle('filter-chip--selected', isSelected);
      chip.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
    }

    function navigateWithCategory(categoryId) {
      const url = new URL(window.location.href);
      url.pathname = '/admin/social';
      if (categoryId) {
        url.searchParams.set('category', categoryId);
      } else {
        url.searchParams.delete('category');
      }
      url.searchParams.delete('cursor');
      window.location.assign(url.toString());
    }

    if (feedContainer && createPostBtn) {
      feedContainer.addEventListener('click', (event) => {
        const mediaTarget = event.target.closest('.joke-slide-media, .joke-slide-placeholder');
        if (!mediaTarget) {
          return;
        }
        const card = event.target.closest('.joke-card[data-selectable="true"]');
        if (!card) {
          return;
        }
        const jokeId = card.dataset.jokeId;
        if (!jokeId) {
          return;
        }
        const existingIndex = selectedJokes.findIndex((item) => item.id === jokeId);
        if (existingIndex >= 0) {
          selectedJokes.splice(existingIndex, 1);
          card.classList.remove('joke-card--selected');
          card.setAttribute('aria-selected', 'false');
        } else {
          if (selectedJokes.length >= maxSelection) {
            alert('You can select up to 5 jokes.');
            return;
          }
          selectedJokes.push({
            id: jokeId,
            setupUrl: card.dataset.setupUrl || '',
          });
          card.classList.add('joke-card--selected');
          card.setAttribute('aria-selected', 'true');
        }

        createPostBtn.disabled = selectedJokes.length === 0;
        renderSelectionRow();
      });

      createPostBtn.addEventListener('click', async () => {
        if (selectedJokes.length === 0) {
          return;
        }

        await runWithButtonState(createPostBtn, 'Creating...', async () => {
          const data = await sendSocialRequest({
            joke_ids: selectedJokes.map((joke) => joke.id),
            type: postTypeSelect?.value || '',
          });
          const postData = data?.post_data || {};
          const postId = data?.post_id || '';
          const pinUrl = postData?.pinterest_image_url;

          if (!pinUrl) {
            throw new Error('Pinterest image URL missing from response');
          }

          pinPreview.style.display = 'block';
          let img = pinPreview.querySelector('img');
          if (!img) {
            img = document.createElement('img');
            img.alt = 'Pinterest pin image';
            img.loading = 'lazy';
            pinPreview.appendChild(img);
          }
          img.src = pinUrl;
          upsertPostRow(postId, postData);
          clearSelection();
        }).catch((error) => {
          console.error('Failed to create social post:', error);
          alert('Failed to create social post: ' + error.message);
        });

        createPostBtn.disabled = selectedJokes.length === 0;
      });

      createPostBtn.disabled = true;
      renderSelectionRow();
    }

    if (socialPostsTable) {
      socialPostsTable.addEventListener('click', async (event) => {
        const editButton = event.target.closest('.js-social-edit');
        const saveButton = event.target.closest('.js-social-save');
        const cancelButton = event.target.closest('.js-social-cancel');
        const regenButton = event.target.closest('.js-social-regenerate');

        const row = event.target.closest('tr[data-post-id]');
        if (!row || !row.dataset.postId) {
          return;
        }

        const editPanel = row.querySelector('.social-posts-edit');
        const titleInput = row.querySelector('.js-social-title');
        const descriptionInput = row.querySelector('.js-social-description');
        const altInput = row.querySelector('.js-social-alt-text');

        if (editButton && editPanel) {
          editPanel.hidden = !editPanel.hidden;
          if (!editPanel.hidden) {
            if (titleInput) titleInput.value = row.dataset.pinterestTitle || '';
            if (descriptionInput) descriptionInput.value = row.dataset.pinterestDescription || '';
            if (altInput) altInput.value = row.dataset.pinterestAltText || '';
          }
          return;
        }

        if (cancelButton && editPanel) {
          editPanel.hidden = true;
          return;
        }

        if (saveButton) {
          await runWithButtonState(saveButton, 'Saving...', async () => {
            await sendSocialRequest({
              post_id: row.dataset.postId,
              pinterest_title: titleInput ? titleInput.value : '',
              pinterest_description: descriptionInput ? descriptionInput.value : '',
              pinterest_alt_text: altInput ? altInput.value : '',
            }).then((data) => {
              const postData = data?.post_data || {};
              const postId = data?.post_id || row.dataset.postId;
              upsertPostRow(postId, postData);
            });
          }).catch((error) => {
            console.error('Failed to update social post:', error);
            alert('Failed to update social post: ' + error.message);
          });
          return;
        }

        if (regenButton) {
          const regenerateImage = regenButton.dataset.regenerateImage === 'true';
          await runWithButtonState(regenButton, 'Regenerating...', async () => {
            await sendSocialRequest({
              post_id: row.dataset.postId,
              regenerate_text: true,
              regenerate_image: regenerateImage,
            }).then((data) => {
              const postData = data?.post_data || {};
              const postId = data?.post_id || row.dataset.postId;
              upsertPostRow(postId, postData);
            });
          }).catch((error) => {
            console.error('Failed to regenerate social post:', error);
            alert('Failed to regenerate social post: ' + error.message);
          });
        }
      });
    }

    if (categoryChips.length) {
      categoryChips.forEach((chip) => {
        chip.addEventListener('click', () => {
          const categoryId = chip.getAttribute('data-category') || '';
          const isSelected = chip.classList.contains('filter-chip--selected');
          if (isSelected) {
            return;
          }
          clearSelection();
          categoryChips.forEach((c) => setSelected(c, c === chip));
          navigateWithCategory(categoryId || null);
        });
      });
    }
  })();
</script>
{% endblock %}
