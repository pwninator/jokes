{% extends "admin/admin_base.html" %}
{% from "components/infinite_scroll_feed.html" import infinite_scroll_feed %}

{% block title %}Social | {{ site_name }} Admin{% endblock %}

{% block head_extra %}
{{ super() }}
<style>
  .social-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
    margin-bottom: 16px;
  }

  .social-header h2 {
    margin: 0;
  }

  .social-header p {
    margin: 6px 0 0;
  }

  .social-actions {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    flex-wrap: wrap;
  }

  .pin-selection-row {
    display: flex;
    align-items: center;
    gap: 6px;
    min-height: 52px;
  }

  .pin-selection-item {
    width: 52px;
    height: 52px;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--color-border);
    background: var(--color-accent-surface);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    color: var(--color-text-muted);
  }

  .pin-selection-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .pin-controls {
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: flex-end;
  }

  .create-post-btn {
    background: var(--color-primary);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: opacity 0.2s;
  }

  .create-post-btn:hover:not(:disabled) {
    opacity: 0.9;
  }

  .create-post-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .pin-image-container {
    max-width: 260px;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--color-border);
    background: white;
  }

  .pin-image-container img {
    width: 100%;
    height: auto;
    display: block;
  }

  .joke-card--selectable .joke-slide-media,
  .joke-card--selectable .joke-slide-placeholder {
    cursor: pointer;
  }

  .joke-card--selectable.joke-card--selected {
    border-color: var(--color-primary, #c56f3a);
    box-shadow: 0 0 0 2px var(--color-primary, #c56f3a);
  }

  .social-posts {
    margin-bottom: 24px;
  }

  .social-posts-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 8px;
  }

  .social-posts-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .social-post-card {
    border: 1px solid var(--color-border);
    border-radius: 16px;
    padding: 16px;
    background: var(--color-surface, #fff);
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .social-post-card__header {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: baseline;
    font-size: 0.95rem;
  }

  .social-post-card__timestamp {
    font-weight: 600;
  }

  .social-post-card__title a,
  .social-post-card__title span {
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 600;
  }

  .social-post-card__title a:hover {
    text-decoration: underline;
  }

  .social-post-card__type {
    color: var(--color-text-muted);
  }

  .social-post-card__columns {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 16px;
    width: 100%;
  }

  .social-post-card__actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: flex-end;
  }

  .icon-button {
    border: none;
    background: transparent;
    padding: 6px;
    border-radius: 8px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .icon-button:hover:not(:disabled) {
    background: rgba(0, 0, 0, 0.06);
  }

  .icon-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .icon-button--danger {
    color: #c62828;
  }

  .icon-button svg {
    width: 18px;
    height: 18px;
    display: block;
  }

  .social-post-card.is-editing .social-platform:not(.social-platform--locked) .social-platform-field .social-platform-value {
    display: none;
  }

  .social-post-card.is-editing .social-platform:not(.social-platform--locked) .social-platform-field .social-posts-edit-input,
  .social-post-card.is-editing .social-platform:not(.social-platform--locked) .social-platform-field .social-posts-edit-textarea {
    display: block;
  }

  .social-posts-edit-input,
  .social-posts-edit-textarea {
    width: 100%;
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid var(--color-border);
    font-size: 0.9rem;
    margin-bottom: 8px;
    display: none;
  }

  .social-posts-edit-textarea {
    min-height: 70px;
    resize: vertical;
  }

  .social-posts-thumb {
    width: 100%;
    max-width: 200px;
    max-height: 200px;
    height: auto;
    border-radius: 8px;
    object-fit: cover;
    border: 1px solid var(--color-border);
    display: block;
  }

  .social-posts-thumb-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 8px;
    width: 100%;
  }

  .social-posts-thumb-grid img {
    width: 100%;
    max-width: 100px;
    max-height: 100px;
    height: auto;
    border-radius: 8px;
    object-fit: cover;
    border: 1px solid var(--color-border);
    display: block;
  }

  .social-posts-carousel-layout {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: flex-start;
  }

  .social-posts-carousel-pin {
    width: 100px;
    height: 150px;
    flex: 0 0 100px;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--color-border);
    background: var(--color-accent-surface);
    display: flex;
    align-items: flex-start;
    justify-content: center;
    text-align: center;
  }

  .social-posts-carousel-pin a {
    display: block;
    width: 100%;
    height: 100%;
  }

  .social-posts-carousel-pin img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: top center;
    display: block;
  }

  .social-posts-carousel-grid {
    display: flex;
    flex: 1 1 0;
    min-width: 0;
    flex-wrap: wrap;
    gap: 8px;
    align-items: start;
  }

  .social-posts-carousel-grid a {
    display: inline-flex;
    width: 100px;
    max-width: 100px;
  }

  .social-posts-carousel-grid img {
    width: 100%;
    max-width: 100px;
    height: auto;
    border-radius: 8px;
    object-fit: cover;
    border: 1px solid var(--color-border);
    display: block;
  }

  .social-posts-carousel {
    display: none;
    flex-direction: column;
    gap: 8px;
  }

  .social-post-card[data-post-type="JOKE_CAROUSEL"] .social-posts-carousel {
    display: flex;
  }

  /* For carousel posts, show the platform logo but hide the per-platform image thumbnails. */
  .social-post-card[data-post-type="JOKE_CAROUSEL"] .social-posts-image-slot {
    display: none;
  }

  .social-posts-image {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    min-height: 56px;
  }

  .social-posts-image a {
    display: inline-flex;
  }

  .social-posts-logo {
    width: 70px;
    flex: 0 0 70px;
    display: flex;
    align-items: flex-start;
    justify-content: center;
  }

  .social-posts-logo img {
    width: 50px;
    height: 50px;
    object-fit: contain;
    display: block;
  }

  @media (max-width: 900px) {
    .social-posts-image {
      flex-wrap: wrap;
    }

    .social-posts-image-slot {
      flex: 1 1 100%;
    }
  }

  .social-platform {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .social-platform-field {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .social-platform-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--color-text-muted);
  }

  .social-platform-value {
    font-size: 0.9rem;
    overflow-wrap: anywhere;
    white-space: pre-wrap;
  }

  .social-platform-value.is-empty {
    color: var(--color-text-muted);
  }

  .social-platform-status {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    font-size: 0.85rem;
    color: var(--color-text-muted);
  }

  /* Status should not preserve template whitespace/newlines. */
  .social-platform-status .social-platform-value {
    white-space: normal;
  }

  .social-platform-mark {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: center;
  }

  .social-platform--locked {
    opacity: 0.7;
  }

  .post-type-select {
    padding: 6px 10px;
    border-radius: 8px;
    border: 1px solid var(--color-border);
    background: white;
    font-size: 14px;
  }

  .post-type-select-label {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    display: block;
    margin-bottom: 4px;
  }

  .admin-modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .admin-modal.admin-modal--open {
    display: flex;
  }

  .admin-modal__backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.45);
  }

  .admin-modal__dialog {
    position: relative;
    width: min(520px, calc(100vw - 40px));
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 16px;
    box-shadow: 0 18px 40px rgba(0, 0, 0, 0.25);
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .admin-modal__title {
    margin: 0;
  }

  .admin-modal__content {
    display: flex;
    flex-direction: column;
  }

  #admin-social-post-modal .social-posts-edit-input {
    display: block;
  }

  .social-post-modal__field {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 12px;
  }

  .social-post-modal__actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 12px;
  }
</style>
{% endblock %}

{% block content %}
<div class="admin-jokes">
  <header class="social-header">
    <div>
      <h2>Social</h2>
      <p class="muted">Public jokes in Daily or Published state.</p>
    </div>
    <div class="social-actions">
      <div class="pin-selection-row" id="admin-social-pin-selection"></div>
      <div class="pin-controls">
        <label class="post-type-select-label" for="admin-social-post-type">Post type</label>
        <select class="post-type-select" id="admin-social-post-type">
          {% for option in post_type_options %}
          <option value="{{ option }}" {% if option==default_post_type %}selected{% endif %}>
            {{ option.replace('_', ' ') }}
          </option>
          {% endfor %}
        </select>
        <button class="create-post-btn" type="button" id="admin-social-create-button" disabled>
          Create Post
        </button>
        <div class="pin-image-container" id="admin-social-pin-preview" style="display: none;"></div>
      </div>
    </div>
  </header>

  <section class="social-posts" aria-label="Social posts list">
    <div class="social-posts-header">
      <h3>Social Posts</h3>
      <span class="muted">{{ social_posts | length }} posts</span>
    </div>
    {% if not social_posts %}
    <p class="muted">No social posts yet.</p>
    {% else %}
    <div class="social-posts-list" aria-label="Social posts list">
      {% for post, creation_time in social_posts %}
      {% set pinterest_locked = post.pinterest_post_time or post.pinterest_post_id %}
      {% set instagram_locked = post.instagram_post_time or post.instagram_post_id %}
      {% set facebook_locked = post.facebook_post_time or post.facebook_post_id %}
      {% set all_locked = pinterest_locked and instagram_locked and facebook_locked %}
      {% set any_posted = pinterest_locked or instagram_locked or facebook_locked %}
      <article class="social-post-card" data-post-id="{{ post.key or '' }}"
        data-post-type="{{ post.type.value if post.type else '' }}"
        data-link-url="{{ (post.link_url or '') | e }}" data-pinterest-title="{{ (post.pinterest_title or '') | e }}"
        data-pinterest-description="{{ (post.pinterest_description or '') | e }}"
        data-pinterest-alt-text="{{ (post.pinterest_alt_text or '') | e }}"
        data-pinterest-post-id="{{ (post.pinterest_post_id or '') | e }}"
        data-pinterest-post-time="{{ post.pinterest_post_time.isoformat() if post.pinterest_post_time else '' }}"
        data-pinterest-image-urls="{{ post.pinterest_image_urls | tojson | e }}"
        data-instagram-caption="{{ (post.instagram_caption or '') | e }}"
        data-instagram-alt-text="{{ (post.instagram_alt_text or '') | e }}"
        data-instagram-post-id="{{ (post.instagram_post_id or '') | e }}"
        data-instagram-post-time="{{ post.instagram_post_time.isoformat() if post.instagram_post_time else '' }}"
        data-instagram-image-urls="{{ post.instagram_image_urls | tojson | e }}"
        data-facebook-message="{{ (post.facebook_message or '') | e }}"
        data-facebook-post-id="{{ (post.facebook_post_id or '') | e }}"
        data-facebook-post-time="{{ post.facebook_post_time.isoformat() if post.facebook_post_time else '' }}"
        data-facebook-image-urls="{{ post.facebook_image_urls | tojson | e }}">
        {% set pinterest_preview_url = post.pinterest_image_urls[0] if post.pinterest_image_urls else '' %}
        {% set carousel_grid_urls = post.instagram_image_urls or post.facebook_image_urls or post.pinterest_image_urls or [] %}
        <header class="social-post-card__header">
          <span class="social-post-card__timestamp js-social-created">
            {% if creation_time %}
            {{ creation_time.strftime('%Y-%m-%d %H:%M') }}
            {% else %}
            Unknown
            {% endif %}
          </span>
          <span>:</span>
          <span class="social-post-card__title">
            {% if post.link_url %}
            <a class="js-social-link" href="{{ post.link_url | e }}" target="_blank" rel="noopener">
              <span class="js-social-title">{{ post.pinterest_title or 'No title' }}</span>
            </a>
            {% else %}
            <span class="js-social-title js-social-link-empty">{{ post.pinterest_title or 'No title' }}</span>
            {% endif %}
          </span>
          <span class="social-post-card__type js-social-type">({{ post.type.value }})</span>
        </header>
        <div class="social-posts-carousel js-social-carousel">
          <div class="js-social-carousel-slot">
            {% if pinterest_preview_url or carousel_grid_urls %}
              <div class="social-posts-carousel-layout">
                <div class="social-posts-carousel-pin">
                  {% if pinterest_preview_url %}
                    <a href="{{ pinterest_preview_url }}" target="_blank" rel="noopener">
                      <img src="{{ pinterest_preview_url }}" alt="Pinterest giraffe image">
                    </a>
                  {% else %}
                    <span class="muted js-social-no-image">No Pinterest image</span>
                  {% endif %}
                </div>
                <div class="social-posts-carousel-grid">
                  {% if carousel_grid_urls %}
                    {% for url in carousel_grid_urls %}
                    <a href="{{ url }}" target="_blank" rel="noopener">
                      <img src="{{ url }}" alt="Carousel image {{ loop.index }}">
                    </a>
                    {% endfor %}
                  {% else %}
                    <span class="muted js-social-no-image">No carousel images</span>
                  {% endif %}
                </div>
              </div>
            {% else %}
              <span class="muted js-social-no-image">No image</span>
            {% endif %}
          </div>
        </div>
        <div class="social-post-card__columns">
          <div class="social-platform{% if pinterest_locked %} social-platform--locked{% endif %}"
            data-platform="pinterest">
            <div class="social-posts-image js-social-platform-image" data-platform="pinterest">
              <div class="social-posts-logo" aria-hidden="true">
                <img src="https://images.quillsstorybook.com/cdn-cgi/image/width=50,format=auto,quality=50/_joke_assets/logos/logo_pinterest.png"
                  alt="" loading="lazy" decoding="async">
              </div>
              <div class="social-posts-image-slot js-social-platform-image-slot" data-platform="pinterest">
                {% if post.pinterest_image_urls %}
                  {% if post.pinterest_image_urls | length == 1 %}
                    <a href="{{ post.pinterest_image_urls[0] }}" target="_blank" rel="noopener">
                      <img class="social-posts-thumb" src="{{ post.pinterest_image_urls[0] }}" alt="Pinterest image">
                    </a>
                  {% else %}
                    <div class="social-posts-thumb-grid">
                      {% for url in post.pinterest_image_urls %}
                      <a href="{{ url }}" target="_blank" rel="noopener">
                        <img src="{{ url }}" alt="Pinterest image {{ loop.index }}">
                      </a>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% else %}
                  <span class="muted js-social-no-image">No image</span>
                {% endif %}
              </div>
            </div>
            <div class="social-platform-field">
              <span class="social-platform-label">Title</span>
              <span
                class="social-platform-value js-social-pinterest-title{% if not post.pinterest_title %} is-empty{% endif %}"
                data-empty-text="No title">{{ post.pinterest_title or 'No title' }}</span>
              <input class="social-posts-edit-input js-social-pinterest-title-input" type="text" maxlength="100">
            </div>
            <div class="social-platform-field">
              <span class="social-platform-label">Description</span>
              <span
                class="social-platform-value js-social-pinterest-description{% if not post.pinterest_description %} is-empty{% endif %}"
                data-empty-text="No description">{{ post.pinterest_description or 'No description' }}</span>
              <textarea class="social-posts-edit-textarea js-social-pinterest-description-input"
                maxlength="500"></textarea>
            </div>
            <div class="social-platform-field">
              <span class="social-platform-label">Alt text</span>
              <span
                class="social-platform-value js-social-pinterest-alt-text{% if not post.pinterest_alt_text %} is-empty{% endif %}"
                data-empty-text="No alt text">{{ post.pinterest_alt_text or 'No alt text' }}</span>
              <textarea class="social-posts-edit-textarea js-social-pinterest-alt-text-input"
                maxlength="500"></textarea>
            </div>
            <div class="social-platform-status">
              <span class="social-platform-value js-social-pinterest-status{% if not pinterest_locked %} is-empty{% endif %}"
                    data-empty-text="Not posted">
                {% if post.pinterest_post_id or post.pinterest_post_time %}
                {{ post.pinterest_post_id or '' }}{% if post.pinterest_post_time %} ({{ post.pinterest_post_time.strftime('%Y-%m-%d %H:%M') }}){% endif %}
                {% else %}
                Not posted
                {% endif %}
              </span>
              {% if not pinterest_locked %}
              <button type="button" class="text-button js-social-post-button" data-platform="pinterest">
                Post
              </button>
              {% endif %}
            </div>
          </div>
          <div class="social-platform{% if instagram_locked %} social-platform--locked{% endif %}"
            data-platform="instagram">
            <div class="social-posts-image js-social-platform-image" data-platform="instagram">
              <div class="social-posts-logo" aria-hidden="true">
                <img src="https://images.quillsstorybook.com/cdn-cgi/image/width=50,format=auto,quality=50/_joke_assets/logos/logo_instagram.png"
                  alt="" loading="lazy" decoding="async">
              </div>
              <div class="social-posts-image-slot js-social-platform-image-slot" data-platform="instagram">
                {% if post.instagram_image_urls %}
                  {% if post.instagram_image_urls | length == 1 %}
                    <a href="{{ post.instagram_image_urls[0] }}" target="_blank" rel="noopener">
                      <img class="social-posts-thumb" src="{{ post.instagram_image_urls[0] }}" alt="Instagram image">
                    </a>
                  {% else %}
                    <div class="social-posts-thumb-grid">
                      {% for url in post.instagram_image_urls %}
                      <a href="{{ url }}" target="_blank" rel="noopener">
                        <img src="{{ url }}" alt="Instagram image {{ loop.index }}">
                      </a>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% else %}
                  <span class="muted js-social-no-image">No image</span>
                {% endif %}
              </div>
            </div>
            <div class="social-platform-field">
              <span class="social-platform-label">Caption</span>
              <span
                class="social-platform-value js-social-instagram-caption{% if not post.instagram_caption %} is-empty{% endif %}"
                data-empty-text="No caption">{{ post.instagram_caption or 'No caption' }}</span>
              <textarea class="social-posts-edit-textarea js-social-instagram-caption-input"></textarea>
            </div>
            <div class="social-platform-field">
              <span class="social-platform-label">Alt text</span>
              <span
                class="social-platform-value js-social-instagram-alt-text{% if not post.instagram_alt_text %} is-empty{% endif %}"
                data-empty-text="No alt text">{{ post.instagram_alt_text or 'No alt text' }}</span>
              <textarea class="social-posts-edit-textarea js-social-instagram-alt-text-input"></textarea>
            </div>
            <div class="social-platform-status">
              <span class="social-platform-value js-social-instagram-status{% if not instagram_locked %} is-empty{% endif %}"
                    data-empty-text="Not posted">
                {% if post.instagram_post_id or post.instagram_post_time %}
                {{ post.instagram_post_id or '' }}{% if post.instagram_post_time %} ({{ post.instagram_post_time.strftime('%Y-%m-%d %H:%M') }}){% endif %}
                {% else %}
                Not posted
                {% endif %}
              </span>
              {% if not instagram_locked %}
              <button type="button" class="text-button js-social-post-button" data-platform="instagram">
                Post
              </button>
              {% endif %}
            </div>
          </div>
          <div class="social-platform{% if facebook_locked %} social-platform--locked{% endif %}"
            data-platform="facebook">
            <div class="social-posts-image js-social-platform-image" data-platform="facebook">
              <div class="social-posts-logo" aria-hidden="true">
                <img src="https://images.quillsstorybook.com/cdn-cgi/image/width=50,format=auto,quality=50/_joke_assets/logos/logo_facebook.png"
                  alt="" loading="lazy" decoding="async">
              </div>
              <div class="social-posts-image-slot js-social-platform-image-slot" data-platform="facebook">
                {% if post.facebook_image_urls %}
                  {% if post.facebook_image_urls | length == 1 %}
                    <a href="{{ post.facebook_image_urls[0] }}" target="_blank" rel="noopener">
                      <img class="social-posts-thumb" src="{{ post.facebook_image_urls[0] }}" alt="Facebook image">
                    </a>
                  {% else %}
                    <div class="social-posts-thumb-grid">
                      {% for url in post.facebook_image_urls %}
                      <a href="{{ url }}" target="_blank" rel="noopener">
                        <img src="{{ url }}" alt="Facebook image {{ loop.index }}">
                      </a>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% else %}
                  <span class="muted js-social-no-image">No image</span>
                {% endif %}
              </div>
            </div>
            <div class="social-platform-field">
              <span class="social-platform-label">Message</span>
              <span
                class="social-platform-value js-social-facebook-message{% if not post.facebook_message %} is-empty{% endif %}"
                data-empty-text="No message">{{ post.facebook_message or 'No message' }}</span>
              <textarea class="social-posts-edit-textarea js-social-facebook-message-input"></textarea>
            </div>
            <div class="social-platform-status">
              <span class="social-platform-value js-social-facebook-status{% if not facebook_locked %} is-empty{% endif %}"
                    data-empty-text="Not posted">
                {% if post.facebook_post_id or post.facebook_post_time %}
                {{ post.facebook_post_id or '' }}{% if post.facebook_post_time %} ({{ post.facebook_post_time.strftime('%Y-%m-%d %H:%M') }}){% endif %}
                {% else %}
                Not posted
                {% endif %}
              </span>
              {% if not facebook_locked %}
              <button type="button" class="text-button js-social-post-button" data-platform="facebook">
                Post
              </button>
              {% endif %}
            </div>
          </div>
        </div>
        {% if not all_locked %}
        <div class="social-post-card__actions">
          {% if not any_posted %}
          <button type="button" class="icon-button icon-button--danger js-social-delete"
            aria-label="Delete social post" title="Delete social post">
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path fill="currentColor"
                d="M9 3h6l1 2h5v2H3V5h5l1-2zm1 6h2v9h-2V9zm4 0h2v9h-2V9zM7 9h2v9H7V9zm-1 13h12a2 2 0 0 0 2-2V9H4v11a2 2 0 0 0 2 2z" />
            </svg>
          </button>
          {% endif %}
          <button type="button" class="text-button js-social-edit-toggle">
            Edit
          </button>
          <button type="button" class="text-button js-social-regenerate" data-regenerate-image="false">
            Regenerate text
          </button>
          <button type="button" class="text-button js-social-regenerate" data-regenerate-image="true">
            Regenerate image + text
          </button>
        </div>
        {% endif %}
      </article>
      {% endfor %}
    </div>
    {% endif %}
  </section>

  <section class="filter-chips" aria-label="Joke category filters">
    {% set all_selected = selected_category_id is none %}
    <button type="button" class="filter-chip text-button{% if all_selected %} filter-chip--selected{% endif %}"
      data-category="" aria-pressed="{{ 'true' if all_selected else 'false' }}">
      All
    </button>
    {% for category in categories %}
    {% set category_id = category.id %}
    {% set is_selected = category_id and (category_id == selected_category_id) %}
    <button type="button" class="filter-chip text-button{% if is_selected %} filter-chip--selected{% endif %}"
      data-category="{{ category_id }}" aria-pressed="{{ 'true' if is_selected else 'false' }}">
      {{ category.display_name }} ({{ category.public_joke_count or 0 }})
    </button>
    {% endfor %}
  </section>

  {{ infinite_scroll_feed(
  slug='admin-social',
  initial_jokes=jokes,
  initial_cursor=next_cursor,
  initial_has_more=has_more,
  width=image_size,
  feed_id='admin-social-feed',
  end_of_feed_message="No more jokes match these filters.",
  extra_query_params={'category': selected_category_id},
  admin_stats_enabled=true,
  grid_enabled=true,
  selectable_cards=true,
  ) }}
</div>

<div class="admin-modal" id="admin-social-post-modal" aria-hidden="true">
  <div class="admin-modal__backdrop" data-close="true"></div>
  <div class="admin-modal__dialog">
    <h4 class="admin-modal__title">Mark as posted</h4>
    <div class="admin-modal__content">
      <div class="social-post-modal__field">
        <label class="post-type-select-label" for="admin-social-post-id-input">
          Post ID
        </label>
        <input class="social-posts-edit-input" id="admin-social-post-id-input" type="text" placeholder="Enter post ID">
      </div>
    </div>
    <div class="social-post-modal__actions">
      <button type="button" class="text-button" id="admin-social-post-cancel">
        Cancel
      </button>
      <button type="button" class="text-button" id="admin-social-post-submit">
        Submit
      </button>
    </div>
  </div>
</div>

<script>
  (function () {
    const maxSelection = 5;
    const feedContainer = document.getElementById('admin-social-feed');
    const createPostBtn = document.getElementById('admin-social-create-button');
    const postTypeSelect = document.getElementById('admin-social-post-type');
    const pinPreview = document.getElementById('admin-social-pin-preview');
    const selectionRow = document.getElementById('admin-social-pin-selection');
    const socialPostsList = document.querySelector('.social-posts-list');
    const selectedJokes = [];
    const categoryChips = Array.from(document.querySelectorAll('.filter-chip[data-category]'));
    const postModal = document.getElementById('admin-social-post-modal');
    const postModalInput = document.getElementById('admin-social-post-id-input');
    const postModalSubmit = document.getElementById('admin-social-post-submit');
    const postModalCancel = document.getElementById('admin-social-post-cancel');
    let activePostCard = null;
    let activePostPlatform = '';
    // Use same-origin rewrite so the admin session cookie is included.
    const createPostEndpoint = '/joke_creation_process';

    async function sendSocialRequest(payload) {
      const resp = await fetch(createPostEndpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ data: { op: 'social', ...payload } }),
      });

      if (!resp.ok) {
        const data = await resp.json().catch(() => ({}));
        const error = data?.data?.error || 'Failed to update social post';
        throw new Error(error);
      }

      const data = await resp.json().catch(() => ({}));
      return data?.data || {};
    }

    async function runWithButtonState(button, actionText, action) {
      const originalText = button.textContent;
      const originalDisabled = button.disabled;
      button.disabled = true;
      button.textContent = actionText;
      try {
        await action();
      } finally {
        const platformRoot = button.closest('.social-platform');
        const keepDisabled = platformRoot
          && platformRoot.classList.contains('social-platform--locked');
        button.disabled = keepDisabled ? true : originalDisabled;
        button.textContent = originalText;
      }
    }

    function setFieldValue(element, value) {
      if (!element) {
        return;
      }
      const emptyText = element.dataset.emptyText || '';
      if (value) {
        element.textContent = value;
        element.classList.remove('is-empty');
      } else {
        element.textContent = emptyText;
        element.classList.add('is-empty');
      }
    }

    function setPlatformLocked(card, platform, isLocked) {
      const platformRoot = card.querySelector(
        `.social-platform[data-platform="${platform}"]`);
      if (!platformRoot) {
        return;
      }
      platformRoot.classList.toggle('social-platform--locked', isLocked);
      platformRoot.querySelectorAll('button, input, textarea').forEach((el) => {
        el.disabled = isLocked;
      });
      const postButton = platformRoot.querySelector('.js-social-post-button');
      if (postButton) {
        postButton.style.display = isLocked ? 'none' : '';
      }
    }

    function renderImageList(slot, imageUrls, altText, singleClass) {
      if (!slot) {
        return;
      }
      slot.innerHTML = '';

      if (Array.isArray(imageUrls) && imageUrls.length > 0) {
        if (imageUrls.length === 1) {
          const link = document.createElement('a');
          link.href = imageUrls[0];
          link.target = '_blank';
          link.rel = 'noopener';
          const img = document.createElement('img');
          if (singleClass) {
            img.className = singleClass;
          }
          img.src = imageUrls[0];
          img.alt = altText || 'Image';
          link.appendChild(img);
          slot.appendChild(link);
        } else {
          const grid = document.createElement('div');
          grid.className = 'social-posts-thumb-grid';
          imageUrls.forEach((url, index) => {
            const link = document.createElement('a');
            link.href = url;
            link.target = '_blank';
            link.rel = 'noopener';
            const img = document.createElement('img');
            img.src = url;
            img.alt = `${altText || 'Image'} ${index + 1}`;
            link.appendChild(img);
            grid.appendChild(link);
          });
          slot.appendChild(grid);
        }
      } else {
        const empty = document.createElement('span');
        empty.className = 'muted js-social-no-image';
        empty.textContent = 'No image';
        slot.appendChild(empty);
      }
    }

    function renderCarouselPreview(slot, pinterestUrls, gridUrls) {
      if (!slot) {
        return;
      }
      slot.innerHTML = '';

      const hasPinterest = Array.isArray(pinterestUrls) && pinterestUrls.length > 0;
      const hasGrid = Array.isArray(gridUrls) && gridUrls.length > 0;

      if (!hasPinterest && !hasGrid) {
        const empty = document.createElement('span');
        empty.className = 'muted js-social-no-image';
        empty.textContent = 'No image';
        slot.appendChild(empty);
        return;
      }

      const layout = document.createElement('div');
      layout.className = 'social-posts-carousel-layout';

      const pin = document.createElement('div');
      pin.className = 'social-posts-carousel-pin';
      if (hasPinterest) {
        const link = document.createElement('a');
        link.href = pinterestUrls[0];
        link.target = '_blank';
        link.rel = 'noopener';
        const img = document.createElement('img');
        img.src = pinterestUrls[0];
        img.alt = 'Pinterest giraffe image';
        link.appendChild(img);
        pin.appendChild(link);
      } else {
        const empty = document.createElement('span');
        empty.className = 'muted js-social-no-image';
        empty.textContent = 'No Pinterest image';
        pin.appendChild(empty);
      }
      layout.appendChild(pin);

      const grid = document.createElement('div');
      grid.className = 'social-posts-carousel-grid';
      if (hasGrid) {
        gridUrls.forEach((url, index) => {
          const link = document.createElement('a');
          link.href = url;
          link.target = '_blank';
          link.rel = 'noopener';
          const img = document.createElement('img');
          img.src = url;
          img.alt = `Carousel image ${index + 1}`;
          link.appendChild(img);
          grid.appendChild(link);
        });
      } else {
        const empty = document.createElement('span');
        empty.className = 'muted js-social-no-image';
        empty.textContent = 'No carousel images';
        grid.appendChild(empty);
      }
      layout.appendChild(grid);

      slot.appendChild(layout);
    }

    function updatePlatformImage(row, platform, imageUrls, altText) {
      const container = row.querySelector(
        `.js-social-platform-image[data-platform="${platform}"]`);
      if (!container) {
        return;
      }
      const slot = container.querySelector('.js-social-platform-image-slot') || container;
      renderImageList(slot, imageUrls, altText || `${platform} image`, 'social-posts-thumb');
    }

    function updateCarouselImages(card, pinterestUrls, gridUrls) {
      const container = card.querySelector('.js-social-carousel');
      if (!container) {
        return;
      }
      const slot = container.querySelector('.js-social-carousel-slot') || container;
      renderCarouselPreview(slot, pinterestUrls, gridUrls);
    }

    function getCarouselPreviewImages(postData) {
      const pinterestUrls = Array.isArray(postData.pinterest_image_urls)
        ? postData.pinterest_image_urls
        : [];
      let gridUrls = [];
      if (Array.isArray(postData.instagram_image_urls)
        && postData.instagram_image_urls.length) {
        gridUrls = postData.instagram_image_urls;
      } else if (Array.isArray(postData.facebook_image_urls)
        && postData.facebook_image_urls.length) {
        gridUrls = postData.facebook_image_urls;
      } else if (pinterestUrls.length) {
        gridUrls = pinterestUrls;
      }
      return { pinterestUrls, gridUrls };
    }

    function renderSelectionRow() {
      if (!selectionRow) {
        return;
      }
      selectionRow.innerHTML = '';
      selectedJokes.forEach((joke) => {
        const thumb = document.createElement('div');
        thumb.className = 'pin-selection-item';
        if (joke.setupUrl) {
          const img = document.createElement('img');
          img.src = joke.setupUrl;
          img.alt = 'Selected setup image';
          img.loading = 'lazy';
          thumb.appendChild(img);
        } else {
          thumb.textContent = 'No setup';
        }
        selectionRow.appendChild(thumb);
      });
    }

    function escapeSelector(value) {
      if (window.CSS && typeof CSS.escape === 'function') {
        return CSS.escape(value);
      }
      return value.replace(/["\\]/g, '\\$&');
    }

    function formatPostDate(value) {
      if (!value) {
        return 'Not posted';
      }
      const parsed = new Date(value);
      if (Number.isNaN(parsed.getTime())) {
        return String(value);
      }
      return parsed.toISOString().slice(0, 16).replace('T', ' ');
    }

    function updatePostsCount() {
      const countLabel = document.querySelector('.social-posts-header .muted');
      if (!countLabel || !socialPostsList) {
        return;
      }
      const cards = socialPostsList.querySelectorAll('.social-post-card');
      countLabel.textContent = `${cards.length} posts`;
    }

    function updateCardActionsVisibility(card) {
      const actions = card.querySelector('.social-post-card__actions');
      if (!actions) {
        return;
      }
      const pinterestLocked = Boolean(
        card.dataset.pinterestPostTime || card.dataset.pinterestPostId);
      const instagramLocked = Boolean(
        card.dataset.instagramPostTime || card.dataset.instagramPostId);
      const facebookLocked = Boolean(
        card.dataset.facebookPostTime || card.dataset.facebookPostId);
      const anyPosted = pinterestLocked || instagramLocked || facebookLocked;
      const deleteButton = card.querySelector('.js-social-delete');
      if (deleteButton) {
        deleteButton.hidden = anyPosted;
      }
      actions.hidden = pinterestLocked && instagramLocked && facebookLocked;
      if (actions.hidden) {
        card.classList.remove('is-editing');
        const editButton = card.querySelector('.js-social-edit-toggle');
        if (editButton) {
          editButton.textContent = 'Edit';
        }
      }
    }

    function setTitleLink(card, titleText, linkUrl) {
      const titleContainer = card.querySelector('.social-post-card__title');
      if (!titleContainer) {
        return;
      }
      titleContainer.innerHTML = '';
      if (linkUrl) {
        const link = document.createElement('a');
        link.className = 'js-social-link';
        link.target = '_blank';
        link.rel = 'noopener';
        link.href = linkUrl;
        const span = document.createElement('span');
        span.className = 'js-social-title';
        span.textContent = titleText;
        link.appendChild(span);
        titleContainer.appendChild(link);
      } else {
        const span = document.createElement('span');
        span.className = 'js-social-title js-social-link-empty';
        span.textContent = titleText;
        titleContainer.appendChild(span);
      }
    }

    function setStatusValue(element, postId, postTime) {
      if (!element) {
        return;
      }
      const emptyText = element.dataset.emptyText || '';
      if (postId || postTime) {
        let text = '';
        if (postId && postTime) {
          text = `${postId} (${formatPostDate(postTime)})`;
        } else if (postId) {
          text = postId;
        } else {
          text = `(${formatPostDate(postTime)})`;
        }
        element.textContent = text;
        element.classList.remove('is-empty');
      } else {
        element.textContent = emptyText;
        element.classList.add('is-empty');
      }
    }

    function populateEditInputs(card) {
      const pinterestTitleInput = card.querySelector('.js-social-pinterest-title-input');
      const pinterestDescriptionInput = card.querySelector(
        '.js-social-pinterest-description-input');
      const pinterestAltInput = card.querySelector('.js-social-pinterest-alt-text-input');
      if (pinterestTitleInput) {
        pinterestTitleInput.value = card.dataset.pinterestTitle || '';
      }
      if (pinterestDescriptionInput) {
        pinterestDescriptionInput.value = card.dataset.pinterestDescription || '';
      }
      if (pinterestAltInput) {
        pinterestAltInput.value = card.dataset.pinterestAltText || '';
      }

      const instagramCaptionInput = card.querySelector('.js-social-instagram-caption-input');
      const instagramAltInput = card.querySelector('.js-social-instagram-alt-text-input');
      if (instagramCaptionInput) {
        instagramCaptionInput.value = card.dataset.instagramCaption || '';
      }
      if (instagramAltInput) {
        instagramAltInput.value = card.dataset.instagramAltText || '';
      }

      const facebookMessageInput = card.querySelector('.js-social-facebook-message-input');
      if (facebookMessageInput) {
        facebookMessageInput.value = card.dataset.facebookMessage || '';
      }
    }

    function updatePostCard(card, postId, postData) {
      card.dataset.postId = postId || '';
      card.dataset.postType = postData.type || '';
      card.dataset.linkUrl = postData.link_url || '';
      card.dataset.pinterestTitle = postData.pinterest_title || '';
      card.dataset.pinterestDescription = postData.pinterest_description || '';
      card.dataset.pinterestAltText = postData.pinterest_alt_text || '';
      card.dataset.pinterestPostId = postData.pinterest_post_id || '';
      card.dataset.pinterestPostTime = postData.pinterest_post_time || '';
      card.dataset.pinterestImageUrls = JSON.stringify(postData.pinterest_image_urls || []);
      card.dataset.instagramCaption = postData.instagram_caption || '';
      card.dataset.instagramAltText = postData.instagram_alt_text || '';
      card.dataset.instagramPostId = postData.instagram_post_id || '';
      card.dataset.instagramPostTime = postData.instagram_post_time || '';
      card.dataset.instagramImageUrls = JSON.stringify(postData.instagram_image_urls || []);
      card.dataset.facebookMessage = postData.facebook_message || '';
      card.dataset.facebookPostId = postData.facebook_post_id || '';
      card.dataset.facebookPostTime = postData.facebook_post_time || '';
      card.dataset.facebookImageUrls = JSON.stringify(postData.facebook_image_urls || []);

      if (postData.type) {
        const typeCell = card.querySelector('.js-social-type');
        if (typeCell) {
          typeCell.textContent = `(${postData.type})`;
        }
      }

      const titleText = postData.pinterest_title || 'No title';
      setTitleLink(card, titleText, postData.link_url || '');

      setFieldValue(
        card.querySelector('.js-social-pinterest-title'),
        postData.pinterest_title,
      );
      setFieldValue(
        card.querySelector('.js-social-pinterest-description'),
        postData.pinterest_description,
      );
      setFieldValue(
        card.querySelector('.js-social-pinterest-alt-text'),
        postData.pinterest_alt_text,
      );
      setFieldValue(
        card.querySelector('.js-social-instagram-caption'),
        postData.instagram_caption,
      );
      setFieldValue(
        card.querySelector('.js-social-instagram-alt-text'),
        postData.instagram_alt_text,
      );
      setFieldValue(
        card.querySelector('.js-social-facebook-message'),
        postData.facebook_message,
      );

      setStatusValue(
        card.querySelector('.js-social-pinterest-status'),
        postData.pinterest_post_id,
        postData.pinterest_post_time,
      );
      setStatusValue(
        card.querySelector('.js-social-instagram-status'),
        postData.instagram_post_id,
        postData.instagram_post_time,
      );
      setStatusValue(
        card.querySelector('.js-social-facebook-status'),
        postData.facebook_post_id,
        postData.facebook_post_time,
      );

      const isCarousel = postData.type === 'JOKE_CAROUSEL';
      const carouselPreview = isCarousel
        ? getCarouselPreviewImages(postData)
        : { pinterestUrls: [], gridUrls: [] };
      updateCarouselImages(
        card,
        carouselPreview.pinterestUrls,
        carouselPreview.gridUrls,
      );

      updatePlatformImage(card, 'pinterest', postData.pinterest_image_urls || [],
        'Pinterest image');
      updatePlatformImage(card, 'instagram', postData.instagram_image_urls || [],
        'Instagram image');
      updatePlatformImage(card, 'facebook', postData.facebook_image_urls || [],
        'Facebook image');

      populateEditInputs(card);

      setPlatformLocked(
        card,
        'pinterest',
        Boolean(postData.pinterest_post_time || postData.pinterest_post_id),
      );
      setPlatformLocked(
        card,
        'instagram',
        Boolean(postData.instagram_post_time || postData.instagram_post_id),
      );
      setPlatformLocked(
        card,
        'facebook',
        Boolean(postData.facebook_post_time || postData.facebook_post_id),
      );
      updateCardActionsVisibility(card);
    }

    function createPostCard(postId, postData) {
      if (!socialPostsList) {
        return null;
      }
      const card = document.createElement('article');
      card.className = 'social-post-card';
      card.innerHTML = `
        <header class="social-post-card__header">
          <span class="social-post-card__timestamp js-social-created">Just now</span>
          <span>:</span>
          <span class="social-post-card__title">
            <span class="js-social-title js-social-link-empty">No title</span>
          </span>
          <span class="social-post-card__type js-social-type"></span>
        </header>
        <div class="social-posts-carousel js-social-carousel">
          <div class="js-social-carousel-slot">
            <span class="muted js-social-no-image">No image</span>
          </div>
        </div>
        <div class="social-post-card__columns">
          <div class="social-platform" data-platform="pinterest">
            <div class="social-posts-image js-social-platform-image" data-platform="pinterest">
              <div class="social-posts-logo" aria-hidden="true">
                <img src="https://images.quillsstorybook.com/cdn-cgi/image/width=50,format=auto,quality=50/_joke_assets/logos/logo_pinterest.png"
                  alt="" loading="lazy" decoding="async">
              </div>
              <div class="social-posts-image-slot js-social-platform-image-slot" data-platform="pinterest">
                <span class="muted js-social-no-image">No image</span>
              </div>
            </div>
            <div class="social-platform-field">
              <span class="social-platform-label">Title</span>
              <span class="social-platform-value js-social-pinterest-title is-empty"
                    data-empty-text="No title">No title</span>
              <input class="social-posts-edit-input js-social-pinterest-title-input"
                     type="text"
                     maxlength="100">
            </div>
            <div class="social-platform-field">
              <span class="social-platform-label">Description</span>
              <span class="social-platform-value js-social-pinterest-description is-empty"
                    data-empty-text="No description">No description</span>
              <textarea class="social-posts-edit-textarea js-social-pinterest-description-input"
                        maxlength="500"></textarea>
            </div>
            <div class="social-platform-field">
              <span class="social-platform-label">Alt text</span>
              <span class="social-platform-value js-social-pinterest-alt-text is-empty"
                    data-empty-text="No alt text">No alt text</span>
              <textarea class="social-posts-edit-textarea js-social-pinterest-alt-text-input"
                        maxlength="500"></textarea>
            </div>
            <div class="social-platform-status">
              <span class="social-platform-value js-social-pinterest-status is-empty"
                    data-empty-text="Not posted">Not posted</span>
              <button type="button" class="text-button js-social-post-button" data-platform="pinterest">
                Post
              </button>
            </div>
          </div>
          <div class="social-platform" data-platform="instagram">
            <div class="social-posts-image js-social-platform-image" data-platform="instagram">
              <div class="social-posts-logo" aria-hidden="true">
                <img src="https://images.quillsstorybook.com/cdn-cgi/image/width=50,format=auto,quality=50/_joke_assets/logos/logo_instagram.png"
                  alt="" loading="lazy" decoding="async">
              </div>
              <div class="social-posts-image-slot js-social-platform-image-slot" data-platform="instagram">
                <span class="muted js-social-no-image">No image</span>
              </div>
            </div>
            <div class="social-platform-field">
              <span class="social-platform-label">Caption</span>
              <span class="social-platform-value js-social-instagram-caption is-empty"
                    data-empty-text="No caption">No caption</span>
              <textarea class="social-posts-edit-textarea js-social-instagram-caption-input"></textarea>
            </div>
            <div class="social-platform-field">
              <span class="social-platform-label">Alt text</span>
              <span class="social-platform-value js-social-instagram-alt-text is-empty"
                    data-empty-text="No alt text">No alt text</span>
              <textarea class="social-posts-edit-textarea js-social-instagram-alt-text-input"></textarea>
            </div>
            <div class="social-platform-status">
              <span class="social-platform-value js-social-instagram-status is-empty"
                    data-empty-text="Not posted">Not posted</span>
              <button type="button" class="text-button js-social-post-button" data-platform="instagram">
                Post
              </button>
            </div>
          </div>
          <div class="social-platform" data-platform="facebook">
            <div class="social-posts-image js-social-platform-image" data-platform="facebook">
              <div class="social-posts-logo" aria-hidden="true">
                <img src="https://images.quillsstorybook.com/cdn-cgi/image/width=50,format=auto,quality=50/_joke_assets/logos/logo_facebook.png"
                  alt="" loading="lazy" decoding="async">
              </div>
              <div class="social-posts-image-slot js-social-platform-image-slot" data-platform="facebook">
                <span class="muted js-social-no-image">No image</span>
              </div>
            </div>
            <div class="social-platform-field">
              <span class="social-platform-label">Message</span>
              <span class="social-platform-value js-social-facebook-message is-empty"
                    data-empty-text="No message">No message</span>
              <textarea class="social-posts-edit-textarea js-social-facebook-message-input"></textarea>
            </div>
            <div class="social-platform-status">
              <span class="social-platform-value js-social-facebook-status is-empty"
                    data-empty-text="Not posted">Not posted</span>
              <button type="button" class="text-button js-social-post-button" data-platform="facebook">
                Post
              </button>
            </div>
          </div>
        </div>
        <div class="social-post-card__actions">
          <button type="button" class="icon-button icon-button--danger js-social-delete"
            aria-label="Delete social post" title="Delete social post">
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path fill="currentColor"
                d="M9 3h6l1 2h5v2H3V5h5l1-2zm1 6h2v9h-2V9zm4 0h2v9h-2V9zM7 9h2v9H7V9zm-1 13h12a2 2 0 0 0 2-2V9H4v11a2 2 0 0 0 2 2z" />
            </svg>
          </button>
          <button type="button" class="text-button js-social-edit-toggle">Edit</button>
          <button type="button" class="text-button js-social-regenerate" data-regenerate-image="false">
            Regenerate text
          </button>
          <button type="button" class="text-button js-social-regenerate" data-regenerate-image="true">
            Regenerate image + text
          </button>
        </div>
      `;

      socialPostsList.insertBefore(card, socialPostsList.firstChild);
      updatePostCard(card, postId, postData);
      updatePostsCount();
      return card;
    }

    function upsertPostCard(postId, postData) {
      if (!socialPostsList || !postId) {
        return;
      }
      const selector = `.social-post-card[data-post-id="${escapeSelector(postId)}"]`;
      const existingCard = socialPostsList.querySelector(selector);
      if (existingCard) {
        updatePostCard(existingCard, postId, postData);
        return;
      }
      createPostCard(postId, postData);
    }

    function clearSelection() {
      selectedJokes.length = 0;
      if (feedContainer) {
        feedContainer.querySelectorAll('.joke-card--selected').forEach((card) => {
          card.classList.remove('joke-card--selected');
          card.setAttribute('aria-selected', 'false');
        });
      }
      if (createPostBtn) {
        createPostBtn.disabled = true;
      }
      if (pinPreview) {
        pinPreview.style.display = 'none';
        pinPreview.innerHTML = '';
      }
      renderSelectionRow();
    }

    function setSelected(chip, isSelected) {
      chip.classList.toggle('filter-chip--selected', isSelected);
      chip.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
    }

    function navigateWithCategory(categoryId) {
      const url = new URL(window.location.href);
      url.pathname = '/admin/social';
      if (categoryId) {
        url.searchParams.set('category', categoryId);
      } else {
        url.searchParams.delete('category');
      }
      url.searchParams.delete('cursor');
      window.location.assign(url.toString());
    }

    if (feedContainer && createPostBtn) {
      feedContainer.addEventListener('click', (event) => {
        const mediaTarget = event.target.closest('.joke-slide-media, .joke-slide-placeholder');
        if (!mediaTarget) {
          return;
        }
        const card = event.target.closest('.joke-card[data-selectable="true"]');
        if (!card) {
          return;
        }
        const jokeId = card.dataset.jokeId;
        if (!jokeId) {
          return;
        }
        const existingIndex = selectedJokes.findIndex((item) => item.id === jokeId);
        if (existingIndex >= 0) {
          selectedJokes.splice(existingIndex, 1);
          card.classList.remove('joke-card--selected');
          card.setAttribute('aria-selected', 'false');
        } else {
          if (selectedJokes.length >= maxSelection) {
            alert('You can select up to 5 jokes.');
            return;
          }
          selectedJokes.push({
            id: jokeId,
            setupUrl: card.dataset.setupUrl || '',
          });
          card.classList.add('joke-card--selected');
          card.setAttribute('aria-selected', 'true');
        }

        createPostBtn.disabled = selectedJokes.length === 0;
        renderSelectionRow();
      });

      createPostBtn.addEventListener('click', async () => {
        if (selectedJokes.length === 0) {
          return;
        }

        await runWithButtonState(createPostBtn, 'Creating...', async () => {
          const data = await sendSocialRequest({
            joke_ids: selectedJokes.map((joke) => joke.id),
            type: postTypeSelect?.value || '',
          });
          const postData = data?.post_data || {};
          const postId = data?.post_id || '';
          const pinUrls = postData?.pinterest_image_urls || [];
          const pinUrl = pinUrls[0];

          if (!pinUrl) {
            throw new Error('Pinterest image URL missing from response');
          }

          pinPreview.style.display = 'block';
          let img = pinPreview.querySelector('img');
          if (!img) {
            img = document.createElement('img');
            img.alt = 'Pinterest pin image';
            img.loading = 'lazy';
            pinPreview.appendChild(img);
          }
          img.src = pinUrl;
          upsertPostCard(postId, postData);
          clearSelection();
        }).catch((error) => {
          console.error('Failed to create social post:', error);
          alert('Failed to create social post: ' + error.message);
        });

        createPostBtn.disabled = selectedJokes.length === 0;
      });

      createPostBtn.disabled = true;
      renderSelectionRow();
    }

    if (socialPostsList) {
      socialPostsList.addEventListener('click', async (event) => {
        const editButton = event.target.closest('.js-social-edit-toggle');
        const regenButton = event.target.closest('.js-social-regenerate');
        const postButton = event.target.closest('.js-social-post-button');
        const deleteButton = event.target.closest('.js-social-delete');
        const actionButton = editButton || regenButton || postButton;

        const card = (actionButton || deleteButton) ? (actionButton || deleteButton).closest('.social-post-card')
          : event.target.closest('.social-post-card');
        if (!card || !card.dataset.postId) {
          return;
        }

        if (deleteButton) {
          const ok = window.confirm('Delete this social post? This cannot be undone.');
          if (!ok) {
            return;
          }
          deleteButton.disabled = true;
          try {
            await sendSocialRequest({
              post_id: card.dataset.postId,
              delete: true,
            });
            card.remove();
            updatePostsCount();
          } catch (error) {
            console.error('Failed to delete social post:', error);
            alert('Failed to delete social post: ' + error.message);
          } finally {
            deleteButton.disabled = false;
          }
          return;
        }

        if (!actionButton) {
          return;
        }

        if (postButton) {
          activePostCard = card;
          activePostPlatform = postButton.dataset.platform || '';
          if (postModalInput) {
            const platformKey = activePostPlatform || '';
            const currentValue = card.dataset[`${platformKey}PostId`] || '';
            postModalInput.value = currentValue;
          }
          if (postModal) {
            postModal.classList.add('admin-modal--open');
            postModal.setAttribute('aria-hidden', 'false');
          }
          if (postModalInput) {
            requestAnimationFrame(() => {
              postModalInput.focus();
            });
          }
          return;
        }

        if (editButton) {
          const isEditing = card.classList.contains('is-editing');
          if (!isEditing) {
            populateEditInputs(card);
            card.classList.add('is-editing');
            editButton.textContent = 'Save';
            return;
          }

          await runWithButtonState(editButton, 'Saving...', async () => {
            const payload = { post_id: card.dataset.postId };
            const pinterestLocked = card.querySelector(
              '.social-platform[data-platform="pinterest"]',
            )?.classList.contains('social-platform--locked');
            const instagramLocked = card.querySelector(
              '.social-platform[data-platform="instagram"]',
            )?.classList.contains('social-platform--locked');
            const facebookLocked = card.querySelector(
              '.social-platform[data-platform="facebook"]',
            )?.classList.contains('social-platform--locked');

            if (!pinterestLocked) {
              const titleInput = card.querySelector('.js-social-pinterest-title-input');
              const descriptionInput = card.querySelector(
                '.js-social-pinterest-description-input');
              const altInput = card.querySelector('.js-social-pinterest-alt-text-input');
              payload.pinterest_title = titleInput ? titleInput.value : '';
              payload.pinterest_description = descriptionInput ? descriptionInput.value : '';
              payload.pinterest_alt_text = altInput ? altInput.value : '';
            }
            if (!instagramLocked) {
              const captionInput = card.querySelector('.js-social-instagram-caption-input');
              const altInput = card.querySelector('.js-social-instagram-alt-text-input');
              payload.instagram_caption = captionInput ? captionInput.value : '';
              payload.instagram_alt_text = altInput ? altInput.value : '';
            }
            if (!facebookLocked) {
              const messageInput = card.querySelector('.js-social-facebook-message-input');
              payload.facebook_message = messageInput ? messageInput.value : '';
            }

            await sendSocialRequest(payload).then((data) => {
              const postData = data?.post_data || {};
              const postId = data?.post_id || card.dataset.postId;
              upsertPostCard(postId, postData);
              card.classList.remove('is-editing');
              editButton.textContent = 'Edit';
            });
          }).catch((error) => {
            console.error('Failed to update social post:', error);
            alert('Failed to update social post: ' + error.message);
          });
          return;
        }

        if (regenButton) {
          const regenerateImage = regenButton.dataset.regenerateImage === 'true';
          await runWithButtonState(regenButton, 'Regenerating...', async () => {
            await sendSocialRequest({
              post_id: card.dataset.postId,
              regenerate_text: true,
              regenerate_image: regenerateImage,
            }).then((data) => {
              const postData = data?.post_data || {};
              const postId = data?.post_id || card.dataset.postId;
              upsertPostCard(postId, postData);
            });
          }).catch((error) => {
            console.error('Failed to regenerate social post:', error);
            alert('Failed to regenerate social post: ' + error.message);
          });
        }
      });
    }

    function closePostModal() {
      if (!postModal) {
        return;
      }
      postModal.classList.remove('admin-modal--open');
      postModal.setAttribute('aria-hidden', 'true');
      if (postModalInput) {
        postModalInput.value = '';
      }
      activePostCard = null;
      activePostPlatform = '';
    }

    if (postModalCancel) {
      postModalCancel.addEventListener('click', closePostModal);
    }
    if (postModal) {
      postModal.addEventListener('click', (event) => {
        if (event.target.closest('[data-close="true"]')) {
          closePostModal();
        }
      });
    }
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closePostModal();
      }
    });
    if (postModalSubmit) {
      postModalSubmit.addEventListener('click', async () => {
        if (!activePostCard || !activePostPlatform) {
          closePostModal();
          return;
        }
        const platformPostId = postModalInput ? postModalInput.value.trim() : '';
        if (!platformPostId) {
          alert('Please enter a post ID before marking as posted.');
          return;
        }
        await runWithButtonState(postModalSubmit, 'Saving...', async () => {
          await sendSocialRequest({
            post_id: activePostCard.dataset.postId,
            mark_posted_platform: activePostPlatform,
            platform_post_id: platformPostId,
          }).then((data) => {
            const postData = data?.post_data || {};
            const postId = data?.post_id || activePostCard.dataset.postId;
            upsertPostCard(postId, postData);
            closePostModal();
          });
        }).catch((error) => {
          console.error('Failed to mark post as posted:', error);
          alert('Failed to mark post as posted: ' + error.message);
        });
      });
    }

    if (categoryChips.length) {
      categoryChips.forEach((chip) => {
        chip.addEventListener('click', () => {
          const categoryId = chip.getAttribute('data-category') || '';
          const isSelected = chip.classList.contains('filter-chip--selected');
          if (isSelected) {
            return;
          }
          clearSelection();
          categoryChips.forEach((c) => setSelected(c, c === chip));
          navigateWithCategory(categoryId || null);
        });
      });
    }
  })();
</script>
{% endblock %}
