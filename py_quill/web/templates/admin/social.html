{% extends "admin/admin_base.html" %}
{% from "components/infinite_scroll_feed.html" import infinite_scroll_feed %}

{% block title %}Social | {{ site_name }} Admin{% endblock %}

{% block head_extra %}
{{ super() }}
<style>
  .social-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
    margin-bottom: 16px;
  }

  .social-header h2 {
    margin: 0;
  }

  .social-header p {
    margin: 6px 0 0;
  }

  .social-actions {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    flex-wrap: wrap;
  }

  .pin-selection-row {
    display: flex;
    align-items: center;
    gap: 6px;
    min-height: 52px;
  }

  .pin-selection-item {
    width: 52px;
    height: 52px;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--color-border);
    background: var(--color-accent-surface);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    color: var(--color-text-muted);
  }

  .pin-selection-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .pin-controls {
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: flex-end;
  }

  .create-post-btn {
    background: var(--color-primary);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: opacity 0.2s;
  }

  .create-post-btn:hover:not(:disabled) {
    opacity: 0.9;
  }

  .create-post-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .pin-image-container {
    max-width: 260px;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--color-border);
    background: white;
  }

  .pin-image-container img {
    width: 100%;
    height: auto;
    display: block;
  }

  .joke-card--selectable .joke-slide-media,
  .joke-card--selectable .joke-slide-placeholder {
    cursor: pointer;
  }

  .joke-card--selectable.joke-card--selected {
    border-color: var(--color-primary, #c56f3a);
    box-shadow: 0 0 0 2px var(--color-primary, #c56f3a);
  }

  .social-posts {
    margin-bottom: 24px;
  }

  .social-posts-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 8px;
  }

  .social-posts-table {
    width: 100%;
    border-collapse: collapse;
  }

  .social-posts-table th,
  .social-posts-table td {
    text-align: left;
    padding: 10px 12px;
    border-bottom: 1px solid var(--color-border);
    vertical-align: top;
  }

  .social-posts-table th {
    font-size: 0.85rem;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .social-posts-title {
    font-weight: 600;
    margin-bottom: 4px;
  }

  .social-posts-description {
    color: var(--color-text-muted);
  }

  .social-posts-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
  }

  .social-posts-link {
    margin-top: 6px;
    font-size: 0.85rem;
    overflow-wrap: anywhere;
  }

  .social-posts-link a {
    color: var(--color-primary);
    text-decoration: none;
  }

  .social-posts-link a:hover {
    text-decoration: underline;
  }

  .social-posts-edit {
    margin-top: 10px;
    padding: 10px;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    background: var(--color-surface, #fff);
  }

  .social-posts-edit-label {
    display: block;
    font-size: 0.8rem;
    color: var(--color-text-muted);
    margin-bottom: 4px;
  }

  .social-posts-edit-input,
  .social-posts-edit-textarea {
    width: 100%;
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid var(--color-border);
    font-size: 0.9rem;
    margin-bottom: 8px;
  }

  .social-posts-edit-textarea {
    min-height: 70px;
    resize: vertical;
  }

  .social-posts-edit-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }

  .social-posts-thumb {
    width: 56px;
    height: 56px;
    border-radius: 8px;
    object-fit: cover;
    border: 1px solid var(--color-border);
    display: block;
  }

  .social-posts-image {
    display: inline-flex;
    align-items: center;
    min-height: 56px;
  }

  .social-posts-image a {
    display: inline-flex;
  }

  .social-platform {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .social-platform-field {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .social-platform-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--color-text-muted);
  }

  .social-platform-value {
    font-size: 0.9rem;
    overflow-wrap: anywhere;
    white-space: pre-wrap;
  }

  .social-platform-value.is-empty {
    color: var(--color-text-muted);
  }

  .social-platform-meta {
    font-size: 0.8rem;
    color: var(--color-text-muted);
  }

  .social-platform-mark {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: center;
  }

  .social-platform--locked {
    opacity: 0.7;
  }

  .post-type-select {
    padding: 6px 10px;
    border-radius: 8px;
    border: 1px solid var(--color-border);
    background: white;
    font-size: 14px;
  }

  .post-type-select-label {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    display: block;
    margin-bottom: 4px;
  }
</style>
{% endblock %}

{% block content %}
<div class="admin-jokes">
  <header class="social-header">
    <div>
      <h2>Social</h2>
      <p class="muted">Public jokes in Daily or Published state.</p>
    </div>
    <div class="social-actions">
      <div class="pin-selection-row" id="admin-social-pin-selection"></div>
      <div class="pin-controls">
        <label class="post-type-select-label" for="admin-social-post-type">Post type</label>
        <select class="post-type-select" id="admin-social-post-type">
          {% for option in post_type_options %}
          <option value="{{ option }}" {% if option == default_post_type %}selected{% endif %}>
            {{ option.replace('_', ' ') }}
          </option>
          {% endfor %}
        </select>
        <button class="create-post-btn" type="button" id="admin-social-create-button" disabled>
          Create Post
        </button>
        <div class="pin-image-container" id="admin-social-pin-preview" style="display: none;"></div>
      </div>
    </div>
  </header>

  <section class="social-posts" aria-label="Social posts list">
    <div class="social-posts-header">
      <h3>Social Posts</h3>
      <span class="muted">{{ social_posts | length }} posts</span>
    </div>
    {% if not social_posts %}
    <p class="muted">No social posts yet.</p>
    {% else %}
    <table class="social-posts-table" aria-label="Social posts table">
      <thead>
        <tr>
          <th scope="col">Created</th>
          <th scope="col">Type</th>
          <th scope="col">Link</th>
          <th scope="col">Pinterest</th>
          <th scope="col">Instagram</th>
          <th scope="col">Facebook</th>
        </tr>
      </thead>
      <tbody>
        {% for post, creation_time in social_posts %}
        {% set pinterest_locked = post.pinterest_post_date or post.pinterest_post_id %}
        {% set instagram_locked = post.instagram_post_date or post.instagram_post_id %}
        {% set facebook_locked = post.facebook_post_date or post.facebook_post_id %}
        <tr data-post-id="{{ post.key or '' }}"
            data-link-url="{{ (post.link_url or '') | e }}"
            data-pinterest-title="{{ (post.pinterest_title or '') | e }}"
            data-pinterest-description="{{ (post.pinterest_description or '') | e }}"
            data-pinterest-alt-text="{{ (post.pinterest_alt_text or '') | e }}"
            data-pinterest-post-id="{{ (post.pinterest_post_id or '') | e }}"
            data-pinterest-post-date="{{ post.pinterest_post_date.isoformat() if post.pinterest_post_date else '' }}"
            data-pinterest-image-url="{{ (post.pinterest_image_url or '') | e }}"
            data-instagram-caption="{{ (post.instagram_caption or '') | e }}"
            data-instagram-alt-text="{{ (post.instagram_alt_text or '') | e }}"
            data-instagram-post-id="{{ (post.instagram_post_id or '') | e }}"
            data-instagram-post-date="{{ post.instagram_post_date.isoformat() if post.instagram_post_date else '' }}"
            data-instagram-image-url="{{ (post.instagram_image_url or '') | e }}"
            data-facebook-message="{{ (post.facebook_message or '') | e }}"
            data-facebook-post-id="{{ (post.facebook_post_id or '') | e }}"
            data-facebook-post-date="{{ post.facebook_post_date.isoformat() if post.facebook_post_date else '' }}"
            data-facebook-image-url="{{ (post.facebook_image_url or '') | e }}">
          <td>
            {% if creation_time %}
            {{ creation_time.strftime('%Y-%m-%d %H:%M') }}
            {% else %}
            <span class="muted">Unknown</span>
            {% endif %}
          </td>
          <td class="js-social-type">{{ post.type.value }}</td>
          <td>
            <div class="social-posts-link">
              {% if post.link_url %}
              <a class="js-social-link" href="{{ post.link_url | e }}" target="_blank" rel="noopener">
                {{ post.link_url | e }}
              </a>
              {% else %}
              <span class="muted js-social-link-empty">No link</span>
              {% endif %}
            </div>
          </td>
          <td>
            <div class="social-platform{% if pinterest_locked %} social-platform--locked{% endif %}"
                 data-platform="pinterest">
              <div class="social-platform-field">
                <span class="social-platform-label">Title</span>
                <span class="social-platform-value social-posts-title js-social-pinterest-title{% if not post.pinterest_title %} is-empty{% endif %}"
                      data-empty-text="No title">{{ post.pinterest_title or 'No title' }}</span>
              </div>
              <div class="social-platform-field">
                <span class="social-platform-label">Description</span>
                <span class="social-platform-value social-posts-description js-social-pinterest-description{% if not post.pinterest_description %} is-empty{% endif %}"
                      data-empty-text="No description">{{ post.pinterest_description or 'No description' }}</span>
              </div>
              <div class="social-platform-field">
                <span class="social-platform-label">Alt text</span>
                <span class="social-platform-value js-social-pinterest-alt-text{% if not post.pinterest_alt_text %} is-empty{% endif %}"
                      data-empty-text="No alt text">{{ post.pinterest_alt_text or 'No alt text' }}</span>
              </div>
              <div class="social-posts-actions">
                <button type="button"
                        class="text-button js-social-edit"
                        data-platform="pinterest"
                        {% if pinterest_locked %}disabled{% endif %}>
                  Edit text
                </button>
                <button type="button"
                        class="text-button js-social-regenerate"
                        data-platform="pinterest"
                        data-regenerate-image="false"
                        {% if pinterest_locked %}disabled{% endif %}>
                  Regenerate text
                </button>
                <button type="button"
                        class="text-button js-social-regenerate"
                        data-platform="pinterest"
                        data-regenerate-image="true"
                        {% if pinterest_locked %}disabled{% endif %}>
                  Regenerate image + text
                </button>
              </div>
              <div class="social-posts-edit" data-platform="pinterest" hidden>
                <label class="social-posts-edit-label" for="social-pinterest-title-{{ post.key or loop.index }}">
                  Pinterest title
                </label>
                <input class="social-posts-edit-input js-social-pinterest-title-input"
                       id="social-pinterest-title-{{ post.key or loop.index }}"
                       type="text"
                       maxlength="100"
                       {% if pinterest_locked %}disabled{% endif %}>
                <label class="social-posts-edit-label" for="social-pinterest-description-{{ post.key or loop.index }}">
                  Pinterest description
                </label>
                <textarea class="social-posts-edit-textarea js-social-pinterest-description-input"
                          id="social-pinterest-description-{{ post.key or loop.index }}"
                          maxlength="500"
                          {% if pinterest_locked %}disabled{% endif %}></textarea>
                <label class="social-posts-edit-label" for="social-pinterest-alt-{{ post.key or loop.index }}">
                  Pinterest alt text
                </label>
                <textarea class="social-posts-edit-textarea js-social-pinterest-alt-text-input"
                          id="social-pinterest-alt-{{ post.key or loop.index }}"
                          maxlength="500"
                          {% if pinterest_locked %}disabled{% endif %}></textarea>
                <div class="social-posts-edit-actions">
                  <button type="button"
                          class="text-button js-social-cancel"
                          data-platform="pinterest"
                          {% if pinterest_locked %}disabled{% endif %}>
                    Cancel
                  </button>
                  <button type="button"
                          class="text-button js-social-save"
                          data-platform="pinterest"
                          {% if pinterest_locked %}disabled{% endif %}>
                    Save
                  </button>
                </div>
              </div>
              <div class="social-posts-image js-social-platform-image" data-platform="pinterest">
                {% if post.pinterest_image_url %}
                <a href="{{ post.pinterest_image_url }}" target="_blank" rel="noopener">
                  <img class="social-posts-thumb" src="{{ post.pinterest_image_url }}" alt="Pinterest image">
                </a>
                {% else %}
                <span class="muted js-social-no-image">No image</span>
                {% endif %}
              </div>
              <div class="social-platform-meta">
                Posted:
                <span class="social-platform-value js-social-pinterest-post-date{% if not post.pinterest_post_date %} is-empty{% endif %}"
                      data-empty-text="Not posted">
                  {% if post.pinterest_post_date %}
                  {{ post.pinterest_post_date.strftime('%Y-%m-%d') }}
                  {% else %}
                  Not posted
                  {% endif %}
                </span>
              </div>
              <div class="social-platform-meta">
                Post ID:
                <span class="social-platform-value js-social-pinterest-post-id{% if not post.pinterest_post_id %} is-empty{% endif %}"
                      data-empty-text="Not set">
                  {{ post.pinterest_post_id or 'Not set' }}
                </span>
              </div>
              <div class="social-platform-mark">
                <input class="social-posts-edit-input js-social-post-id-input"
                       data-platform="pinterest"
                       type="text"
                       placeholder="Pinterest post ID"
                       value="{{ (post.pinterest_post_id or '') | e }}"
                       {% if pinterest_locked %}disabled{% endif %}>
                <button type="button"
                        class="text-button js-social-mark-posted"
                        data-platform="pinterest"
                        {% if pinterest_locked %}disabled{% endif %}>
                  Mark Posted
                </button>
              </div>
            </div>
          </td>
          <td>
            <div class="social-platform{% if instagram_locked %} social-platform--locked{% endif %}"
                 data-platform="instagram">
              <div class="social-platform-field">
                <span class="social-platform-label">Caption</span>
                <span class="social-platform-value js-social-instagram-caption{% if not post.instagram_caption %} is-empty{% endif %}"
                      data-empty-text="No caption">{{ post.instagram_caption or 'No caption' }}</span>
              </div>
              <div class="social-platform-field">
                <span class="social-platform-label">Alt text</span>
                <span class="social-platform-value js-social-instagram-alt-text{% if not post.instagram_alt_text %} is-empty{% endif %}"
                      data-empty-text="No alt text">{{ post.instagram_alt_text or 'No alt text' }}</span>
              </div>
              <div class="social-posts-actions">
                <button type="button"
                        class="text-button js-social-edit"
                        data-platform="instagram"
                        {% if instagram_locked %}disabled{% endif %}>
                  Edit text
                </button>
              </div>
              <div class="social-posts-edit" data-platform="instagram" hidden>
                <label class="social-posts-edit-label" for="social-instagram-caption-{{ post.key or loop.index }}">
                  Instagram caption
                </label>
                <textarea class="social-posts-edit-textarea js-social-instagram-caption-input"
                          id="social-instagram-caption-{{ post.key or loop.index }}"
                          {% if instagram_locked %}disabled{% endif %}></textarea>
                <label class="social-posts-edit-label" for="social-instagram-alt-{{ post.key or loop.index }}">
                  Instagram alt text
                </label>
                <textarea class="social-posts-edit-textarea js-social-instagram-alt-text-input"
                          id="social-instagram-alt-{{ post.key or loop.index }}"
                          {% if instagram_locked %}disabled{% endif %}></textarea>
                <div class="social-posts-edit-actions">
                  <button type="button"
                          class="text-button js-social-cancel"
                          data-platform="instagram"
                          {% if instagram_locked %}disabled{% endif %}>
                    Cancel
                  </button>
                  <button type="button"
                          class="text-button js-social-save"
                          data-platform="instagram"
                          {% if instagram_locked %}disabled{% endif %}>
                    Save
                  </button>
                </div>
              </div>
              <div class="social-posts-image js-social-platform-image" data-platform="instagram">
                {% if post.instagram_image_url %}
                <a href="{{ post.instagram_image_url }}" target="_blank" rel="noopener">
                  <img class="social-posts-thumb" src="{{ post.instagram_image_url }}" alt="Instagram image">
                </a>
                {% else %}
                <span class="muted js-social-no-image">No image</span>
                {% endif %}
              </div>
              <div class="social-platform-meta">
                Posted:
                <span class="social-platform-value js-social-instagram-post-date{% if not post.instagram_post_date %} is-empty{% endif %}"
                      data-empty-text="Not posted">
                  {% if post.instagram_post_date %}
                  {{ post.instagram_post_date.strftime('%Y-%m-%d') }}
                  {% else %}
                  Not posted
                  {% endif %}
                </span>
              </div>
              <div class="social-platform-meta">
                Post ID:
                <span class="social-platform-value js-social-instagram-post-id{% if not post.instagram_post_id %} is-empty{% endif %}"
                      data-empty-text="Not set">
                  {{ post.instagram_post_id or 'Not set' }}
                </span>
              </div>
              <div class="social-platform-mark">
                <input class="social-posts-edit-input js-social-post-id-input"
                       data-platform="instagram"
                       type="text"
                       placeholder="Instagram post ID"
                       value="{{ (post.instagram_post_id or '') | e }}"
                       {% if instagram_locked %}disabled{% endif %}>
                <button type="button"
                        class="text-button js-social-mark-posted"
                        data-platform="instagram"
                        {% if instagram_locked %}disabled{% endif %}>
                  Mark Posted
                </button>
              </div>
            </div>
          </td>
          <td>
            <div class="social-platform{% if facebook_locked %} social-platform--locked{% endif %}"
                 data-platform="facebook">
              <div class="social-platform-field">
                <span class="social-platform-label">Message</span>
                <span class="social-platform-value js-social-facebook-message{% if not post.facebook_message %} is-empty{% endif %}"
                      data-empty-text="No message">{{ post.facebook_message or 'No message' }}</span>
              </div>
              <div class="social-posts-actions">
                <button type="button"
                        class="text-button js-social-edit"
                        data-platform="facebook"
                        {% if facebook_locked %}disabled{% endif %}>
                  Edit text
                </button>
              </div>
              <div class="social-posts-edit" data-platform="facebook" hidden>
                <label class="social-posts-edit-label" for="social-facebook-message-{{ post.key or loop.index }}">
                  Facebook message
                </label>
                <textarea class="social-posts-edit-textarea js-social-facebook-message-input"
                          id="social-facebook-message-{{ post.key or loop.index }}"
                          {% if facebook_locked %}disabled{% endif %}></textarea>
                <div class="social-posts-edit-actions">
                  <button type="button"
                          class="text-button js-social-cancel"
                          data-platform="facebook"
                          {% if facebook_locked %}disabled{% endif %}>
                    Cancel
                  </button>
                  <button type="button"
                          class="text-button js-social-save"
                          data-platform="facebook"
                          {% if facebook_locked %}disabled{% endif %}>
                    Save
                  </button>
                </div>
              </div>
              <div class="social-posts-image js-social-platform-image" data-platform="facebook">
                {% if post.facebook_image_url %}
                <a href="{{ post.facebook_image_url }}" target="_blank" rel="noopener">
                  <img class="social-posts-thumb" src="{{ post.facebook_image_url }}" alt="Facebook image">
                </a>
                {% else %}
                <span class="muted js-social-no-image">No image</span>
                {% endif %}
              </div>
              <div class="social-platform-meta">
                Posted:
                <span class="social-platform-value js-social-facebook-post-date{% if not post.facebook_post_date %} is-empty{% endif %}"
                      data-empty-text="Not posted">
                  {% if post.facebook_post_date %}
                  {{ post.facebook_post_date.strftime('%Y-%m-%d') }}
                  {% else %}
                  Not posted
                  {% endif %}
                </span>
              </div>
              <div class="social-platform-meta">
                Post ID:
                <span class="social-platform-value js-social-facebook-post-id{% if not post.facebook_post_id %} is-empty{% endif %}"
                      data-empty-text="Not set">
                  {{ post.facebook_post_id or 'Not set' }}
                </span>
              </div>
              <div class="social-platform-mark">
                <input class="social-posts-edit-input js-social-post-id-input"
                       data-platform="facebook"
                       type="text"
                       placeholder="Facebook post ID"
                       value="{{ (post.facebook_post_id or '') | e }}"
                       {% if facebook_locked %}disabled{% endif %}>
                <button type="button"
                        class="text-button js-social-mark-posted"
                        data-platform="facebook"
                        {% if facebook_locked %}disabled{% endif %}>
                  Mark Posted
                </button>
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}
  </section>

  <section class="filter-chips" aria-label="Joke category filters">
    {% set all_selected = selected_category_id is none %}
    <button type="button" class="filter-chip text-button{% if all_selected %} filter-chip--selected{% endif %}"
      data-category="" aria-pressed="{{ 'true' if all_selected else 'false' }}">
      All
    </button>
    {% for category in categories %}
    {% set category_id = category.id %}
    {% set is_selected = category_id and (category_id == selected_category_id) %}
    <button type="button" class="filter-chip text-button{% if is_selected %} filter-chip--selected{% endif %}"
      data-category="{{ category_id }}" aria-pressed="{{ 'true' if is_selected else 'false' }}">
      {{ category.display_name }} ({{ category.public_joke_count or 0 }})
    </button>
    {% endfor %}
  </section>

  {{ infinite_scroll_feed(
  slug='admin-social',
  initial_jokes=jokes,
  initial_cursor=next_cursor,
  initial_has_more=has_more,
  width=image_size,
  feed_id='admin-social-feed',
  end_of_feed_message="No more jokes match these filters.",
  extra_query_params={'category': selected_category_id},
  admin_stats_enabled=true,
  grid_enabled=true,
  selectable_cards=true,
  ) }}
</div>

<script>
  (function () {
    const maxSelection = 5;
    const feedContainer = document.getElementById('admin-social-feed');
    const createPostBtn = document.getElementById('admin-social-create-button');
    const postTypeSelect = document.getElementById('admin-social-post-type');
    const pinPreview = document.getElementById('admin-social-pin-preview');
    const selectionRow = document.getElementById('admin-social-pin-selection');
    const socialPostsTable = document.querySelector('.social-posts-table');
    const selectedJokes = [];
    const categoryChips = Array.from(document.querySelectorAll('.filter-chip[data-category]'));
    // Use same-origin rewrite so the admin session cookie is included.
    const createPostEndpoint = '/social_post_creation_process';

    async function sendSocialRequest(payload) {
      const resp = await fetch(createPostEndpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ data: payload }),
      });

      if (!resp.ok) {
        const data = await resp.json().catch(() => ({}));
        const error = data?.data?.error || 'Failed to update social post';
        throw new Error(error);
      }

      const data = await resp.json().catch(() => ({}));
      return data?.data || {};
    }

    async function runWithButtonState(button, actionText, action) {
      const originalText = button.textContent;
      const originalDisabled = button.disabled;
      button.disabled = true;
      button.textContent = actionText;
      try {
        await action();
      } finally {
        const platformRoot = button.closest('.social-platform');
        const keepDisabled = platformRoot
          && platformRoot.classList.contains('social-platform--locked');
        button.disabled = keepDisabled ? true : originalDisabled;
        button.textContent = originalText;
      }
    }

    function setFieldValue(element, value) {
      if (!element) {
        return;
      }
      const emptyText = element.dataset.emptyText || '';
      if (value) {
        element.textContent = value;
        element.classList.remove('is-empty');
      } else {
        element.textContent = emptyText;
        element.classList.add('is-empty');
      }
    }

    function setDateValue(element, value) {
      if (!element) {
        return;
      }
      if (value) {
        element.textContent = formatPostDate(value);
        element.classList.remove('is-empty');
      } else {
        element.textContent = element.dataset.emptyText || '';
        element.classList.add('is-empty');
      }
    }

    function setPlatformLocked(row, platform, isLocked) {
      const platformRoot = row.querySelector(
        `.social-platform[data-platform="${platform}"]`);
      if (!platformRoot) {
        return;
      }
      platformRoot.classList.toggle('social-platform--locked', isLocked);
      platformRoot.querySelectorAll('button, input, textarea').forEach((el) => {
        el.disabled = isLocked;
      });
      if (isLocked) {
        const editPanel = platformRoot.querySelector('.social-posts-edit');
        if (editPanel) {
          editPanel.hidden = true;
        }
      }
    }

    function updatePlatformImage(row, platform, imageUrl, altText) {
      const container = row.querySelector(
        `.js-social-platform-image[data-platform="${platform}"]`);
      if (!container) {
        return;
      }
      const existingLink = container.querySelector('a');
      const existingImg = container.querySelector('img');
      const noImage = container.querySelector('.js-social-no-image');

      if (imageUrl) {
        let link = existingLink;
        if (!link) {
          link = document.createElement('a');
          link.target = '_blank';
          link.rel = 'noopener';
          container.innerHTML = '';
          container.appendChild(link);
        }
        let img = existingImg;
        if (!img) {
          img = document.createElement('img');
          img.className = 'social-posts-thumb';
          link.appendChild(img);
        }
        link.href = imageUrl;
        img.alt = altText;
        img.src = imageUrl;
      } else {
        if (existingLink) {
          existingLink.remove();
        }
        if (!noImage) {
          const empty = document.createElement('span');
          empty.className = 'muted js-social-no-image';
          empty.textContent = 'No image';
          container.appendChild(empty);
        }
      }
    }

    function renderSelectionRow() {
      if (!selectionRow) {
        return;
      }
      selectionRow.innerHTML = '';
      selectedJokes.forEach((joke) => {
        const thumb = document.createElement('div');
        thumb.className = 'pin-selection-item';
        if (joke.setupUrl) {
          const img = document.createElement('img');
          img.src = joke.setupUrl;
          img.alt = 'Selected setup image';
          img.loading = 'lazy';
          thumb.appendChild(img);
        } else {
          thumb.textContent = 'No setup';
        }
        selectionRow.appendChild(thumb);
      });
    }

    function escapeSelector(value) {
      if (window.CSS && typeof CSS.escape === 'function') {
        return CSS.escape(value);
      }
      return value.replace(/["\\]/g, '\\$&');
    }

    function formatPostDate(value) {
      if (!value) {
        return 'Not posted';
      }
      const parsed = new Date(value);
      if (Number.isNaN(parsed.getTime())) {
        return String(value);
      }
      return parsed.toISOString().slice(0, 10);
    }

    function updatePostsCount() {
      const countLabel = document.querySelector('.social-posts-header .muted');
      if (!countLabel || !socialPostsTable) {
        return;
      }
      const rows = socialPostsTable.querySelectorAll('tbody tr');
      countLabel.textContent = `${rows.length} posts`;
    }

    function updatePostRow(row, postId, postData) {
      row.dataset.postId = postId || '';
      row.dataset.linkUrl = postData.link_url || '';
      row.dataset.pinterestTitle = postData.pinterest_title || '';
      row.dataset.pinterestDescription = postData.pinterest_description || '';
      row.dataset.pinterestAltText = postData.pinterest_alt_text || '';
      row.dataset.pinterestPostId = postData.pinterest_post_id || '';
      row.dataset.pinterestPostDate = postData.pinterest_post_date || '';
      row.dataset.pinterestImageUrl = postData.pinterest_image_url || '';
      row.dataset.instagramCaption = postData.instagram_caption || '';
      row.dataset.instagramAltText = postData.instagram_alt_text || '';
      row.dataset.instagramPostId = postData.instagram_post_id || '';
      row.dataset.instagramPostDate = postData.instagram_post_date || '';
      row.dataset.instagramImageUrl = postData.instagram_image_url || '';
      row.dataset.facebookMessage = postData.facebook_message || '';
      row.dataset.facebookPostId = postData.facebook_post_id || '';
      row.dataset.facebookPostDate = postData.facebook_post_date || '';
      row.dataset.facebookImageUrl = postData.facebook_image_url || '';

      if (postData.type) {
        const typeCell = row.querySelector('.js-social-type');
        if (typeCell) {
          typeCell.textContent = postData.type;
        }
      }

      const linkEl = row.querySelector('.js-social-link');
      const linkEmptyEl = row.querySelector('.js-social-link-empty');
      if (postData.link_url) {
        if (linkEl) {
          linkEl.href = postData.link_url;
          linkEl.textContent = postData.link_url;
          linkEl.hidden = false;
        }
        if (linkEmptyEl) {
          linkEmptyEl.remove();
        }
      } else {
        if (linkEl) {
          linkEl.removeAttribute('href');
          linkEl.textContent = '';
          linkEl.hidden = true;
        }
        if (!linkEmptyEl) {
          const empty = document.createElement('span');
          empty.className = 'muted js-social-link-empty';
          empty.textContent = 'No link';
          const linkContainer = row.querySelector('.social-posts-link');
          if (linkContainer) {
            linkContainer.appendChild(empty);
          }
        }
      }

      setFieldValue(
        row.querySelector('.js-social-pinterest-title'),
        postData.pinterest_title,
      );
      setFieldValue(
        row.querySelector('.js-social-pinterest-description'),
        postData.pinterest_description,
      );
      setFieldValue(
        row.querySelector('.js-social-pinterest-alt-text'),
        postData.pinterest_alt_text,
      );
      setFieldValue(
        row.querySelector('.js-social-instagram-caption'),
        postData.instagram_caption,
      );
      setFieldValue(
        row.querySelector('.js-social-instagram-alt-text'),
        postData.instagram_alt_text,
      );
      setFieldValue(
        row.querySelector('.js-social-facebook-message'),
        postData.facebook_message,
      );

      setDateValue(
        row.querySelector('.js-social-pinterest-post-date'),
        postData.pinterest_post_date,
      );
      setFieldValue(
        row.querySelector('.js-social-pinterest-post-id'),
        postData.pinterest_post_id,
      );
      setDateValue(
        row.querySelector('.js-social-instagram-post-date'),
        postData.instagram_post_date,
      );
      setFieldValue(
        row.querySelector('.js-social-instagram-post-id'),
        postData.instagram_post_id,
      );
      setDateValue(
        row.querySelector('.js-social-facebook-post-date'),
        postData.facebook_post_date,
      );
      setFieldValue(
        row.querySelector('.js-social-facebook-post-id'),
        postData.facebook_post_id,
      );

      updatePlatformImage(row, 'pinterest', postData.pinterest_image_url,
                          'Pinterest image');
      updatePlatformImage(row, 'instagram', postData.instagram_image_url,
                          'Instagram image');
      updatePlatformImage(row, 'facebook', postData.facebook_image_url,
                          'Facebook image');

      const pinterestTitleInput = row.querySelector('.js-social-pinterest-title-input');
      const pinterestDescriptionInput = row.querySelector(
        '.js-social-pinterest-description-input');
      const pinterestAltInput = row.querySelector('.js-social-pinterest-alt-text-input');
      if (pinterestTitleInput) pinterestTitleInput.value = postData.pinterest_title || '';
      if (pinterestDescriptionInput) {
        pinterestDescriptionInput.value = postData.pinterest_description || '';
      }
      if (pinterestAltInput) pinterestAltInput.value = postData.pinterest_alt_text || '';

      const instagramCaptionInput = row.querySelector('.js-social-instagram-caption-input');
      const instagramAltInput = row.querySelector('.js-social-instagram-alt-text-input');
      if (instagramCaptionInput) {
        instagramCaptionInput.value = postData.instagram_caption || '';
      }
      if (instagramAltInput) instagramAltInput.value = postData.instagram_alt_text || '';

      const facebookMessageInput = row.querySelector('.js-social-facebook-message-input');
      if (facebookMessageInput) facebookMessageInput.value = postData.facebook_message || '';

      const pinterestPostIdInput = row.querySelector(
        '.js-social-post-id-input[data-platform="pinterest"]');
      if (pinterestPostIdInput) {
        pinterestPostIdInput.value = postData.pinterest_post_id || '';
      }
      const instagramPostIdInput = row.querySelector(
        '.js-social-post-id-input[data-platform="instagram"]');
      if (instagramPostIdInput) {
        instagramPostIdInput.value = postData.instagram_post_id || '';
      }
      const facebookPostIdInput = row.querySelector(
        '.js-social-post-id-input[data-platform="facebook"]');
      if (facebookPostIdInput) {
        facebookPostIdInput.value = postData.facebook_post_id || '';
      }

      setPlatformLocked(
        row,
        'pinterest',
        Boolean(postData.pinterest_post_date || postData.pinterest_post_id),
      );
      setPlatformLocked(
        row,
        'instagram',
        Boolean(postData.instagram_post_date || postData.instagram_post_id),
      );
      setPlatformLocked(
        row,
        'facebook',
        Boolean(postData.facebook_post_date || postData.facebook_post_id),
      );
    }

    function createPostRow(postId, postData) {
      if (!socialPostsTable) {
        return null;
      }
      let tbody = socialPostsTable.querySelector('tbody');
      if (!tbody) {
        tbody = document.createElement('tbody');
        socialPostsTable.appendChild(tbody);
      }

      const row = document.createElement('tr');
      const fallbackId = postId || `new-${Date.now()}`;
      row.innerHTML = `
        <td><span class="muted">Just now</span></td>
        <td class="js-social-type"></td>
        <td>
          <div class="social-posts-link">
            <a class="js-social-link" target="_blank" rel="noopener" hidden></a>
            <span class="muted js-social-link-empty">No link</span>
          </div>
        </td>
        <td>
          <div class="social-platform" data-platform="pinterest">
            <div class="social-platform-field">
              <span class="social-platform-label">Title</span>
              <span class="social-platform-value social-posts-title js-social-pinterest-title is-empty"
                    data-empty-text="No title">No title</span>
            </div>
            <div class="social-platform-field">
              <span class="social-platform-label">Description</span>
              <span class="social-platform-value social-posts-description js-social-pinterest-description is-empty"
                    data-empty-text="No description">No description</span>
            </div>
            <div class="social-platform-field">
              <span class="social-platform-label">Alt text</span>
              <span class="social-platform-value js-social-pinterest-alt-text is-empty"
                    data-empty-text="No alt text">No alt text</span>
            </div>
            <div class="social-posts-actions">
              <button type="button" class="text-button js-social-edit" data-platform="pinterest">
                Edit text
              </button>
              <button type="button"
                      class="text-button js-social-regenerate"
                      data-platform="pinterest"
                      data-regenerate-image="false">
                Regenerate text
              </button>
              <button type="button"
                      class="text-button js-social-regenerate"
                      data-platform="pinterest"
                      data-regenerate-image="true">
                Regenerate image + text
              </button>
            </div>
            <div class="social-posts-edit" data-platform="pinterest" hidden>
              <label class="social-posts-edit-label" for="social-pinterest-title-${fallbackId}">
                Pinterest title
              </label>
              <input class="social-posts-edit-input js-social-pinterest-title-input"
                     id="social-pinterest-title-${fallbackId}"
                     type="text"
                     maxlength="100">
              <label class="social-posts-edit-label" for="social-pinterest-description-${fallbackId}">
                Pinterest description
              </label>
              <textarea class="social-posts-edit-textarea js-social-pinterest-description-input"
                        id="social-pinterest-description-${fallbackId}"
                        maxlength="500"></textarea>
              <label class="social-posts-edit-label" for="social-pinterest-alt-${fallbackId}">
                Pinterest alt text
              </label>
              <textarea class="social-posts-edit-textarea js-social-pinterest-alt-text-input"
                        id="social-pinterest-alt-${fallbackId}"
                        maxlength="500"></textarea>
              <div class="social-posts-edit-actions">
                <button type="button" class="text-button js-social-cancel" data-platform="pinterest">
                  Cancel
                </button>
                <button type="button" class="text-button js-social-save" data-platform="pinterest">
                  Save
                </button>
              </div>
            </div>
            <div class="social-posts-image js-social-platform-image" data-platform="pinterest">
              <span class="muted js-social-no-image">No image</span>
            </div>
            <div class="social-platform-meta">
              Posted:
              <span class="social-platform-value js-social-pinterest-post-date is-empty"
                    data-empty-text="Not posted">Not posted</span>
            </div>
            <div class="social-platform-meta">
              Post ID:
              <span class="social-platform-value js-social-pinterest-post-id is-empty"
                    data-empty-text="Not set">Not set</span>
            </div>
            <div class="social-platform-mark">
              <input class="social-posts-edit-input js-social-post-id-input"
                     data-platform="pinterest"
                     type="text"
                     placeholder="Pinterest post ID">
              <button type="button" class="text-button js-social-mark-posted" data-platform="pinterest">
                Mark Posted
              </button>
            </div>
          </div>
        </td>
        <td>
          <div class="social-platform" data-platform="instagram">
            <div class="social-platform-field">
              <span class="social-platform-label">Caption</span>
              <span class="social-platform-value js-social-instagram-caption is-empty"
                    data-empty-text="No caption">No caption</span>
            </div>
            <div class="social-platform-field">
              <span class="social-platform-label">Alt text</span>
              <span class="social-platform-value js-social-instagram-alt-text is-empty"
                    data-empty-text="No alt text">No alt text</span>
            </div>
            <div class="social-posts-actions">
              <button type="button" class="text-button js-social-edit" data-platform="instagram">
                Edit text
              </button>
            </div>
            <div class="social-posts-edit" data-platform="instagram" hidden>
              <label class="social-posts-edit-label" for="social-instagram-caption-${fallbackId}">
                Instagram caption
              </label>
              <textarea class="social-posts-edit-textarea js-social-instagram-caption-input"
                        id="social-instagram-caption-${fallbackId}"></textarea>
              <label class="social-posts-edit-label" for="social-instagram-alt-${fallbackId}">
                Instagram alt text
              </label>
              <textarea class="social-posts-edit-textarea js-social-instagram-alt-text-input"
                        id="social-instagram-alt-${fallbackId}"></textarea>
              <div class="social-posts-edit-actions">
                <button type="button" class="text-button js-social-cancel" data-platform="instagram">
                  Cancel
                </button>
                <button type="button" class="text-button js-social-save" data-platform="instagram">
                  Save
                </button>
              </div>
            </div>
            <div class="social-posts-image js-social-platform-image" data-platform="instagram">
              <span class="muted js-social-no-image">No image</span>
            </div>
            <div class="social-platform-meta">
              Posted:
              <span class="social-platform-value js-social-instagram-post-date is-empty"
                    data-empty-text="Not posted">Not posted</span>
            </div>
            <div class="social-platform-meta">
              Post ID:
              <span class="social-platform-value js-social-instagram-post-id is-empty"
                    data-empty-text="Not set">Not set</span>
            </div>
            <div class="social-platform-mark">
              <input class="social-posts-edit-input js-social-post-id-input"
                     data-platform="instagram"
                     type="text"
                     placeholder="Instagram post ID">
              <button type="button" class="text-button js-social-mark-posted" data-platform="instagram">
                Mark Posted
              </button>
            </div>
          </div>
        </td>
        <td>
          <div class="social-platform" data-platform="facebook">
            <div class="social-platform-field">
              <span class="social-platform-label">Message</span>
              <span class="social-platform-value js-social-facebook-message is-empty"
                    data-empty-text="No message">No message</span>
            </div>
            <div class="social-posts-actions">
              <button type="button" class="text-button js-social-edit" data-platform="facebook">
                Edit text
              </button>
            </div>
            <div class="social-posts-edit" data-platform="facebook" hidden>
              <label class="social-posts-edit-label" for="social-facebook-message-${fallbackId}">
                Facebook message
              </label>
              <textarea class="social-posts-edit-textarea js-social-facebook-message-input"
                        id="social-facebook-message-${fallbackId}"></textarea>
              <div class="social-posts-edit-actions">
                <button type="button" class="text-button js-social-cancel" data-platform="facebook">
                  Cancel
                </button>
                <button type="button" class="text-button js-social-save" data-platform="facebook">
                  Save
                </button>
              </div>
            </div>
            <div class="social-posts-image js-social-platform-image" data-platform="facebook">
              <span class="muted js-social-no-image">No image</span>
            </div>
            <div class="social-platform-meta">
              Posted:
              <span class="social-platform-value js-social-facebook-post-date is-empty"
                    data-empty-text="Not posted">Not posted</span>
            </div>
            <div class="social-platform-meta">
              Post ID:
              <span class="social-platform-value js-social-facebook-post-id is-empty"
                    data-empty-text="Not set">Not set</span>
            </div>
            <div class="social-platform-mark">
              <input class="social-posts-edit-input js-social-post-id-input"
                     data-platform="facebook"
                     type="text"
                     placeholder="Facebook post ID">
              <button type="button" class="text-button js-social-mark-posted" data-platform="facebook">
                Mark Posted
              </button>
            </div>
          </div>
        </td>
      `;

      tbody.insertBefore(row, tbody.firstChild);
      updatePostRow(row, postId, postData);
      updatePostsCount();
      return row;
    }

    function upsertPostRow(postId, postData) {
      if (!socialPostsTable || !postId) {
        return;
      }
      const selector = `tr[data-post-id="${escapeSelector(postId)}"]`;
      const existingRow = socialPostsTable.querySelector(selector);
      if (existingRow) {
        updatePostRow(existingRow, postId, postData);
        return;
      }
      createPostRow(postId, postData);
    }

    function clearSelection() {
      selectedJokes.length = 0;
      if (feedContainer) {
        feedContainer.querySelectorAll('.joke-card--selected').forEach((card) => {
          card.classList.remove('joke-card--selected');
          card.setAttribute('aria-selected', 'false');
        });
      }
      if (createPostBtn) {
        createPostBtn.disabled = true;
      }
      if (pinPreview) {
        pinPreview.style.display = 'none';
        pinPreview.innerHTML = '';
      }
      renderSelectionRow();
    }

    function setSelected(chip, isSelected) {
      chip.classList.toggle('filter-chip--selected', isSelected);
      chip.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
    }

    function navigateWithCategory(categoryId) {
      const url = new URL(window.location.href);
      url.pathname = '/admin/social';
      if (categoryId) {
        url.searchParams.set('category', categoryId);
      } else {
        url.searchParams.delete('category');
      }
      url.searchParams.delete('cursor');
      window.location.assign(url.toString());
    }

    if (feedContainer && createPostBtn) {
      feedContainer.addEventListener('click', (event) => {
        const mediaTarget = event.target.closest('.joke-slide-media, .joke-slide-placeholder');
        if (!mediaTarget) {
          return;
        }
        const card = event.target.closest('.joke-card[data-selectable="true"]');
        if (!card) {
          return;
        }
        const jokeId = card.dataset.jokeId;
        if (!jokeId) {
          return;
        }
        const existingIndex = selectedJokes.findIndex((item) => item.id === jokeId);
        if (existingIndex >= 0) {
          selectedJokes.splice(existingIndex, 1);
          card.classList.remove('joke-card--selected');
          card.setAttribute('aria-selected', 'false');
        } else {
          if (selectedJokes.length >= maxSelection) {
            alert('You can select up to 5 jokes.');
            return;
          }
          selectedJokes.push({
            id: jokeId,
            setupUrl: card.dataset.setupUrl || '',
          });
          card.classList.add('joke-card--selected');
          card.setAttribute('aria-selected', 'true');
        }

        createPostBtn.disabled = selectedJokes.length === 0;
        renderSelectionRow();
      });

      createPostBtn.addEventListener('click', async () => {
        if (selectedJokes.length === 0) {
          return;
        }

        await runWithButtonState(createPostBtn, 'Creating...', async () => {
          const data = await sendSocialRequest({
            joke_ids: selectedJokes.map((joke) => joke.id),
            type: postTypeSelect?.value || '',
          });
          const postData = data?.post_data || {};
          const postId = data?.post_id || '';
          const pinUrl = postData?.pinterest_image_url;

          if (!pinUrl) {
            throw new Error('Pinterest image URL missing from response');
          }

          pinPreview.style.display = 'block';
          let img = pinPreview.querySelector('img');
          if (!img) {
            img = document.createElement('img');
            img.alt = 'Pinterest pin image';
            img.loading = 'lazy';
            pinPreview.appendChild(img);
          }
          img.src = pinUrl;
          upsertPostRow(postId, postData);
          clearSelection();
        }).catch((error) => {
          console.error('Failed to create social post:', error);
          alert('Failed to create social post: ' + error.message);
        });

        createPostBtn.disabled = selectedJokes.length === 0;
      });

      createPostBtn.disabled = true;
      renderSelectionRow();
    }

    if (socialPostsTable) {
      socialPostsTable.addEventListener('click', async (event) => {
        const editButton = event.target.closest('.js-social-edit');
        const saveButton = event.target.closest('.js-social-save');
        const cancelButton = event.target.closest('.js-social-cancel');
        const regenButton = event.target.closest('.js-social-regenerate');
        const markPostedButton = event.target.closest('.js-social-mark-posted');
        const actionButton = editButton || saveButton || cancelButton || regenButton
          || markPostedButton;

        const row = actionButton ? actionButton.closest('tr[data-post-id]')
          : event.target.closest('tr[data-post-id]');
        if (!row || !row.dataset.postId) {
          return;
        }

        if (!actionButton) {
          return;
        }

        const platform = actionButton.dataset.platform || '';
        const editPanel = platform
          ? row.querySelector(`.social-posts-edit[data-platform="${platform}"]`)
          : null;

        if (editButton && editPanel) {
          editPanel.hidden = !editPanel.hidden;
          if (!editPanel.hidden) {
            if (platform === 'pinterest') {
              const titleInput = row.querySelector('.js-social-pinterest-title-input');
              const descriptionInput = row.querySelector(
                '.js-social-pinterest-description-input');
              const altInput = row.querySelector('.js-social-pinterest-alt-text-input');
              if (titleInput) titleInput.value = row.dataset.pinterestTitle || '';
              if (descriptionInput) {
                descriptionInput.value = row.dataset.pinterestDescription || '';
              }
              if (altInput) altInput.value = row.dataset.pinterestAltText || '';
            } else if (platform === 'instagram') {
              const captionInput = row.querySelector('.js-social-instagram-caption-input');
              const altInput = row.querySelector('.js-social-instagram-alt-text-input');
              if (captionInput) {
                captionInput.value = row.dataset.instagramCaption || '';
              }
              if (altInput) altInput.value = row.dataset.instagramAltText || '';
            } else if (platform === 'facebook') {
              const messageInput = row.querySelector('.js-social-facebook-message-input');
              if (messageInput) {
                messageInput.value = row.dataset.facebookMessage || '';
              }
            }
          }
          return;
        }

        if (cancelButton && editPanel) {
          editPanel.hidden = true;
          return;
        }

        if (saveButton) {
          await runWithButtonState(saveButton, 'Saving...', async () => {
            const payload = { post_id: row.dataset.postId };
            if (platform === 'pinterest') {
              const titleInput = row.querySelector('.js-social-pinterest-title-input');
              const descriptionInput = row.querySelector(
                '.js-social-pinterest-description-input');
              const altInput = row.querySelector('.js-social-pinterest-alt-text-input');
              payload.pinterest_title = titleInput ? titleInput.value : '';
              payload.pinterest_description = descriptionInput ? descriptionInput.value : '';
              payload.pinterest_alt_text = altInput ? altInput.value : '';
            } else if (platform === 'instagram') {
              const captionInput = row.querySelector('.js-social-instagram-caption-input');
              const altInput = row.querySelector('.js-social-instagram-alt-text-input');
              payload.instagram_caption = captionInput ? captionInput.value : '';
              payload.instagram_alt_text = altInput ? altInput.value : '';
            } else if (platform === 'facebook') {
              const messageInput = row.querySelector('.js-social-facebook-message-input');
              payload.facebook_message = messageInput ? messageInput.value : '';
            } else {
              return;
            }
            await sendSocialRequest({
              ...payload,
            }).then((data) => {
              const postData = data?.post_data || {};
              const postId = data?.post_id || row.dataset.postId;
              upsertPostRow(postId, postData);
              if (editPanel) {
                editPanel.hidden = true;
              }
            });
          }).catch((error) => {
            console.error('Failed to update social post:', error);
            alert('Failed to update social post: ' + error.message);
          });
          return;
        }

        if (regenButton) {
          const regenerateImage = regenButton.dataset.regenerateImage === 'true';
          await runWithButtonState(regenButton, 'Regenerating...', async () => {
            await sendSocialRequest({
              post_id: row.dataset.postId,
              regenerate_text: true,
              regenerate_image: regenerateImage,
            }).then((data) => {
              const postData = data?.post_data || {};
              const postId = data?.post_id || row.dataset.postId;
              upsertPostRow(postId, postData);
            });
          }).catch((error) => {
            console.error('Failed to regenerate social post:', error);
            alert('Failed to regenerate social post: ' + error.message);
          });
          return;
        }

        if (markPostedButton) {
          const postIdInput = row.querySelector(
            `.js-social-post-id-input[data-platform="${platform}"]`);
          const platformPostId = postIdInput ? postIdInput.value.trim() : '';
          if (!platformPostId) {
            alert('Please enter a post ID before marking as posted.');
            return;
          }
          await runWithButtonState(markPostedButton, 'Saving...', async () => {
            await sendSocialRequest({
              post_id: row.dataset.postId,
              mark_posted_platform: platform,
              platform_post_id: platformPostId,
            }).then((data) => {
              const postData = data?.post_data || {};
              const postId = data?.post_id || row.dataset.postId;
              upsertPostRow(postId, postData);
            });
          }).catch((error) => {
            console.error('Failed to mark post as posted:', error);
            alert('Failed to mark post as posted: ' + error.message);
          });
        }
      });
    }

    if (categoryChips.length) {
      categoryChips.forEach((chip) => {
        chip.addEventListener('click', () => {
          const categoryId = chip.getAttribute('data-category') || '';
          const isSelected = chip.classList.contains('filter-chip--selected');
          if (isSelected) {
            return;
          }
          clearSelection();
          categoryChips.forEach((c) => setSelected(c, c === chip));
          navigateWithCategory(categoryId || null);
        });
      });
    }
  })();
</script>
{% endblock %}
