{% macro joke_card(joke, reveal_label='Reveal Punchline', width=600, joke_id=None, feed_cursor=None, admin_mode=false) -%}
{% set unique_id = joke_id or joke.key|default('joke-unknown') %}
{% set state_value = joke.state.value if joke.state is not none else '' %}
{% set is_daily = state_value == 'DAILY' %}
{% set has_public_ts = joke.public_timestamp is not none %}
{% set is_future_daily = (joke.is_future_daily if joke.is_future_daily is defined else (is_daily and has_public_ts and now_utc is defined and joke.public_timestamp > now_utc)) %}
{% set badge_state_class = 'future-daily' if is_future_daily else state_value|lower %}
<article class="joke-card" aria-label="Joke {{ unique_id }}"
  style="--joke-card-max-width: {{ width }}px;"
  data-joke-id="{{ unique_id }}"
  {% if feed_cursor %}data-feed-cursor="{{ feed_cursor }}"{% endif %}>
  <div class="joke-viewer" data-joke-viewer>
    {% if admin_mode and state_value %}
      <div class="joke-state-badge joke-state-{{ badge_state_class }}">
        {% if is_daily and has_public_ts %}
          {{ joke.public_timestamp.strftime('%Y-%m-%d') }}
        {% else %}
          {{ state_value|lower|capitalize }}
        {% endif %}
      </div>
    {% endif %}
    <div class="joke-carousel">
      <div class="joke-carousel-viewport">
        <div class="joke-carousel-track">
          <div class="joke-slide" aria-hidden="false">
            <div class="joke-slide-media">
              {% if joke.setup_image_url %}
              <img src="{{ joke.setup_image_url | format_image_url(width=width) }}" alt="{{ joke.setup_text }}"
                width="{{ width }}" height="{{ width }}" loading="lazy">
              {% else %}
              <div class="joke-slide-placeholder text-button">Illustration bakingâ€¦</div>
              {% endif %}
            </div>
          </div>
          <div class="joke-slide" id="joke-{{ unique_id }}-punchline" aria-hidden="true">
            <div class="joke-slide-media">
              {% if joke.punchline_image_url %}
              <img src="{{ joke.punchline_image_url | format_image_url(width=width) }}"
                alt="{{ joke.punchline_text }}" width="{{ width }}" height="{{ width }}" loading="lazy">
              {% else %}
              <div class="joke-slide-placeholder text-button">Punchline ready to read!</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
    {% if admin_mode %}
      {% set viewed = joke.num_viewed_users|default(0) %}
      {% set saved = joke.num_saved_users|default(0) %}
      {% set shared = joke.num_shared_users|default(0) %}
      <div class="joke-admin-footer">
        <div class="joke-admin-stats" aria-label="Joke stats">
          <div class="joke-admin-stat joke-admin-stat--views{% if viewed == 0 %} is-muted{% endif %}">
            <span class="joke-admin-stat-icon" aria-hidden="true">ğŸ‘</span>
            <span class="joke-admin-stat-value">{{ viewed }}</span>
          </div>
          <div class="joke-admin-stat joke-admin-stat--saves{% if saved == 0 %} is-muted{% endif %}">
            <span class="joke-admin-stat-icon" aria-hidden="true">â¤</span>
            <span class="joke-admin-stat-value">{{ saved }}</span>
          </div>
          <div class="joke-admin-stat joke-admin-stat--shares{% if shared == 0 %} is-muted{% endif %}">
            <span class="joke-admin-stat-icon" aria-hidden="true">â†—</span>
            <span class="joke-admin-stat-value">{{ shared }}</span>
          </div>
        </div>
        <button type="button" class="button-secondary text-button joke-edit-button"
          data-joke-id="{{ unique_id }}"
          data-joke-data='{{ (joke.edit_payload if joke.edit_payload is defined else {}) | tojson }}'
          aria-label="Edit joke"
          title="Edit">
          <span aria-hidden="true">&#9998;</span>
        </button>
      </div>
    {% endif %}
    <button class="button-primary joke-reveal text-button" type="button" data-role="reveal" data-label-show="{{ reveal_label }}"
      data-label-hide="Back to Setup" aria-controls="joke-{{ unique_id }}-punchline" aria-expanded="false"
      data-analytics-event="web_joke_reveal_click" data-analytics-label="{{ joke.key|default('unknown')|e }}">
      {{ reveal_label }}
    </button>
  </div>
</article>
{%- endmacro %}
