{% macro joke_card(joke, reveal_label='Reveal Punchline', width=600, joke_id=None, feed_cursor=None, admin_state_badge_enabled=false, admin_stats_enabled=false, admin_edit_enabled=false, is_future_daily=None, edit_payload=None, selectable=false) -%}
{% macro multiline_title_attr(text) -%}
{%- set newline = '&#10;' | safe -%}
{{- text | e | replace('\n', newline) -}}
{%- endmacro %}
{% set unique_id = joke_id or joke.key|default('joke-unknown') %}
{% set state_value = joke.state.value if joke.state is not none else '' %}
{% set is_daily = state_value == 'DAILY' %}
{% set has_public_ts = joke.public_timestamp is not none %}
{% if is_future_daily is defined and is_future_daily is not none %}
{% set is_future_daily_value = is_future_daily %}
{% elif joke.is_future_daily is defined %}
{% set is_future_daily_value = joke.is_future_daily %}
{% else %}
{% set is_future_daily_value = (is_daily and has_public_ts and now_utc is defined and joke.public_timestamp > now_utc) %}
{% endif %}
{% if edit_payload is defined and edit_payload is not none %}
{% set edit_payload_value = edit_payload %}
{% elif joke.edit_payload is defined %}
{% set edit_payload_value = joke.edit_payload %}
{% else %}
{% set edit_payload_value = {} %}
{% endif %}
{% set badge_state_class = 'future-daily' if is_future_daily_value else state_value|lower %}
{% set selectable_value = selectable|default(false) %}
<article class="joke-card{% if selectable_value %} joke-card--selectable{% endif %}" aria-label="Joke {{ unique_id }}"
  style="--joke-card-max-width: {{ width }}px;"
  data-joke-id="{{ unique_id }}"
  {% if selectable_value and joke.setup_image_url %}data-setup-url="{{ joke.setup_image_url | format_image_url(width=width) }}"{% endif %}
  {% if selectable_value %}data-selectable="true" aria-selected="false"{% endif %}
  {% if feed_cursor %}data-feed-cursor="{{ feed_cursor }}"{% endif %}>
  <div class="joke-viewer" data-joke-viewer>
    {% if admin_state_badge_enabled and state_value %}
      <div class="joke-state-badge joke-state-{{ badge_state_class }}">
        {% if is_daily and has_public_ts %}
          {{ joke.public_timestamp.strftime('%Y-%m-%d') }}
        {% else %}
          {{ state_value|lower|capitalize }}
        {% endif %}
      </div>
    {% endif %}
    <div class="joke-carousel">
      <div class="joke-carousel-viewport">
        <div class="joke-carousel-track">
          <div class="joke-slide" aria-hidden="false">
            <div class="joke-slide-media">
              {% if joke.setup_image_url %}
              <img src="{{ joke.setup_image_url | format_image_url(width=width) }}" alt="{{ joke.setup_text }}"
                width="{{ width }}" height="{{ width }}" loading="lazy">
              {% else %}
              <div class="joke-slide-placeholder text-button">Illustration bakingâ€¦</div>
              {% endif %}
            </div>
            {% if joke.setup_text %}
            <div class="text-body">{{ joke.setup_text | e }}</div>
            {% endif %}
          </div>
          <div class="joke-slide" id="joke-{{ unique_id }}-punchline" aria-hidden="true">
            <div class="joke-slide-media">
              {% if joke.punchline_image_url %}
              <img src="{{ joke.punchline_image_url | format_image_url(width=width) }}"
                alt="{{ joke.punchline_text }}" width="{{ width }}" height="{{ width }}" loading="lazy">
              {% else %}
              <div class="joke-slide-placeholder text-button">Punchline ready to read!</div>
              {% endif %}
            </div>
            {% if joke.punchline_text %}
            <div class="text-body">{{ joke.punchline_text | e }}</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% if admin_stats_enabled or admin_edit_enabled %}
      {% set viewed = joke.num_viewed_users|default(0) %}
      {% set saved = joke.num_saved_users|default(0) %}
      {% set shared = joke.num_shared_users|default(0) %}
      <div class="joke-admin-footer">
        {% if admin_stats_enabled %}
        <div class="joke-admin-stats" aria-label="Joke stats"
          title="{{ multiline_title_attr(joke.generation_metadata | format_generation_metadata_tooltip) | safe }}">
          <div class="joke-admin-stat joke-admin-stat--views{% if viewed == 0 %} is-muted{% endif %}">
            <span class="joke-admin-stat-icon" aria-hidden="true">ğŸ‘</span>
            <span class="joke-admin-stat-value">{{ viewed }}</span>
          </div>
          <div class="joke-admin-stat joke-admin-stat--saves{% if saved == 0 %} is-muted{% endif %}">
            <span class="joke-admin-stat-icon" aria-hidden="true">â¤</span>
            <span class="joke-admin-stat-value">{{ saved }}</span>
          </div>
          <div class="joke-admin-stat joke-admin-stat--shares{% if shared == 0 %} is-muted{% endif %}">
            <span class="joke-admin-stat-icon" aria-hidden="true">â†—</span>
            <span class="joke-admin-stat-value">{{ shared }}</span>
          </div>
        </div>
        {% endif %}
        {% if admin_edit_enabled %}
        <button type="button" class="button-secondary text-button joke-admin-button joke-regenerate-button"
          data-joke-id="{{ unique_id }}"
          aria-label="Regenerate images"
          title="Regenerate Images">
          <span aria-hidden="true">&#x1f504;</span>
        </button>
        <button type="button" class="button-secondary text-button joke-admin-button joke-edit-button"
          data-joke-id="{{ unique_id }}"
          data-joke-data='{{ edit_payload_value | tojson }}'
          aria-label="Edit joke"
          title="Edit">
          <span aria-hidden="true">&#9998;</span>
        </button>
        {% endif %}
      </div>
    {% endif %}
    <button class="button-primary joke-reveal text-button" type="button" data-role="reveal" data-label-show="{{ reveal_label }}"
      data-label-hide="Back to Setup" aria-controls="joke-{{ unique_id }}-punchline" aria-expanded="false"
      data-meta-event="ViewContent"
      data-analytics-event="web_joke_reveal_click"
      data-analytics-label="joke_card_reveal"
      data-analytics-params='{{ {"joke_id": joke.key|default("unknown")} | tojson }}'>
      {{ reveal_label }}
    </button>
  </div>
</article>
{%- endmacro %}
