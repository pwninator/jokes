{% macro notes_signin_card(hook_text, continue_url, category_label=None, category_count=0, promo_cards=[], promo_width=350, promo_quality=50) -%}
{% set display_cards = promo_cards|reverse|list %}
{% set has_fan = display_cards|length > 0 %}
{% set count = display_cards|length %}
{% set center_index = (count - 1) / 2 %}
{% set cdn_width = promo_width %}
{% set cdn_quality = promo_quality %}
<style>
  .signin-form-card--split {
    max-width: 960px;
  }
  .signin-form-content {
    display: grid;
    grid-template-columns: 1fr;
    gap: 24px;
    align-items: center;
  }
  
  /* Fan Stack Container */
  .fan-stack {
    display: grid;
    place-items: center;
    position: relative;
    container-type: size;
    width: 100%;
    isolation: isolate;
  }
  
  /* Fan Images */
  .fan-stack img {
    grid-area: 1 / 1;
    display: block;
    
    /* Reset dimensions to auto to preserve aspect ratio */
    width: auto;
    height: auto;
    min-width: 0;
    min-height: 0;
    
    /* Dynamic Sizing with Safety Margins for Large Stacks (up to 20):
       - Single card: 92%
       - Reduction per card: 3% (was 8%) to support larger counts
       - Min size: 30%
    */
    --safe-limit: clamp(30%, 92% - (var(--count) - 1) * 3%, 92%);
    max-width: var(--safe-limit);
    max-height: var(--safe-limit);
    
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    background: #fff;
    
    /* Dynamic Fanning Calculation */
    --offset: calc(var(--i) - var(--center));
    --abs-offset: max(var(--offset), -1 * var(--offset));
    --norm-offset: calc(var(--offset) / max(1, var(--center)));
    
    /* Spread range */
    --tx-range: calc(50cqw - 50%);
    --ty-range: calc(50cqh - 50%);
    
    /* Default: Fan Horizontally (Landscape) - Arched Downwards
       - Rotation scales with count: 15deg (low count) -> 35deg (high count)
       - Arch centered vertically by subtracting half the max drop
    */
    --max-rot: clamp(15deg, 15deg + (var(--count) - 3) * 2.5deg, 35deg);
    --y-drop: 8%;
    --y-shift: calc(var(--center) * var(--y-drop) * -0.5);

    transform: 
      translateX(calc(var(--norm-offset) * var(--tx-range))) 
      translateY(calc(var(--abs-offset) * var(--y-drop) + var(--y-shift))) 
      rotate(calc(var(--norm-offset) * var(--max-rot)));
      
    transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
  }

  /* Vertical Fan for Portrait Containers - Diagonal */
  @container (orientation: portrait) {
    .fan-stack img {
      transform: 
        translateX(calc(var(--offset) * 4%)) 
        translateY(calc(var(--norm-offset) * var(--ty-range)))
        rotate(calc(var(--norm-offset) * var(--max-rot) * 0.6)); /* Less rotation for vertical fan */
    }
  }

  /* Mobile: Explicit height to define container aspect ratio */
  .fan-stack--mobile {
    height: 180px;
    margin: 8px auto 24px;
  }

  /* Desktop: Fill grid cell height */
  .fan-stack--desktop {
    display: none;
    height: 100%;
    min-height: 300px; /* Ensure strictly defined height for container query */
  }

  @media (min-width: 720px) {
    .signin-form-card--split .signin-form-content {
      grid-template-columns: 1.2fr 1fr;
    }
    .signin-form-card--split .fan-stack--desktop {
      display: grid;
    }
    .signin-form-card--split .fan-stack--mobile {
      display: none;
    }
    .signin-form-card--split .signin-form {
      margin: 0;
      text-align: center;
    }
    .signin-form-card--split .signin-form-title,
    .signin-form-card--split .signin-form-text {
      text-align: center;
    }
  }
</style>

<section class="section-center" aria-labelledby="notes-signin-form-title" data-notes-signin-section>
  <header class="section-header" data-notes-signin-lead-header>
    <h2 class="text-section-heading" id="notes-signin-lead-title">{{ hook_text }}</h2>
  </header>
  <div class="signin-form-card {% if has_fan %}signin-form-card--split{% endif %}" data-notes-signin-form-card>
    <div class="signin-form-content">
      <form class="signin-form" method="post" action="{{ url_for('web.lunchbox') }}"
        data-notes-signin-auth-form>
        {% if category_label %}
        <h2 class="text-section-heading signin-form-title" id="notes-signin-form-title">
          Complete Your {{ category_label }} Collection!
        </h2>
        <p class="text-body signin-form-text">
          Access {{ category_count }} more {{ category_label }} sheets and {{ total_sheet_count }}+ more themed sheets totally free! Enter your email below and we'll send a magic access link straight to your inbox.
        </p>
        {% else %}
        <h2 class="text-section-heading signin-form-title" id="notes-signin-form-title">Unlock the Full
          Snickerdoodle
          Collection
        </h2>
        <p class="text-body signin-form-text">Access {{ total_sheet_count }}+ themed sheets totally free! Enter your email
          below and we'll send a
          magic access link straight to your inbox.</p>
        {% endif %}

        {% if has_fan %}
        <div class="fan-stack fan-stack--mobile" style="--count: {{ count }}; --center: {{ center_index }}">
          {% for card in display_cards %}
            <img 
              src="{{ format_image_url(card.image_url, width=cdn_width, quality=cdn_quality) }}" 
              alt="" 
              loading="lazy"
              style="--i: {{ loop.index0 }}; z-index: {{ loop.index }};"
            />
          {% endfor %}
        </div>
        {% endif %}

        <div class="signin-form-field">
          <label class="sr-only" for="notes-signin-email">Email address</label>
          <input class="signin-form-input" id="notes-signin-email" name="email" type="email" autocomplete="email"
            placeholder="Your email" required value="{{ email_value or '' }}" aria-label="Your email"
            aria-describedby="notes-signin-privacy" />
        </div>

        <button class="nav-cta text-button signin-form-submit" id="notes-signin-submit" type="submit"
          data-analytics-event="web_lunchbox_submit_click" data-analytics-label="lunchbox">
          Send Me My Access Link!
        </button>

        <div id="notes-signin-error" class="form-error" role="alert"></div>
        <p id="notes-signin-status" class="text-body signin-form-text" role="status" aria-live="polite"
          style="display:none"></p>

        {% if error_message %}
        <p class="text-body signin-form-text" role="alert">{{ error_message }}</p>
        {% endif %}

        <p class="text-footer signin-form-text" id="notes-signin-privacy">You'll receive occasional free printables, book
          updates, and other Snickerdoodle news.<br>No spam, just wholesome fun. Unsubscribe at any time.</p>
      </form>

      {% if has_fan %}
      <div class="fan-stack fan-stack--desktop" style="--count: {{ count }}; --center: {{ center_index }}">
        {% for card in display_cards %}
          <img 
            src="{{ format_image_url(card.image_url, width=cdn_width, quality=cdn_quality) }}" 
            alt="Preview of {{ card.title }}" 
            loading="lazy"
            style="--i: {{ loop.index0 }}; z-index: {{ loop.index }};"
          />
        {% endfor %}
      </div>
      {% endif %}
    </div>
  </div>
  <section class="notes-signin-success-card" aria-label="Success" data-notes-signin-success-banner
    style="display: none;">
    <div class="thankyou-banner__inner">
      <img class="thankyou-banner__icon"
        src="https://images.quillsstorybook.com/cdn-cgi/image/width=100,format=auto,quality=75/_joke_assets/green_checkmark.png"
        alt="Success" width="100" height="87" loading="lazy" />
      <p class="thankyou-banner__text text-section-heading">
        <strong>High Five!</strong> Your Lunchbox Notes are on their way to your inbox.<br>
        <span class="muted">(Check your spam folder!)</span><br>
        <span class="text-footer">Wrong email? <a class="notes-signin-success-link" href="#"
            data-notes-signin-retry>Try again</a></span>
      </p>
    </div>
  </section>
</section>

<script type="module">
  const firebaseConfig = {{ firebase_config | tojson }};
  const emailLinkUrl = {{ continue_url | tojson }};
  const notesAllUrl = {{ url_for('web.notes_all') | tojson }};
  const form = document.querySelector('[data-notes-signin-auth-form]');
  const formCard = document.querySelector('[data-notes-signin-form-card]');
  const successBanner = document.querySelector('[data-notes-signin-success-banner]');
  const leadHeader = document.querySelector('[data-notes-signin-lead-header]');
  const emailInput = document.getElementById('notes-signin-email');
  const submitButton = document.getElementById('notes-signin-submit');
  const errorEl = document.getElementById('notes-signin-error');
  const statusEl = document.getElementById('notes-signin-status');
  const retryLink = document.querySelector('[data-notes-signin-retry]');
  const storageKey = 'snickerdoodle_notes_email';
  const submitLabel = submitButton ? submitButton.textContent : '';
  let firebasePromise = null;

  function showError(message) {
    if (statusEl) {
      statusEl.style.display = 'none';
    }
    if (errorEl) {
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }
  }

  function showStatus(message) {
    if (errorEl) {
      errorEl.style.display = 'none';
    }
    if (statusEl) {
      statusEl.textContent = message;
      statusEl.style.display = 'block';
    }
  }

  function friendlyAuthMessage(error, fallback) {
    if (!error) {
      return fallback;
    }
    const code = error.code || '';
    switch (code) {
      case 'auth/invalid-email':
      case 'auth/missing-email':
        return 'Please enter a valid email address.';
      case 'auth/too-many-requests':
        return 'Too many attempts. Please wait a moment and try again.';
      case 'auth/network-request-failed':
        return 'Network error. Please check your connection and try again.';
      case 'auth/user-disabled':
        return 'This account has been disabled. Please contact support.';
      default:
        return fallback;
    }
  }

  function clearMessages() {
    if (errorEl) {
      errorEl.style.display = 'none';
    }
    if (statusEl) {
      statusEl.style.display = 'none';
    }
  }

  function setLoading(isLoading) {
    if (!submitButton) {
      return;
    }
    submitButton.disabled = isLoading;
    submitButton.textContent = isLoading ? 'Sending...' : submitLabel;
  }

  function showSuccessBanner() {
    if (leadHeader) {
      leadHeader.style.display = 'none';
    }
    if (formCard) {
      formCard.style.display = 'none';
    }
    if (successBanner) {
      successBanner.style.display = 'block';
    }
  }

  function showFormCard() {
    if (successBanner) {
      successBanner.style.display = 'none';
    }
    if (formCard) {
      formCard.style.display = '';
    }
    if (leadHeader) {
      leadHeader.style.display = '';
    }
    clearMessages();
    if (emailInput) {
      emailInput.focus();
    }
  }

  async function loadFirebase() {
    if (!firebaseConfig || !firebaseConfig.apiKey) {
      throw new Error('Firebase is not configured.');
    }
    if (!firebasePromise) {
      firebasePromise = (async () => {
        const appModule = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js');
        const authModule = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');

        const initializedApp = appModule.getApps().length
          ? appModule.getApp()
          : appModule.initializeApp(firebaseConfig);
        const auth = authModule.getAuth(initializedApp);
        auth.languageCode = 'en';
        return { authModule, auth };
      })();
    }
    return firebasePromise;
  }

  async function sendAccessLink(email) {
    const { authModule, auth } = await loadFirebase();
    const actionCodeSettings = {
      url: emailLinkUrl,
      handleCodeInApp: true,
    };
    try {
      window.localStorage.setItem(storageKey, email);
    } catch (err) {
      // localStorage may be disabled; continue without it.
    }
    await authModule.sendSignInLinkToEmail(auth, email, actionCodeSettings);
  }

  async function completeSignInFromLink() {
    const { authModule, auth } = await loadFirebase();
    const currentUrl = window.location.href;
    if (!authModule.isSignInWithEmailLink(auth, currentUrl)) {
      return;
    }

    let email = null;
    try {
      email = window.localStorage.getItem(storageKey);
    } catch (err) {
      email = null;
    }
    if (!email) {
      email = window.prompt('Please confirm your email to finish signing in.');
    }
    if (!email) {
      showError('Please enter your email to finish signing in.');
      return;
    }

    try {
      const result = await authModule.signInWithEmailLink(auth, email, currentUrl);
      try {
        window.localStorage.removeItem(storageKey);
      } catch (err) {
        // Ignore storage cleanup errors.
      }
      const idToken = await result.user.getIdToken(true);
      const response = await fetch('/session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ idToken }),
      });
      if (!response.ok) {
        throw new Error('Unable to finish signing in. Please request a new link.');
      }

      try {
        await authModule.signOut(auth);
      } catch (signOutErr) {
        console.warn('Failed to sign out Firebase Auth session', signOutErr); // eslint-disable-line no-console
      }

      showStatus('Access unlocked! You can download all joke packs below.');
      const cleanUrl = window.location.origin + window.location.pathname + window.location.hash;
      window.history.replaceState({}, document.title, cleanUrl);
      if (notesAllUrl) {
        window.location.assign(notesAllUrl);
      }
    } catch (err) {
      console.error('Email link sign-in failed', err); // eslint-disable-line no-console
      showError(friendlyAuthMessage(
        err,
        'Unable to sign you in. Please request a new access link.',
      ));
    }
  }

  if (form) {
    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      clearMessages();

      if (!emailInput) {
        showError('Email input missing. Please refresh and try again.');
        return;
      }

      if (!emailInput.checkValidity()) {
        emailInput.reportValidity();
        showError('Please enter a valid email address.');
        return;
      }

      const email = emailInput.value.trim().toLowerCase();
      if (!email) {
        showError('Please enter a valid email address.');
        return;
      }

      setLoading(true);
      try {
        await sendAccessLink(email);
        showSuccessBanner();
      } catch (err) {
        console.error('Failed to send access link', err); // eslint-disable-line no-console
        showError(friendlyAuthMessage(
          err,
          'Unable to send link. Please try again.',
        ));
      } finally {
        setLoading(false);
      }
    });
  }

  if (retryLink) {
    retryLink.addEventListener('click', (event) => {
      event.preventDefault();
      showFormCard();
    });
  }

  completeSignInFromLink().catch((err) => {
    console.error('Failed to initialize email link sign-in', err); // eslint-disable-line no-console
  });
</script>
{%- endmacro %}