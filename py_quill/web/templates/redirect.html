{% extends "base.html" %}

{% block page_title %}{{ page_title }}{% endblock %}

{% block head_extra %}
<meta name="robots" content="noindex,nofollow">
{% endblock %}

{% block content %}
<section class="card" style="max-width: 640px; margin: 0 auto;">
  <h1 style="margin-top: 0;">{{ heading }}</h1>
  {% if message %}
  <p class="muted">{{ message }}</p>
  {% endif %}

  <p>
    <a class="text-button"
       href="{{ target_url }}"
       rel="noopener noreferrer"
       data-analytics-event="{{ click_event_name }}"
       data-analytics-params="{{ event_params | tojson }}"
    >
      {{ link_text }}
    </a>
  </p>

  <p class="muted" style="margin-bottom: 0;">
    If you aren't redirected automatically, use the link above.
  </p>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
  (function () {
    var targetUrl = {{ target_url | tojson }};
    var maxWaitMs = {{ delay_ms | default(1000) }};
    var ga4EventName = {{ event_name | tojson }};
    var eventParams = {{ event_params | tojson }};
    var metaPixelEventName = {{ meta_pixel_event_name | tojson }};

    var hasNavigated = false;
    function navigate() {
      if (hasNavigated) {
        return;
      }
      hasNavigated = true;
      window.location.replace(targetUrl);
    }

    // Count how many trackers need to complete
    var totalTrackers = 0;
    var completedTrackers = 0;
    
    if (ga4EventName && typeof window.gtag === 'function') {
      totalTrackers++;
    }
    if (metaPixelEventName && typeof window.fbq === 'function') {
      totalTrackers++;
    }

    // If no trackers, redirect immediately
    if (totalTrackers === 0) {
      window.setTimeout(navigate, maxWaitMs);
      return;
    }

    function onTrackerComplete() {
      completedTrackers++;
      if (completedTrackers >= totalTrackers) {
        navigate();
      }
    }

    // Fire Meta Pixel event
    try {
      if (metaPixelEventName && typeof window.fbq === 'function') {
        window.fbq('track', metaPixelEventName, {}, {
          eventID: 'redirect_' + Date.now(),
        });
        // Meta Pixel doesn't have a reliable callback, so mark complete immediately
        // The event will still be sent via beacon/keepalive
        onTrackerComplete();
      }
    } catch (e) {
      // Best-effort only; mark as complete to not block redirect.
      onTrackerComplete();
    }

    // Fire GA4 event
    try {
      if (ga4EventName && typeof window.gtag === 'function') {
        var params = eventParams || {};
        params.transport_type = 'beacon';
        params.event_callback = onTrackerComplete;
        params.event_timeout = maxWaitMs;
        window.gtag('event', ga4EventName, params);
      }
    } catch (e) {
      // Best-effort only; mark as complete to not block redirect.
      onTrackerComplete();
    }

    // Failsafe: redirect after timeout regardless
    window.setTimeout(navigate, maxWaitMs);
  })();
</script>
{% endblock %}


